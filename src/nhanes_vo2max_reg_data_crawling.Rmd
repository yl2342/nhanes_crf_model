

## Package loading
```{r}


## tidyverse
if(!require(tidyverse)){
    install.packages("tidyverse")
    library(tidyverse)
} else {
  library(tidyverse)
}

## haven
if(!require(haven)){
    install.packages("haven")
    library(haven)
} else {
  library(haven)
}


## dplyr
if(!require(dplyr)){
    install.packages("dplyr")
    library(dplyr)
} else {
  library(dplyr)
}


## NANIAR
if(!require(naniar)){
    install.packages("naniar")
    library(naniar)
} else {
  library(naniar)
}


## set working directory
wd_path <- "../data/raw/"
knitr::opts_knit$set(root.dir = wd_path)

```



## Drug data for all cycles (1999-2018)  
```{r}

## drug infos 
rxq_druginfo <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/RXQ_DRUG.xpt"))


## case_when() function was frequently used to prevent unwanted NAs
drug_filtered <- rxq_druginfo %>%
  mutate(aspirin = case_when(grepl('aspirin', tolower(RXDDRUG)) ~ T, 
                             TRUE ~ FALSE))%>%
  mutate(statin_by_name = grepl('statin', tolower(RXDDRUG)))%>%
  mutate(statin_by_class = ifelse(RXDDCI1C ==  42, T,F))%>%
  mutate(statin = case_when(statin_by_name|statin_by_class ~T,
                            TRUE ~ FALSE))%>%
  mutate(anti_platelet = case_when(RXDDCI1C ==  211 ~T,
                                   TRUE ~ FALSE))%>%
  mutate(anti_htn = case_when((RXDDCI1B %in% c(41, 42,43,44,47,48,49,52,53,55,303,340,342,482) |
                                 RXDDCI2B %in% c(41, 42,43,44,47,48,49,52,53,55,303,340,342,482) |
                                 RXDDCI3B %in% c(41, 42,43,44,47,48,49,52,53,55,303,340,342,482) | 
                                 RXDDCI4B %in% c(41, 42,43,44,47,48,49,52,53,55,303,340,342,482) |
                                 RXDICI1B %in% c(41, 42,43,44,47,48,49,52,53,55,303,340,342,482) | 
                                 RXDICI2B %in% c(41, 42,43,44,47,48,49,52,53,55,303,340,342,482) |
                                 RXDICI3B %in% c(41, 42,43,44,47,48,49,52,53,55,303,340,342,482) | 
                                 RXDICI4B %in% c(41, 42,43,44,47,48,49,52,53,55,303,340,342,482) |
                                 RXDICI5B %in% c(41, 42,43,44,47,48,49,52,53,55,303,340,342,482) | 
                                 RXDICI6B %in% c(41, 42,43,44,47,48,49,52,53,55,303,340,342,482)) ~  TRUE,
                                                     TRUE ~ FALSE))%>%
  mutate(anti_hyperlipid = case_when((RXDDCI1B %in% c(19) |
                                 RXDDCI2B %in% c(19) |
                                 RXDDCI3B %in% c(19) | 
                                 RXDDCI4B %in% c(19) |
                                 RXDICI1B %in% c(19) | 
                                 RXDICI2B %in% c(19) |
                                 RXDICI3B %in% c(19) | 
                                 RXDICI4B %in% c(19) |
                                 RXDICI5B %in% c(19) | 
                                 RXDICI6B %in% c(19)) ~  TRUE,
                                                     TRUE ~ FALSE))%>%
   mutate(anti_diabetes = case_when((RXDDCI1B %in% c(99) |
                                 RXDDCI2B %in% c(99) |
                                 RXDDCI3B %in% c(99) | 
                                 RXDDCI4B %in% c(99) |
                                 RXDICI1B %in% c(99) | 
                                 RXDICI2B %in% c(99) |
                                 RXDICI3B %in% c(99) | 
                                 RXDICI4B %in% c(99) |
                                 RXDICI5B %in% c(99) | 
                                 RXDICI6B %in% c(99)) ~  TRUE,
                                                     TRUE ~ FALSE))%>%
  ## blow are single ingredient
  mutate(acei_s = case_when( (RXDDCI1B == 42 | RXDDCI2B == 42 | RXDDCI3B == 42 | RXDDCI4B == 42 |
                                     RXDICI1B == 42 | RXDICI2B == 42 | RXDICI3B == 42 | RXDICI4B == 42 | 
                                       RXDICI5B == 42 | RXDICI6B == 42) ~  TRUE,
                                     TRUE ~ FALSE)) %>%
  mutate(betablocker_s = case_when( (RXDDCI1B == 47 | RXDDCI2B == 47 | RXDDCI3B == 47 | RXDDCI4B == 47 |
                                    RXDICI1B == 47 | RXDICI2B == 47 | RXDICI3B == 47 | RXDICI4B == 47 |
                                      RXDICI5B == 47 | RXDICI6B == 47) ~  TRUE,
                                    TRUE ~ FALSE)) %>%
  mutate(arb_s = case_when((RXDDCI1B %in% c(56, 482) | RXDDCI2B %in% c(56, 482) |
                                                        RXDDCI3B %in% c(56, 482) | RXDDCI4B %in% c(56, 482) |
                                                        RXDICI1B %in% c(56, 482) | RXDICI2B %in% c(56, 482) | 
                                                        RXDICI3B %in% c(56, 482) | RXDICI4B %in% c(56, 482) | 
                                                        RXDICI5B %in% c(56, 482) | RXDICI6B %in% c(56, 482)) ~  TRUE,
                                                     TRUE ~ FALSE))%>% 
  ## below are in combination form
  mutate(acei_c = case_when((RXDDCI1C %in% c(467, 476) | RXDDCI2C %in% c(467, 476) | RXDDCI3C %in% c(467, 476) | RXDDCI4C %in% c(467, 476) |
                                         RXDICI1C %in% c(467, 476) | RXDICI2C %in% c(467, 476) | RXDICI3C %in% c(467, 476) | RXDICI4C %in% c(467, 476) | RXDICI5C %in% c(467, 476) | RXDICI6C %in% c(467, 476)) ~  TRUE,
                                  TRUE ~ FALSE))%>%
  mutate(arb_c = case_when((RXDDCI1C %in% c(473, 479) | RXDDCI2C %in% c(473, 479) | RXDDCI3C %in% c(473, 479) | RXDDCI4C %in% c(473, 479) |
                                                          RXDICI1C %in% c(473, 479) | RXDICI2C %in% c(473, 479) | RXDICI3C %in% c(473, 479) | RXDICI4C %in% c(473, 479) |
                                                          RXDICI5C %in% c(473, 479) | RXDICI6C %in% c(473, 479)) ~  TRUE,
                                  TRUE ~ FALSE))%>%
  mutate(betablocker_c = case_when((RXDDCI1C %in% c(472) | RXDDCI2C %in% c(472) | RXDDCI3C %in% c(472) | RXDDCI4C %in% c(472) |
                                        RXDICI1C %in% c(472) | RXDICI2C %in% c(472) | RXDICI3C %in% c(472) | RXDICI4C %in% c(472) | RXDICI5C %in% c(472) | RXDICI6C %in% c(472)) ~  TRUE,
                                  TRUE ~ FALSE))
  




sp_drug <- drug_filtered %>% dplyr::select(c('RXDDRGID','RXDDRUG','aspirin','statin',
                                'anti_platelet','anti_htn','anti_hyperlipid','anti_diabetes',
                                'acei_s','acei_c','arb_s','arb_c','betablocker_s','betablocker_c')) %>% 
  mutate(is.needed = rowSums(subset(., select=c('aspirin','statin',
                                'anti_platelet','anti_htn','anti_hyperlipid','anti_diabetes',
                                'acei_s','acei_c','arb_s','arb_c','betablocker_s','betablocker_c'))))%>%
  filter(is.needed > 0)%>%
  ## combine single form and combination form
  mutate(acei = ifelse(rowSums(subset(., select=c('acei_s','acei_c')))>0,1,0))%>%
  mutate(betablocker = ifelse(rowSums(subset(., select=c('betablocker_s','betablocker_c')))>0,1,0))%>%
  mutate(arb = ifelse(rowSums(subset(., select=c('arb_s','arb_c')))>0,1,0))%>%
  dplyr::select(c('RXDDRGID','RXDDRUG','aspirin','statin',
                                'anti_platelet','anti_htn','anti_hyperlipid','anti_diabetes',
                                'acei','arb','betablocker'))

```




## 1999-2000
```{r}
## demographic infos
demo_a <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/DEMO.XPT"))%>%
  dplyr::select('SEQN','SDDSRVYR','RIDAGEYR','RIDAGEMN','RIAGENDR','RIDRETH1','DMDEDUC2','DMDEDUC3','DMDMARTL','INDFMPIR','WTINT4YR','WTMEC4YR','SDMVPSU','SDMVSTRA','RIDEXPRG')

## health insurance status
hiq_a <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/HIQ.XPT"))%>%
  dplyr::select('SEQN', 'HID010')

## occupation/employment status
ocq_a <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/OCQ.XPT"))%>% 
  dplyr::select('SEQN','OCQ150','OCQ380')

## diabetes history
diq_a <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/DIQ.XPT"))%>% 
  dplyr::select('SEQN', 'DIQ010', 'DIQ050','DIQ070')


## hypertension and cholesterol history 
bpq_a <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/BPQ.XPT"))%>%
  dplyr::select('SEQN', 'BPQ020','BPQ050A','BPQ080','BPQ100D')


## bp measurement
bpx_a <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/BPX.XPT"))%>% 
  dplyr::select('SEQN','BPXSY1','BPXSY2','BPXSY3','BPXSY4','BPXDI1','BPXDI2','BPXDI3','BPXDI4','BPXCHR','BPXPLS')%>%
  mutate(SY_mean =rowMeans(subset(.,select = c('BPXSY1','BPXSY2','BPXSY3','BPXSY4')), na.rm = TRUE))%>%
  mutate(DI_mean =rowMeans(subset(.,select = c('BPXDI1','BPXDI2','BPXDI3','BPXDI4')), na.rm = TRUE))%>%
  # metric for htn 1: not control
  mutate(bpx_metric = case_when(SY_mean >= 140 | DI_mean >=90 ~ 1,
                                (SY_mean < 140 & DI_mean < 90)~2,
                                (SY_mean < 140 & is.na(DI_mean))~2,
                                (DI_mean < 90 & is.na(SY_mean))~2,
                                TRUE ~ NA_real_))%>%
  # ss stands for sensitivity
  mutate(bpx_metric_ss = case_when(SY_mean >= 130 | DI_mean >=80 ~ 1,
                                (SY_mean < 130 & DI_mean < 80)~2,
                                (SY_mean < 130 & is.na(DI_mean))~2,
                                (DI_mean < 80 & is.na(SY_mean))~2,
                                TRUE ~ NA_real_))%>%
  dplyr::select(SEQN,bpx_metric, bpx_metric_ss, SY_mean, DI_mean,BPXCHR,BPXPLS)




## comorbidities
mcq_a <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/MCQ.XPT"))%>% 
  dplyr::select('SEQN', 
                'MCQ160B','MCQ180B',
                'MCQ160C','MCQ180C', ## coronary heart disease and the age first diagnosed
                'MCQ160D','MCQ180D',
                'MCQ160E','MCQ180E', ## heart attack and the age first diagnosed
                'MCQ160F','MCQ180F', ## stroke and the age first diagnosed
                'MCQ220',# MCQ220 cancer
                'MCQ250A','MCQ250F')


## alcohol intake
alq_a <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/ALQ.XPT"))%>% 
  dplyr::select('SEQN','ALQ120Q','ALQ120U','ALQ130','ALQ110','ALQ100')%>%
  replace_with_na(replace = list(ALQ120Q = c(777,999),
                                 ALQ120U = c(7,9),
                                 ALQ130 = c(77,99),
                                 ALQ110 = c(7,9),
                                 ALQ100 = c(7,9)))%>%
  ## ADD is the estimate of average daily drinks
  mutate(ADD = case_when(ALQ100 == 2 ~ 0,
                         ALQ110 == 2 ~ 0,
                         ALQ120U == 1 ~ ALQ130*ALQ120Q/7,
                         ALQ120U == 2 ~ ALQ130*ALQ120Q/30,
                         ALQ120U == 3 ~ ALQ130*ALQ120Q/365,
                         TRUE ~ NA_real_))



## smoking status
smq1 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/SMQ.XPT"))%>% 
  dplyr::select('SEQN','SMQ020', 'SMQ040')

smq2 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/SMQMEC.XPT"))%>% 
  dplyr::select('SEQN','SMQ620','SMD680')

smq_a <- smq1 %>% full_join(smq2, by= 'SEQN')

smq_a$SMQ_HIST <-apply(smq_a,1,function(x){
  if(any(x[2]==2,x[4]==2,na.rm = T)){return ('Never smoker')}
  else if (!any(x[2]==2,x[4]==2,na.rm = T) & any(x[3]%in% c(1,2),x[5]==1,na.rm = T)){return ('Current smoker')}
  else if (any(x[2] ==1,x[4]==1,na.rm = T) & (!x[3] %in% c(1,2) & x[5] %in% c(2))){return ('Former smoker')}
  else if (any(x[2] ==1,x[4]==1,na.rm = T) & (x[3] %in% c(3) & !x[5] %in% c(1))){return ('Former smoker')}
  else {return ('unknown')}
  
})




## physical activity 
paq1 <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/PAQIAF.XPT"))%>% 
  dplyr::select('SEQN','PADLEVEL', 'PADDURAT','PADTIMES') %>%
  dplyr::group_by(SEQN,)%>% 
  summarise(TWMT = sum(PADDURAT*PADTIMES*PADLEVEL, na.rm =T)/4, .groups = 'drop' )

paq2 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/PAQ.XPT"))%>% 
  dplyr::select('SEQN','PAD200', 'PAD320','PAD020','PAQ050Q','PAQ050U','PAD570','PAQ580')

paq_a <- paq1 %>% dplyr::full_join(paq2, by= 'SEQN')%>%
  mutate(TWMT = ifelse(PAD200 %in% c(2,3) & PAD320 %in% c(2,3),0,TWMT))


## Weight history
whq_a <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/WHQ.XPT"))%>%
  dplyr::select('SEQN','WHD020','WHD050','WHQ070','WHD080D','WHD100D')%>%
  ## convert special code to NA
  replace_with_na(replace = list(WHD020 = c(77777,99999),
                                 WHD050 = c(77777,99999)))%>%
  mutate(WT_DIFF_PB = WHD050 - WHD020)


## obsesity metric
bmx_a <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/BMX.XPT")) %>%
  dplyr::select('SEQN', 'BMXWAIST','BMXBMI','BMXWT','BMXARMC','BMXHT')

## cardiovascular health
cdq_a <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/CDQ.XPT"))%>%
  dplyr::select('SEQN', 'CDQ010')


## total cholesterol 
tchol_a <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/LAB13.XPT")) %>%
  dplyr::select('SEQN', 'LBXTC','LBDHDL')


## Glycohemoglobin
ghb_a <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/LAB10.XPT")) %>%
  dplyr::select('SEQN', 'LBXGH')


## Ldl
ldl_a <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/LAB13AM.XPT")) %>%
  dplyr::select('SEQN', 'LBDLDL','LBXTR','WTSAF2YR')


## Fasting glucose
glu_ins_a <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/LAB10AM.XPT")) %>%
  dplyr::select('SEQN', 'WTSAF2YR','LBXGLU','LBXIN')

## prescription
rxq_a <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/RXQ_RX.XPT"))



## FASTING SUBSAMPLE
fast_a <- glu_ins_a %>% 
  full_join(ldl_a, by = c('SEQN','WTSAF2YR'))

  
## BIO PROFILE
biopro_a <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/LAB18.XPT")) %>%
  dplyr::select('SEQN', 'LBXSATSI', 'LBXSASSI', 'LBXSBU','LBXSGL','LBXSLDSI',
                'LBXSKSI','LBXSCLSI','LBXSNASI','LBXSCH','LBXSTP','LBXSTR',
                'LBDSCRSI','LBXSCR',
                 'LBXSC3SI','LBXSCA','LBXSIR','LBXSTB')




## prescription info join with drugs
rxq_sp_a <- rxq_a %>% left_join(sp_drug, by='RXDDRGID') %>%
  dplyr::group_by(SEQN) %>%
  ## _per means per person
  summarise(acei_per = ifelse(sum(acei, na.rm=T)>0,1,0), 
            betablocker_per =ifelse( sum(betablocker, na.rm=T)>0,1,0), 
            arb_per = ifelse(sum(arb, na.rm=T)>0,1,0), 
            aspirin_per = ifelse(sum(aspirin, na.rm = T)>0,1,0),
            statin_per = ifelse(sum(statin, na.rm = T)>0,1,0),
            anti_platelet_per = ifelse(sum(anti_platelet, na.rm = T)>0,1,0),
            anti_htn_per = ifelse(sum(anti_htn, na.rm = T)>0,1,0),
            anti_hyperlipid_per = ifelse(sum(anti_hyperlipid, na.rm = T)>0,1,0),
            anti_diabetes_per = ifelse(sum(anti_diabetes, na.rm = T)>0,1,0),
            .groups = 'drop' )%>%
  mutate(optimal_regimen_per = rowSums(subset(., select=c(anti_htn_per, anti_hyperlipid_per, anti_platelet_per))))



## pregnancy
rhq_a <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/RHQ.XPT"))%>%
  select(SEQN, RHQ140)


## DXX
dxx_a <- read_xpt(url("https://wwwn.cdc.gov/nchs/data/nhanes/dxa/dxx.xpt")) %>% 
  dplyr::select('SEQN', '_MULT_',
                'DXDTOPF','DXDTOBMD',
                'DXXLABMD','DXDLAPF',
                'DXXLLBMD','DXDLLPF',
                'DXXRABMD','DXDRAPF',
                'DXXRLBMD','DXDRLPF',
                'DXDTRBMD','DXDTRPF',
                'DXDLALE','DXDRALE',
                'DXDLLLE','DXDRLLE',
                'DXDTRLE','DXXTRFAT',
                'DXXLAFAT','DXXRAFAT',
                'DXXLLFAT','DXXRLFAT',
                'DXDTOFAT','DXDTOLE',
                'DXDTOBMD')%>%
  rename(MULT = '_MULT_')%>%
  group_by(SEQN)%>%
  summarise(DXDTOPF = median(DXDTOPF,na.rm = T),
            DXDTOBMD = median(DXDTOBMD,na.rm = T),
            DXXLABMD = median(DXXLABMD,na.rm = T),
            DXDLAPF = median(DXDLAPF,na.rm = T),
            DXXLLBMD = median(DXXLLBMD,na.rm = T),
            DXDLLPF = median(DXDLLPF,na.rm = T),
            DXXRABMD = median(DXXRABMD,na.rm = T),
            DXDRAPF = median(DXDRAPF,na.rm = T),
            DXXRLBMD = median(DXXRLBMD,na.rm = T),
            DXDRLPF = median(DXDRLPF,na.rm = T),
            DXDTRBMD = median(DXDTRBMD,na.rm = T),
            DXDTRPF = median(DXDTRPF,na.rm = T),
            DXDLALE = median(DXDLALE,na.rm = T),
            DXDRALE = median(DXDRALE,na.rm = T),
            DXDLLLE = median(DXDLLLE,na.rm = T),
            DXDRLLE = median(DXDRLLE,na.rm = T),
            DXDTRLE = median(DXDTRLE,na.rm = T),
            DXXTRFAT = median(DXXTRFAT,na.rm = T),
            DXXLAFAT = median(DXXLAFAT,na.rm = T),
            DXXRAFAT = median(DXXRAFAT,na.rm = T),
            DXXLLFAT = median(DXXLLFAT,na.rm = T),
            DXXRLFAT = median(DXXRLFAT,na.rm = T),
            DXDTOFAT = median(DXDTOFAT,na.rm = T),
            DXDTOLE = median(DXDTOLE,na.rm = T),
            DXDTOBMD = median(DXDTOBMD,na.rm = T))




# dietary data

diet_a <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/DRXTOT.XPT"))%>%
  select(SEQN, DRDDAY,DRDDRSTS, DRXTKCAL,DRXTPROT,DRXTCARB,DRXTTFAT,DRXTSFAT,DRXTMFAT,DRXTPFAT,
         DRXTCHOL,DRXTFIBE,DRXTVB1,DRXTVB2,DRXTNIAC,DRXTVB6,DRXTFOLA,DRXTVB12,DRXTVC,DRXTVE,
         DRXTCALC,DRXTPHOS,DRXTMAGN, DRXTIRON,DRXTZINC,DRXTCOPP,DRDTSODI,DRXTPOTA,DRXTSELE,DRXTCAFF,
         DRXTTHEO,DRXTALCO,DRXTWATE,
         DRXTS040,DRXTS060,DRXTS080,DRXTS100,DRXTS120,DRXTS140,DRXTS160,DRXTS180,
         DRXTM161,DRXTM181,DRXTM201,DRXTM221,
         DRXTP182,DRXTP183,DRXTP184,DRXTP204,DRXTP205,DRXTP225,DRXTP226,
         DRQ300, DRD320GW)%>%
  rename(DAY_DIET =  DRDDAY,
         STATUS_DIET=DRDDRSTS,
         CALORIE_DIET =DRXTKCAL,
         PROTEIN_DIET = DRXTPROT,
         CARB_DIET= DRXTCARB,
         FAT_DIET = DRXTTFAT,
         SFAT_DIET =DRXTSFAT,
         MFAT_DIET = DRXTMFAT,
         PFAT__DIET = DRXTPFAT,
         CHOL_DIET = DRXTCHOL,
         FIBE_DIET = DRXTFIBE,
         VB1_DIET = DRXTVB1,
         VB2_DIET = DRXTVB2,
         NIAC_DIET = DRXTNIAC,
         VB6_DIET = DRXTVB6,
         FOLATE_DIET = DRXTFOLA,
         VB12_DIET = DRXTVB12,
         VC_DIET = DRXTVC,
         VE_DIET = DRXTVE ,
         CALC_DIET= DRXTCALC,
         PHOS_DIET = DRXTPHOS,
         MG_DIET = DRXTMAGN,
         IRON_DIET = DRXTIRON,
         ZINC_DIET = DRXTZINC,
         COPP_DIET = DRXTCOPP,
         SODI_DIET = DRDTSODI,
         POTA_DIET = DRXTPOTA,
         SELE_DIET = DRXTSELE,
         CAFF_DIET = DRXTCAFF,
         THEO_DIET = DRXTTHEO,
         ALCO_DIET = DRXTALCO,
         MOIS_DIET = DRXTWATE,
         COMPARE = DRQ300, 
         TOTWATER = DRD320GW,
         TS040 = DRXTS040,
         TS060 = DRXTS060,
         TS080 = DRXTS080,
         TS100 = DRXTS100,
         TS120 = DRXTS120,
         TS140 = DRXTS140,
         TS160 = DRXTS160,
         TS180 = DRXTS180,
         TM161 = DRXTM161,
         TM181 = DRXTM181,
         TM201 = DRXTM201,
         TM221 = DRXTM221,
         TP182 = DRXTP182,
         TP183 = DRXTP183,
         TP184 = DRXTP184,
         TP204 = DRXTP204,
         TP205 = DRXTP205,
         TP225 = DRXTP225,
         TP226 = DRXTP226)%>%
  mutate(IS_WEEKEND_DIET = ifelse(DAY_DIET %in% c(1,6,7),1,0),## friday, sunday or saturday
         COMPARE_USUAL = ifelse(COMPARE ==1,1,0),
         COMPARE_LESS = ifelse(COMPARE ==2,1,0),
         COMPARE_MORE = ifelse(COMPARE ==3,1,0))%>%
  filter(STATUS_DIET == 1)%>%
  dplyr::select(SEQN, IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
                CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226)
  


## urine content
urine_a <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/LAB16.XPT"))%>%
  dplyr::mutate(albuminuria = (URXUMA/URXUCR)*100)


## combine
comb_a <- demo_a %>% left_join(hiq_a, by='SEQN')%>%  left_join(ocq_a, by='SEQN')%>% left_join(diq_a, by='SEQN')%>%  
  left_join(bpq_a, by='SEQN')%>%left_join(bpx_a, by='SEQN')%>%left_join(mcq_a, by='SEQN')%>% 
  left_join(alq_a, by='SEQN')%>% left_join(smq_a, by='SEQN')%>% left_join(paq_a, by='SEQN')%>% 
  left_join(bmx_a, by='SEQN')%>% left_join(tchol_a, by='SEQN')%>% left_join(ghb_a, by='SEQN')%>% 
  left_join(rxq_sp_a, by='SEQN')%>% left_join(rhq_a, by='SEQN')%>% 
  left_join(biopro_a, by='SEQN')%>% left_join(fast_a, by='SEQN')%>%
  left_join(whq_a, by = 'SEQN')%>%
  left_join(dxx_a, by = 'SEQN')%>%
  left_join(cdq_a, by = 'SEQN')%>%
  left_join(diet_a, by = 'SEQN')%>%
  left_join(urine_a, by = 'SEQN')


#FF stands for secondary Fat and Fit
VO2MAX1999 <- comb_a %>% 
  mutate(seqn = SEQN,
         time = 1,  
         year = '1999',
         age = RIDAGEYR,
         gender = case_when(RIAGENDR == 1 ~ 'Male',
                            RIAGENDR == 2 ~ 'Female',
                            TRUE ~ NA_character_),
         educ = case_when((DMDEDUC3 %in% c(0,1,2,3,4,5,6,7,8,9,10,11,12,55,66))|(DMDEDUC2 %in% c(1,2)) ~ 'Less than high school',
                         (DMDEDUC3 %in% c(13,14))|(DMDEDUC2 == 3) ~ 'High school diploma or GED',
                         (DMDEDUC3 == 15)|(DMDEDUC2 %in% c(4,5)) ~'Greater than high school',
                         TRUE ~ NA_character_),
         race_ethn = case_when( RIDRETH1 %in% c(1,2) ~ 'Hispanic',
                                RIDRETH1 == 3 ~ 'Non-Hispanic White',
                                RIDRETH1 == 4 ~ 'Non-Hispanic Black',
                                TRUE ~ 'Other'),
         marital_status = case_when(DMDMARTL %in% c(1,6) ~ 'married/live with other',
                                     DMDMARTL %in% c(2,3,4,5) ~ 'other',
                                     TRUE ~ NA_character_),
         family_income = case_when(INDFMPIR >=2 ~ 'High/Middle income',
                                    INDFMPIR < 2 ~ 'Low income',
                                    TRUE ~ NA_character_),
         health_insurance = case_when(HID010 == 1 ~ 1L, 
                                       HID010 == 2 ~ 0L,
                                       TRUE ~ NA_integer_),
         employment_status = case_when(OCQ150 %in% c(1,2) ~ 'Working',
                                       (OCQ150 == 3) ~'Unemployed',
                                       (OCQ150==4 & OCQ380 ==5)~'Unemployed',
                                       OCQ150 == 4 & OCQ380 %in% c(1,2,3,4,6) ~ 'Not in labor force',
                                        TRUE ~ NA_character_),
         htn_history = case_when(BPQ020 == 1 ~ 1L,
                              BPQ020 == 2 ~ 0L,
                              TRUE ~ NA_integer_),
         htn_treatment = case_when(BPQ050A == 1 | anti_htn_per==1 ~ 1L,
                                   (BPQ050A %in% c(7,9,NA)) & is.na(anti_htn_per)~ NA_integer_,
                              TRUE ~ 0L),
         high_chol_history = case_when(BPQ080 == 1 ~ 1L,
                                    BPQ080 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         high_chol_treatment = case_when(BPQ100D == 1 | anti_hyperlipid_per==1 ~ 1L,
                                         (BPQ100D %in% c(7,9,NA)) & is.na(anti_hyperlipid_per) ~ NA_integer_,
                              TRUE ~ 0L),
         diab_history= case_when(DIQ010 ==1 ~1L,
                              DIQ010 %in% c(2,3) ~ 0L,
                              TRUE ~ NA_integer_),
         diab_treatment = case_when(DIQ050 == 1|DIQ070==1|anti_diabetes_per==1~ 1L,
                                    DIQ050 %in% c(7,9,NA)& DIQ070 %in% c(7,9,NA) & is.na(anti_diabetes_per)~ NA_integer_,
                              TRUE ~ 0L),
         cancer_history = case_when(MCQ220 == 1 ~ 1L,
                                    MCQ220 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         CD_history = case_when(MCQ160B==1|MCQ160C==1|MCQ160D==1|MCQ160E==1|MCQ160F==1 ~ 1L,
                                MCQ160B%in%c(7,9,NA)&MCQ160C%in%c(7,9,NA)&MCQ160D%in%c(7,9,NA)&MCQ160E%in%c(7,9,NA)&MCQ160F%in%c(7,9,NA) ~ NA_integer_,
                              TRUE ~ 0L),
         first_cd_age = case_when(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F) ~ NA_real_,
                                   !(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F))~ pmin(MCQ180B,MCQ180C,MCQ180D,MCQ180E,MCQ180F,na.rm = T)),
         close_relatives_heartattack = case_when(MCQ250F == 1 ~ 1L,
                                    MCQ250F == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         close_relatives_diabetes = case_when(MCQ250A == 1 ~ 1L,
                                    MCQ250A == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         alcohol_intake = case_when(age<20 ~ 'Never drinker',
                                    ALQ110 == 2 ~ 'Never drinker',
                                    ALQ110 == 1 & ADD ==0 ~ 'Former drinker',
                                    ALQ110 == 1 & ALQ100 == 2 ~ 'Former drinker',
                                    ADD>0 & ADD<0.5 ~ 'Light drinker',
                                    ADD>=0.5 & ADD<2.5 & RIAGENDR == 1 ~ 'Moderate drinker',
                                    ADD>=0.5 & ADD<1.5 & RIAGENDR == 2 ~ 'Moderate drinker',
                                    ADD>=2.5 & RIAGENDR == 1 ~ 'Heavier drinker',
                                    ADD>=1.5 & RIAGENDR == 2 ~ 'Heavier drinker',
                                    TRUE ~ NA_character_),
         smoking_status = case_when(SMQ_HIST == 'Never smoker'  ~ 'Never smoker',
                                    SMQ_HIST == 'Former smoker' ~ 'Former smoker',
                                    SMQ_HIST == 'Current smoker' ~ 'Current smoker',
                                     TRUE ~ NA_character_),
         physical_activity = case_when(PAD200 %in% c(2,3) & PAD320 %in% c(2,3) ~ 'Inactive',                                       
                              TWMT < 10 ~ 'Inactive',
                                       TWMT >= 10 & TWMT < 150 ~ 'Insufficient active',
                                       TWMT >= 150 ~ 'Active',
                                       TRUE ~ NA_character_),
         pregnant = case_when((RHQ140 == 1)|(RIDEXPRG==1) ~ 1L,
                               TRUE ~ 0L),
         WT_DIFF_KG = WT_DIFF_PB*0.45359237,
         lwlstyr = case_when(WHQ070 == 1 ~ 1L,
                              WHQ070 == 2 ~ 0L,
                               TRUE ~ NA_integer_),
         exerc2lwlastyr = case_when(WHD080D == 13|WHD100D ==13 ~ 1L,
                                    (is.na(WHD080D) & is.na(WHD100D) & WHQ070 == 1)|(WHQ070 == 2)  ~ 0L,
                                    TRUE ~ NA_integer_),
         coef_toweek = case_when(PAQ050U == 1 ~ 7,
                                 PAQ050U == 2 ~ 1,
                                 PAQ050U == 3 ~ 1/4,
                                 TRUE ~ NA_real_),
         walk_bicycle_times_wk = case_when(PAD020 %in% c(2,3) ~ 0L,
                                           PAD020== 1 ~ as.integer(floor(PAQ050Q*coef_toweek)),
                                           TRUE ~ NA_integer_),
         overweight = case_when(BMXBMI >=25 ~ 1L,
                                BMXBMI < 25 ~ 0L,
                                TRUE ~ NA_integer_),
         overall_obesity = case_when(BMXBMI >=30 ~ 1L,
                                     BMXBMI < 30 ~ 0L,
                                     TRUE ~ NA_integer_),
         abdominal_obesity = case_when(BMXWAIST >= 102 & RIAGENDR == 1 ~ 1L,
                                       BMXWAIST < 102 & RIAGENDR == 1 ~ 0L,
                                       BMXWAIST >= 88 & RIAGENDR == 2~ 1L,
                                       BMXWAIST < 88 & RIAGENDR == 2 ~ 0L,
                                       TRUE~ NA_integer_),
         HBF1 = case_when(DXDTOPF >= 25 & RIAGENDR == 1 ~ 1L,
                         DXDTOPF < 25 & RIAGENDR == 1 ~ 0L,
                         DXDTOPF >= 35 & RIAGENDR == 2 ~ 1L,
                         DXDTOPF < 35 & RIAGENDR == 2 ~ 0L,
                         TRUE~ NA_integer_),
         HBF2 = case_when(DXDTOPF >= 28 & RIAGENDR == 1 ~ 1L,
                         DXDTOPF < 28 & RIAGENDR == 1 ~ 0L,
                         DXDTOPF >= 38 & RIAGENDR == 2 ~ 1L,
                         DXDTOPF < 38 & RIAGENDR == 2 ~ 0L,
                         TRUE~ NA_integer_),
         diab_now = case_when(diab_treatment==1L|LBXGH >=6.5|LBXGLU >=126 ~ 1L, ## oral glu tolerance was added from 2011
                              is.na(diab_treatment)&is.na(LBXGH )&is.na(LBXGLU) ~ NA_integer_,
                              TRUE ~ 0L),
         htn_now = case_when(htn_treatment==1L|SY_mean>=140|DI_mean>=90 ~ 1L,
                             is.na(htn_treatment)&is.na(SY_mean)&is.na(DI_mean) ~ NA_integer_,
                             TRUE ~0L),
         highchol_now = case_when(high_chol_treatment==1L |LBXTC>=240|LBDLDL>=160 ~ 1L,
                                  is.na(high_chol_treatment)&is.na(LBXTC)&is.na(LBDLDL) ~ NA_integer_,
                                  TRUE ~ 0L),
         short_breathe = case_when(CDQ010 ==1 ~ 1L,
                                   TRUE ~ 0L ))%>%
  mutate(LDL = LBDLDL,
         HDL = LBDHDL,
         TOTAL_CHOL = LBXTC,
         FAST_GLU = LBXGLU,
         HBA1C = LBXGH,
         FAST_INSULIN = LBXIN,
         FAST_TRI = LBXTR,
         ALT = LBXSATSI,
         AST = LBXSASSI,
         BUN = LBXSBU,
         GLU = LBXSGL,
         LDH = LBXSLDSI,
         POTAS = LBXSKSI,
         CHL = LBXSCLSI,
         SODI = LBXSNASI,
         CHOL = LBXSCH,
         TOTPRO = LBXSTP,
         CREATININE =LBXSCR,
         BILIRUBIN= LBXSTB,
         IRON = LBXSIR,
         CALCIUM = LBXSCA,
         BICARBONATE = LBXSC3SI,
         WTINT2YR = WTINT4YR*2,
         WTMEC2YR = WTMEC4YR*2)%>%
  select(seqn,time,year,age,gender,educ, race_ethn, marital_status,INDFMPIR, family_income, health_insurance, employment_status,
         SDMVPSU,SDMVSTRA,WTINT2YR,WTMEC2YR,WTSAF2YR,
         SY_mean, DI_mean, BMXBMI,BMXWAIST,BMXHT, bpx_metric,bpx_metric_ss,BPXCHR,BPXPLS,BMXWT,WT_DIFF_KG,BMXARMC,
         alcohol_intake,smoking_status,physical_activity,pregnant,lwlstyr, exerc2lwlastyr,walk_bicycle_times_wk,ADD, TWMT, short_breathe,
         overweight, overall_obesity, abdominal_obesity, HBF1,HBF2,
         htn_history, high_chol_history,diab_history, cancer_history, CD_history, first_cd_age,close_relatives_heartattack,close_relatives_diabetes,
         diab_now, htn_now,highchol_now,
         htn_treatment, high_chol_treatment, diab_treatment,aspirin_per, statin_per,acei_per,arb_per,betablocker_per,optimal_regimen_per, 
         LDL,HDL,TOTAL_CHOL,FAST_GLU,HBA1C,FAST_INSULIN,FAST_TRI,ALT,AST,BUN,GLU,LDH,POTAS,CHL,SODI,CHOL,TOTPRO, LBDSCRSI,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         DXDTOPF,DXXLABMD,DXDLAPF, DXXLLBMD, DXDLLPF,DXXRABMD,DXDRAPF , DXXRLBMD ,DXDRLPF , DXDTRBMD ,DXDTRPF,
         DXDLALE,DXDRALE,DXDLLLE,DXDRLLE,DXDTRLE,DXXTRFAT,DXXLAFAT,DXXRAFAT,DXXLLFAT,DXXRLFAT,DXDTOFAT,DXDTOLE,DXDTOBMD,
         IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
         CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226)

 

## write to csv file
# VO2MAX1999%>% write.csv(paste0(wd_path,'/VO2MAX1999.csv'))





```





## 2001-2002
```{r}
## demographic infos
demo_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/DEMO_b.XPT"))%>%
  dplyr::select('SEQN','SDDSRVYR','RIDAGEYR','RIDAGEMN','RIAGENDR','RIDRETH1','DMDEDUC2','DMDEDUC3','DMDMARTL','INDFMPIR','WTINT4YR','WTMEC4YR','SDMVPSU','SDMVSTRA','RIDEXPRG')


## health insurance status
hiq_b <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/HIQ_b.XPT"))%>%
  dplyr::select('SEQN', 'HID010')

## occupation/employment status
ocq_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/OCQ_b.XPT"))%>% 
  dplyr::select('SEQN','OCD150','OCQ380')

## diabetes history
diq_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/DIQ_b.XPT"))%>% 
  dplyr::select('SEQN', 'DIQ010', 'DIQ050','DIQ070')


## hypertension and cholesterol history 
bpq_b <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/BPQ_b.XPT"))%>%
  dplyr::select('SEQN', 'BPQ020','BPQ050A','BPQ080','BPQ100D')


## bp measurement
bpx_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/BPX_b.XPT"))%>% 
  dplyr::select('SEQN','BPXSY1','BPXSY2','BPXSY3','BPXSY4','BPXDI1','BPXDI2','BPXDI3','BPXDI4','BPXCHR','BPXPLS')%>%
  mutate(SY_mean =rowMeans(subset(.,select = c('BPXSY1','BPXSY2','BPXSY3','BPXSY4')), na.rm = TRUE))%>%
  mutate(DI_mean =rowMeans(subset(.,select = c('BPXDI1','BPXDI2','BPXDI3','BPXDI4')), na.rm = TRUE))%>%
  # metric for htn 1: not control
  mutate(bpx_metric = case_when(SY_mean >= 140 | DI_mean >=90 ~ 1,
                                (SY_mean < 140 & DI_mean < 90)~2,
                                (SY_mean < 140 & is.na(DI_mean))~2,
                                (DI_mean < 90 & is.na(SY_mean))~2,
                                TRUE ~ NA_real_))%>%
  # ss stands for sensitivity
  mutate(bpx_metric_ss = case_when(SY_mean >= 130 | DI_mean >=80 ~ 1,
                                (SY_mean < 130 & DI_mean < 80)~2,
                                (SY_mean < 130 & is.na(DI_mean))~2,
                                (DI_mean < 80 & is.na(SY_mean))~2,
                                TRUE ~ NA_real_))%>%
  dplyr::select(SEQN,bpx_metric, bpx_metric_ss, SY_mean, DI_mean,BPXCHR,BPXPLS)




## comorbidities
mcq_b <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/MCQ_b.XPT"))%>% 
  dplyr::select('SEQN', 
                'MCQ160B','MCQ180B',
                'MCQ160C','MCQ180C', ## coronary heart disease and the age first diagnosed
                'MCQ160D','MCQ180D',
                'MCQ160E','MCQ180E', ## heart attack and the age first diagnosed
                'MCQ160F','MCQ180F', ## stroke and the age first diagnosed
                'MCQ220',# MCQ220 cancer
                'MCQ250A','MCQ250F')


## alcohol intake
alq_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/ALQ_b.XPT"))%>% 
  dplyr::select('SEQN','ALQ120Q','ALQ120U','ALQ130','ALQ110','ALD100')%>%
  replace_with_na(replace = list(ALQ120Q = c(777,999),
                                 ALQ120U = c(7,9),
                                 ALQ130 = c(77,99),
                                 ALQ110 = c(7,9),
                                 ALD100 = c(7,9)))%>%
  ## ADD is the estimate of average daily drinks
  mutate(ADD = case_when(ALD100 == 2 ~ 0,
                         ALQ110 == 2 ~ 0,
                         ALQ120U == 1 ~ ALQ130*ALQ120Q/7,
                         ALQ120U == 2 ~ ALQ130*ALQ120Q/30,
                         ALQ120U == 3 ~ ALQ130*ALQ120Q/365,
                         TRUE ~ NA_real_))



## smoking status
smq_b1 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/SMQ_B.XPT"))%>% 
  dplyr::select('SEQN','SMQ020', 'SMQ040')

smq_b2 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/SMQMEC_B.XPT"))%>% 
  dplyr::select('SEQN','SMQ620','SMQ680')

smq_b <- smq_b1 %>% full_join(smq_b2, by= 'SEQN')

smq_b$SMQ_HIST <-apply(smq_b,1,function(x){
  if(any(x[2]==2,x[4]==2,na.rm = T)){return ('Never smoker')}
  else if (!any(x[2]==2,x[4]==2,na.rm = T) & any(x[3]%in% c(1,2),x[5]==1,na.rm = T)){return ('Current smoker')}
  else if (any(x[2] ==1,x[4]==1,na.rm = T) & (!x[3] %in% c(1,2) & x[5] %in% c(2))){return ('Former smoker')}
  else if (any(x[2] ==1,x[4]==1,na.rm = T) & (x[3] %in% c(3) & !x[5] %in% c(1))){return ('Former smoker')}
  else {return ('unknown')}
  
})





## physical activity 
paq_b1 <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/PAQIAF_B.XPT"))%>% 
  dplyr::select('SEQN','PADLEVEL', 'PADDURAT','PADTIMES') %>%
  dplyr::group_by(SEQN)%>% 
  summarise(TWMT = sum(PADDURAT*PADTIMES*PADLEVEL, na.rm =T)/4, .groups = 'drop' )

paq_b2 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/PAQ_B.XPT"))%>% 
  dplyr::select('SEQN','PAD200', 'PAD320','PAD020','PAQ050Q','PAQ050U')

paq_b <- paq_b1 %>% full_join(paq_b2, by= 'SEQN')%>%
  mutate(TWMT = ifelse(PAD200 %in% c(2,3) & PAD320 %in% c(2,3),0,TWMT))


## Weight history
whq_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/WHQ_B.XPT"))%>%
  dplyr::select('SEQN','WHD020','WHD050','WHQ070','WHD080D','WHD100D')%>%
  ## convert special code to NA
  replace_with_na(replace = list(WHD020 = c(7777,9999),
                                 WHD050 = c(7777,9999)))%>%
  mutate(WT_DIFF_PB = WHD050 - WHD020)
 




## obsesity metric
bmx_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/BMX_b.XPT")) %>%
  dplyr::select('SEQN', 'BMXWAIST','BMXBMI','BMXWT','BMXARMC','BMXHT')

## cardiovascular health
cdq_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/CDQ_B.XPT"))%>%
  dplyr::select('SEQN', 'CDQ010')

## total cholesterol 
tchol_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/L13_b.XPT")) %>%
  dplyr::select('SEQN', 'LBXTC','LBDHDL')


## Glycohemoglobin
ghb_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/L10_b.XPT")) %>%
  dplyr::select('SEQN', 'LBXGH')





## Ldl
ldl_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/L13AM_B.XPT")) %>%
  dplyr::select('SEQN', 'LBDLDL','LBXTR','WTSAF2YR')


## Fasting glucose
glu_ins_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/L10AM_B.XPT")) %>%
  dplyr::select('SEQN', 'WTSAF2YR','LBXGLU','LBXIN')


## FASTING SUBSAMPLE
fast_b <- glu_ins_b %>% 
  full_join(ldl_b, by = c('SEQN','WTSAF2YR'))
  
## BIO PROFILE
biopro_b <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/L40_B.XPT")) %>%
  dplyr::select('SEQN', 'LBXSATSI', 'LBXSASSI', 'LBXSBU','LBXSGL','LBDSLDSI',
                'LBXSKSI','LBXSCLSI','LBXSNASI','LBXSCH','LBXSTP',
                'LBXSTR','LBDSCRSI','LBDSCR',
                'LBXSC3SI','LBXSCA','LBXSIR','LBDSTB')





## prescription
rxq_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/RXQ_RX_b.XPT"))



## prescription info join with drugs
rxq_sp_b <- rxq_b %>% left_join(sp_drug, by='RXDDRGID') %>%
  dplyr::group_by(SEQN) %>%
  ## _per means per person
  summarise(acei_per = ifelse(sum(acei, na.rm=T)>0,1,0), 
            betablocker_per =ifelse( sum(betablocker, na.rm=T)>0,1,0), 
            arb_per = ifelse(sum(arb, na.rm=T)>0,1,0), 
            aspirin_per = ifelse(sum(aspirin, na.rm = T)>0,1,0),
            statin_per = ifelse(sum(statin, na.rm = T)>0,1,0),
            anti_platelet_per = ifelse(sum(anti_platelet, na.rm = T)>0,1,0),
            anti_htn_per = ifelse(sum(anti_htn, na.rm = T)>0,1,0),
            anti_hyperlipid_per = ifelse(sum(anti_hyperlipid, na.rm = T)>0,1,0),
            anti_diabetes_per = ifelse(sum(anti_diabetes, na.rm = T)>0,1,0),
            .groups = 'drop' )%>%
  mutate(optimal_regimen_per = rowSums(subset(., select=c(anti_htn_per, anti_hyperlipid_per, anti_platelet_per))))


## pregnancy
rhq_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/RHQ_b.XPT"))%>%
  select(SEQN, RHQ141
)

## DXX
dxx_b <- read_xpt(url("https://wwwn.cdc.gov/nchs/data/nhanes/dxa/dxx_b.xpt")) %>% 
  dplyr::select('SEQN', '_MULT_',
                'DXDTOPF','DXDTOBMD',
                'DXXLABMD','DXDLAPF',
                'DXXLLBMD','DXDLLPF',
                'DXXRABMD','DXDRAPF',
                'DXXRLBMD','DXDRLPF',
                'DXDTRBMD','DXDTRPF',
                'DXDLALE','DXDRALE',
                'DXDLLLE','DXDRLLE',
                'DXDTRLE','DXXTRFAT',
                'DXXLAFAT','DXXRAFAT',
                'DXXLLFAT','DXXRLFAT',
                'DXDTOFAT','DXDTOLE',
                'DXDTOBMD')%>%
  rename(MULT = '_MULT_')%>%
  group_by(SEQN)%>%
  summarise(DXDTOPF = median(DXDTOPF,na.rm = T),
            DXDTOBMD = median(DXDTOBMD,na.rm = T),
            DXXLABMD = median(DXXLABMD,na.rm = T),
            DXDLAPF = median(DXDLAPF,na.rm = T),
            DXXLLBMD = median(DXXLLBMD,na.rm = T),
            DXDLLPF = median(DXDLLPF,na.rm = T),
            DXXRABMD = median(DXXRABMD,na.rm = T),
            DXDRAPF = median(DXDRAPF,na.rm = T),
            DXXRLBMD = median(DXXRLBMD,na.rm = T),
            DXDRLPF = median(DXDRLPF,na.rm = T),
            DXDTRBMD = median(DXDTRBMD,na.rm = T),
            DXDTRPF = median(DXDTRPF,na.rm = T),
            DXDLALE = median(DXDLALE,na.rm = T),
            DXDRALE = median(DXDRALE,na.rm = T),
            DXDLLLE = median(DXDLLLE,na.rm = T),
            DXDRLLE = median(DXDRLLE,na.rm = T),
            DXDTRLE = median(DXDTRLE,na.rm = T),
            DXXTRFAT = median(DXXTRFAT,na.rm = T),
            DXXLAFAT = median(DXXLAFAT,na.rm = T),
            DXXRAFAT = median(DXXRAFAT,na.rm = T),
            DXXLLFAT = median(DXXLLFAT,na.rm = T),
            DXXRLFAT = median(DXXRLFAT,na.rm = T),
            DXDTOFAT = median(DXDTOFAT,na.rm = T),
            DXDTOLE = median(DXDTOLE,na.rm = T),
            DXDTOBMD = median(DXDTOBMD,na.rm = T))




diet_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/DRXTOT_B.XPT"))%>%
  select(SEQN, DRDDAY,DRDDRSTZ, DRXTKCAL,DRXTPROT,DRXTCARB,DRXTTFAT,DRXTSFAT,DRXTMFAT,DRXTPFAT,
         DRXTCHOL,DRXTFIBE,DRXTVB1,DRXTVB2,DRXTNIAC,DRXTVB6,DRXTFOLA,DRXTVB12,DRXTVC,DRXTATOC,
         DRXTCALC,DRXTPHOS,DRXTMAGN, DRXTIRON,DRXTZINC,DRXTCOPP,DRDTSODI,DRXTPOTA,DRXTSELE,DRXTCAFF,
         DRXTTHEO,DRXTALCO,DRXTMOIS,
         DRXTS040,DRXTS060,DRXTS080,DRXTS100,DRXTS120,DRXTS140,DRXTS160,DRXTS180,
         DRXTM161,DRXTM181,DRXTM201,DRXTM221,
         DRXTP182,DRXTP183,DRXTP184,DRXTP204,DRXTP205,DRXTP225,DRXTP226,
         DRD300, DRD320GW)%>%
  rename(DAY_DIET =  DRDDAY,
         STATUS_DIET=DRDDRSTZ,
         CALORIE_DIET =DRXTKCAL,
         PROTEIN_DIET = DRXTPROT,
         CARB_DIET= DRXTCARB,
         FAT_DIET = DRXTTFAT,
         SFAT_DIET =DRXTSFAT,
         MFAT_DIET = DRXTMFAT,
         PFAT__DIET = DRXTPFAT,
         CHOL_DIET = DRXTCHOL,
         FIBE_DIET = DRXTFIBE,
         VB1_DIET = DRXTVB1,
         VB2_DIET = DRXTVB2,
         NIAC_DIET = DRXTNIAC,
         VB6_DIET = DRXTVB6,
         FOLATE_DIET = DRXTFOLA,
         VB12_DIET = DRXTVB12,
         VC_DIET = DRXTVC,
         VE_DIET = DRXTATOC,
         CALC_DIET= DRXTCALC,
         PHOS_DIET = DRXTPHOS,
         MG_DIET = DRXTMAGN,
         IRON_DIET = DRXTIRON,
         ZINC_DIET = DRXTZINC,
         COPP_DIET = DRXTCOPP,
         SODI_DIET = DRDTSODI,
         POTA_DIET = DRXTPOTA,
         SELE_DIET = DRXTSELE,
         CAFF_DIET = DRXTCAFF,
         THEO_DIET = DRXTTHEO,
         ALCO_DIET = DRXTALCO,
         MOIS_DIET = DRXTMOIS,
         COMPARE = DRD300, 
         TOTWATER = DRD320GW,
         TS040 = DRXTS040,
         TS060 = DRXTS060,
         TS080 = DRXTS080,
         TS100 = DRXTS100,
         TS120 = DRXTS120,
         TS140 = DRXTS140,
         TS160 = DRXTS160,
         TS180 = DRXTS180,
         TM161 = DRXTM161,
         TM181 = DRXTM181,
         TM201 = DRXTM201,
         TM221 = DRXTM221,
         TP182 = DRXTP182,
         TP183 = DRXTP183,
         TP184 = DRXTP184,
         TP204 = DRXTP204,
         TP205 = DRXTP205,
         TP225 = DRXTP225,
         TP226 = DRXTP226)%>%
  mutate(IS_WEEKEND_DIET = ifelse(DAY_DIET %in% c(1,6,7),1,0),## friday, sunday or saturday
         COMPARE_USUAL = ifelse(COMPARE ==1,1,0),
         COMPARE_LESS = ifelse(COMPARE ==2,1,0),
         COMPARE_MORE = ifelse(COMPARE ==3,1,0))%>%
  filter(STATUS_DIET ==1)%>%
  dplyr::select(SEQN, IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE, 
                CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226)



## urine content
urine_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/L16_B.XPT"))%>%
  dplyr::mutate(albuminuria = (URXUMA/URXUCR)*100)


  
  


## combine
comb_b <- demo_b %>% left_join(hiq_b, by='SEQN')%>%  left_join(ocq_b, by='SEQN')%>% left_join(diq_b, by='SEQN')%>%  
  left_join(bpq_b, by='SEQN')%>%left_join(bpx_b, by='SEQN')%>%left_join(mcq_b, by='SEQN')%>% 
  left_join(alq_b, by='SEQN')%>% left_join(smq_b, by='SEQN')%>% left_join(paq_b, by='SEQN')%>% 
  left_join(bmx_b, by='SEQN')%>% left_join(tchol_b, by='SEQN')%>% left_join(ghb_b, by='SEQN')%>% 
  left_join(rxq_sp_b, by='SEQN')%>% left_join(rhq_b, by='SEQN')%>% 
  left_join(fast_b, by='SEQN')%>% left_join(biopro_b, by='SEQN')%>%
  left_join(whq_b, by = 'SEQN')%>%
  left_join(dxx_b, by= 'SEQN')%>%
  left_join(cdq_b, by = 'SEQN')%>%
  left_join(diet_b, by = 'SEQN')%>%
  left_join(urine_b, by = 'SEQN')

#ff stands for fat and fit

VO2MAX2001 <- comb_b %>% 
  mutate(seqn = SEQN,
         time = 2,  
         year = '2001',
         age = RIDAGEYR,
         gender = case_when(RIAGENDR == 1 ~ 'Male',
                            RIAGENDR == 2 ~ 'Female',
                            TRUE ~ NA_character_),
         educ = case_when((DMDEDUC3 %in% c(0,1,2,3,4,5,6,7,8,9,10,11,12,55,66))|(DMDEDUC2 %in% c(1,2)) ~ 'Less than high school',
                         (DMDEDUC3 %in% c(13,14))|(DMDEDUC2 == 3) ~ 'High school diploma or GED',
                         (DMDEDUC3 == 15)|(DMDEDUC2 %in% c(4,5)) ~'Greater than high school',
                         TRUE ~ NA_character_),
         race_ethn = case_when( RIDRETH1 %in% c(1,2) ~ 'Hispanic',
                                RIDRETH1 == 3 ~ 'Non-Hispanic White',
                                RIDRETH1 == 4 ~ 'Non-Hispanic Black',
                                TRUE ~ 'Other'),
         marital_status = case_when(DMDMARTL %in% c(1,6) ~ 'married/live with other',
                                     DMDMARTL %in% c(2,3,4,5) ~ 'other',
                                     TRUE ~ NA_character_),
         family_income = case_when(INDFMPIR >=2 ~ 'High/Middle income',
                                    INDFMPIR < 2 ~ 'Low income',
                                    TRUE ~ NA_character_),
         health_insurance = case_when(HID010 == 1 ~ 1L, 
                                       HID010 == 2 ~ 0L,
                                       TRUE ~ NA_integer_),
         employment_status = case_when(OCD150 %in% c(1,2) ~ 'Working',
                                       (OCD150 == 3) ~'Unemployed',
                                       (OCD150==4 & OCQ380 ==5)~'Unemployed',
                                       OCD150 == 4 & OCQ380 %in% c(1,2,3,4,6) ~ 'Not in labor force',
                                        TRUE ~ NA_character_),
         htn_history = case_when(BPQ020 == 1 ~ 1L,
                              BPQ020 == 2 ~ 0L,
                              TRUE ~ NA_integer_),
         htn_treatment = case_when(BPQ050A == 1 | anti_htn_per==1 ~ 1L,
                                   (BPQ050A %in% c(7,9,NA)) & is.na(anti_htn_per)~ NA_integer_,
                              TRUE ~ 0L),
         high_chol_history = case_when(BPQ080 == 1 ~ 1L,
                                    BPQ080 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         high_chol_treatment = case_when(BPQ100D == 1 | anti_hyperlipid_per==1 ~ 1L,
                                         (BPQ100D %in% c(7,9,NA)) & is.na(anti_hyperlipid_per) ~ NA_integer_,
                              TRUE ~ 0L),
         diab_history= case_when(DIQ010 ==1 ~1L,
                              DIQ010 %in% c(2,3) ~ 0L,
                              TRUE ~ NA_integer_),
         diab_treatment = case_when(DIQ050 == 1|DIQ070==1|anti_diabetes_per==1~ 1L,
                                    DIQ050 %in% c(7,9,NA)& DIQ070 %in% c(7,9,NA) & is.na(anti_diabetes_per)~ NA_integer_,
                              TRUE ~ 0L),
         cancer_history = case_when(MCQ220 == 1 ~ 1L,
                                    MCQ220 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         CD_history = case_when(MCQ160B==1|MCQ160C==1|MCQ160D==1|MCQ160E==1|MCQ160F==1 ~ 1L,
                                MCQ160B%in%c(7,9,NA)&MCQ160C%in%c(7,9,NA)&MCQ160D%in%c(7,9,NA)&MCQ160E%in%c(7,9,NA)&MCQ160F%in%c(7,9,NA) ~ NA_integer_,
                              TRUE ~ 0L),
         first_cd_age = case_when(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F) ~ NA_real_,
                                   !(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F))~ pmin(MCQ180B,MCQ180C,MCQ180D,MCQ180E,MCQ180F,na.rm = T)),
         close_relatives_heartattack = case_when(MCQ250F == 1 ~ 1L,
                                    MCQ250F == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         close_relatives_diabetes = case_when(MCQ250A == 1 ~ 1L,
                                    MCQ250A == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         alcohol_intake = case_when(age < 20 ~  'Never drinker',
                                    ALQ110 == 2 ~ 'Never drinker',
                                    ALQ110 == 1 & ADD ==0 ~ 'Former drinker',
                                    ALQ110 == 1 & ALD100 == 2 ~ 'Former drinker',
                                    ADD>0 & ADD<0.5 ~ 'Light drinker',
                                    ADD>=0.5 & ADD<2.5 & RIAGENDR == 1 ~ 'Moderate drinker',
                                    ADD>=0.5 & ADD<1.5 & RIAGENDR == 2 ~ 'Moderate drinker',
                                    ADD>=2.5 & RIAGENDR == 1 ~ 'Heavier drinker',
                                    ADD>=1.5 & RIAGENDR == 2 ~ 'Heavier drinker',
                                    TRUE ~ NA_character_),
         smoking_status = case_when(SMQ_HIST == 'Never smoker'  ~ 'Never smoker',
                                    SMQ_HIST == 'Former smoker' ~ 'Former smoker',
                                    SMQ_HIST == 'Current smoker' ~ 'Current smoker',
                                     TRUE ~ NA_character_),
         physical_activity = case_when(PAD200 %in% c(2,3) & PAD320 %in% c(2,3) ~ 'Inactive',
                                       TWMT < 10 ~ 'Inactive',
                                       TWMT >= 10 & TWMT < 150 ~ 'Insufficient active',
                                       TWMT >= 150 ~ 'Active',
                                       TRUE ~ NA_character_),
         pregnant = case_when((RHQ141 == 1)|(RIDEXPRG==1) ~ 1L,
                               TRUE ~ 0L),
         WT_DIFF_KG = WT_DIFF_PB*0.45359237,
         lwlstyr = case_when(WHQ070 == 1 ~ 1L,
                              WHQ070 == 2 ~ 0L,
                               TRUE ~ NA_integer_),
         exerc2lwlastyr = case_when(WHD080D == 13|WHD100D ==13 ~ 1L,
                                    (is.na(WHD080D) & is.na(WHD100D) & WHQ070 == 1)|(WHQ070 == 2)  ~ 0L,
                                    TRUE ~ NA_integer_),
         coef_toweek = case_when(PAQ050U == 1 ~ 7,
                                 PAQ050U == 2 ~ 1,
                                 PAQ050U == 3 ~ 1/4,
                                 TRUE ~ NA_real_),
         walk_bicycle_times_wk = case_when(PAD020 %in% c(2,3) ~ 0L,
                                           PAD020== 1 ~ as.integer(floor(PAQ050Q*coef_toweek)),
                                           TRUE ~ NA_integer_),
         overweight = case_when(BMXBMI >=25 ~ 1L,
                                BMXBMI < 25 ~ 0L,
                                TRUE ~ NA_integer_),
         overall_obesity = case_when(BMXBMI >=30 ~ 1L,
                                     BMXBMI < 30 ~ 0L,
                                     TRUE ~ NA_integer_),
         abdominal_obesity = case_when(BMXWAIST >= 102 & RIAGENDR == 1 ~ 1L,
                                       BMXWAIST < 102 & RIAGENDR == 1 ~ 0L,
                                       BMXWAIST >= 88 & RIAGENDR == 2~ 1L,
                                       BMXWAIST < 88 & RIAGENDR == 2 ~ 0L,
                                       TRUE~ NA_integer_),
         HBF1 = case_when(DXDTOPF >= 25 & RIAGENDR == 1 ~ 1L,
                         DXDTOPF < 25 & RIAGENDR == 1 ~ 0L,
                         DXDTOPF >= 35 & RIAGENDR == 2 ~ 1L,
                         DXDTOPF < 35 & RIAGENDR == 2 ~ 0L,
                         TRUE~ NA_integer_),
         HBF2 = case_when(DXDTOPF >= 28 & RIAGENDR == 1 ~ 1L,
                         DXDTOPF < 28 & RIAGENDR == 1 ~ 0L,
                         DXDTOPF >= 38 & RIAGENDR == 2 ~ 1L,
                         DXDTOPF < 38 & RIAGENDR == 2 ~ 0L,
                         TRUE~ NA_integer_),
         diab_now = case_when(diab_treatment==1L|LBXGH >=6.5|LBXGLU >=126 ~ 1L, ## oral glu tolerance was added from 2011
                              is.na(diab_treatment)&is.na(LBXGH )&is.na(LBXGLU) ~ NA_integer_,
                              TRUE ~ 0L),
         htn_now = case_when(htn_treatment==1L|SY_mean>=140|DI_mean>=90 ~ 1L,
                             is.na(htn_treatment)&is.na(SY_mean)&is.na(DI_mean) ~ NA_integer_,
                             TRUE ~0L),
         highchol_now = case_when(high_chol_treatment==1L |LBXTC>=240|LBDLDL>=160 ~ 1L,
                                  is.na(high_chol_treatment)&is.na(LBXTC)&is.na(LBDLDL) ~ NA_integer_,
                                  TRUE ~ 0L),
         short_breathe = case_when(CDQ010 ==1 ~ 1L,
                                   TRUE ~ 0L))%>%
  mutate(LDL = LBDLDL,
         HDL = LBDHDL,
         TOTAL_CHOL = LBXTC,
         FAST_GLU = LBXGLU,
         HBA1C = LBXGH,
         FAST_INSULIN = LBXIN,
         FAST_TRI = LBXTR,
         ALT = LBXSATSI,
         AST = LBXSASSI,
         BUN = LBXSBU,
         GLU = LBXSGL,
         LDH = LBDSLDSI,
         POTAS = LBXSKSI,
         CHL = LBXSCLSI,
         SODI = LBXSNASI,
         CHOL = LBXSCH,
         TOTPRO = LBXSTP,
         CREATININE = LBDSCR,
         BILIRUBIN= LBDSTB,
         IRON = LBXSIR,
         CALCIUM = LBXSCA,
         BICARBONATE = LBXSC3SI, 
         WTINT2YR = WTINT4YR*2,
         WTMEC2YR = WTMEC4YR*2)%>%
  select(seqn,time,year,age,gender,educ, race_ethn, marital_status,INDFMPIR, family_income, health_insurance, employment_status,
         SDMVPSU,SDMVSTRA,WTINT2YR,WTMEC2YR,WTSAF2YR,
         SY_mean, DI_mean, BMXBMI,BMXWAIST,BMXHT, bpx_metric,bpx_metric_ss,BPXCHR,BPXPLS,BMXWT,WT_DIFF_KG,BMXARMC,
         alcohol_intake,smoking_status,physical_activity,pregnant,lwlstyr, exerc2lwlastyr,walk_bicycle_times_wk,ADD, TWMT, short_breathe,
         overweight, overall_obesity, abdominal_obesity, HBF1,HBF2,
         htn_history, high_chol_history,diab_history, cancer_history, CD_history, first_cd_age,close_relatives_heartattack,close_relatives_diabetes,
         diab_now, htn_now,highchol_now,
         htn_treatment, high_chol_treatment, diab_treatment,aspirin_per, statin_per,acei_per,arb_per,betablocker_per,optimal_regimen_per, 
         LDL,HDL,TOTAL_CHOL,FAST_GLU,HBA1C,FAST_INSULIN,FAST_TRI,ALT,AST,BUN,GLU,LDH,POTAS,CHL,SODI,CHOL,TOTPRO, LBDSCRSI,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         DXDTOPF,DXXLABMD,DXDLAPF, DXXLLBMD, DXDLLPF,DXXRABMD,DXDRAPF , DXXRLBMD ,DXDRLPF , DXDTRBMD ,DXDTRPF,
         DXDLALE,DXDRALE,DXDLLLE,DXDRLLE,DXDTRLE,DXXTRFAT,DXXLAFAT,DXXRAFAT,DXXLLFAT,DXXRLFAT,DXDTOFAT,DXDTOLE,DXDTOBMD,
         IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE, 
         CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226)

## write to csv file
# VO2MAX2001%>% write.csv(paste0(wd_path,'/VO2MAX2001.csv'))



```




## 2003-2004
```{r}
## demographic infos
demo_c <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/DEMO_c.XPT"))%>%
  dplyr::select('SEQN','SDDSRVYR','RIDAGEYR','RIDAGEMN','RIAGENDR','RIDRETH1','DMDEDUC2','DMDEDUC3','DMDMARTL','INDFMPIR','WTINT2YR','WTMEC2YR','SDMVPSU','SDMVSTRA','RIDEXPRG')


## health insurance status
hiq_c <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/HIQ_c.XPT"))%>%
  dplyr::select('SEQN', 'HID010')

## occupation/employment status
ocq_c <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/OCQ_c.XPT"))%>% 
  dplyr::select('SEQN','OCD150','OCQ380')

## diabetes history
diq_c <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/DIQ_c.XPT"))%>% 
  dplyr::select('SEQN', 'DIQ010', 'DIQ050','DIQ070')


## hypertension and cholesterol history 
bpq_c <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/BPQ_c.XPT"))%>%
  dplyr::select('SEQN', 'BPQ020','BPQ050A','BPQ080','BPQ100D')


## bp measurement
bpx_c <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/BPX_c.XPT"))%>% 
  dplyr::select('SEQN','BPXSY1','BPXSY2','BPXSY3','BPXSY4','BPXDI1','BPXDI2','BPXDI3','BPXDI4','BPXCHR','BPXPLS')%>%
  mutate(SY_mean =rowMeans(subset(.,select = c('BPXSY1','BPXSY2','BPXSY3','BPXSY4')), na.rm = TRUE))%>%
  mutate(DI_mean =rowMeans(subset(.,select = c('BPXDI1','BPXDI2','BPXDI3','BPXDI4')), na.rm = TRUE))%>%
  # metric for htn 1: not control
  mutate(bpx_metric = case_when(SY_mean >= 140 | DI_mean >=90 ~ 1,
                                (SY_mean < 140 & DI_mean < 90)~2,
                                (SY_mean < 140 & is.na(DI_mean))~2,
                                (DI_mean < 90 & is.na(SY_mean))~2,
                                TRUE ~ NA_real_))%>%
  # ss stands for sensitivity
  mutate(bpx_metric_ss = case_when(SY_mean >= 130 | DI_mean >=80 ~ 1,
                                (SY_mean < 130 & DI_mean < 80)~2,
                                (SY_mean < 130 & is.na(DI_mean))~2,
                                (DI_mean < 80 & is.na(SY_mean))~2,
                                TRUE ~ NA_real_))%>%
  dplyr::select(SEQN,bpx_metric, bpx_metric_ss, SY_mean, DI_mean,BPXCHR,BPXPLS)




## comorbidities
mcq_c <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/MCQ_c.XPT"))%>% 
  dplyr::select('SEQN', 
                'MCQ160B','MCQ180B',
                'MCQ160C','MCQ180C', ## coronary heart disease and the age first diagnosed
                'MCQ160D','MCQ180D',
                'MCQ160E','MCQ180E', ## heart attack and the age first diagnosed
                'MCQ160F','MCQ180F', ## stroke and the age first diagnosed
                'MCQ220',# MCQ220 cancer
                'MCQ250A','MCQ250F')


## alcohol intake
alq_c <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/ALQ_c.XPT"))%>% 
  dplyr::select('SEQN','ALQ120Q','ALQ120U','ALQ130','ALQ110','ALQ101')%>%
  replace_with_na(replace = list(ALQ120Q = c(777,999),
                                 ALQ120U = c(7,9),
                                 ALQ130 = c(77,99),
                                 ALQ110 = c(7,9),
                                 ALQ101 = c(7,9)))%>%
  ## ADD is the estimate of average daily drinks
  mutate(ADD = case_when(ALQ101 == 2 ~ 0,
                         ALQ110 == 2 ~ 0,
                         ALQ120U == 1 ~ ALQ130*ALQ120Q/7,
                         ALQ120U == 2 ~ ALQ130*ALQ120Q/30,
                         ALQ120U == 3 ~ ALQ130*ALQ120Q/365,
                         TRUE ~ NA_real_))



## smoking status
smq_c1 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/SMQ_C.XPT"))%>% 
  dplyr::select('SEQN','SMQ020', 'SMQ040')

smq_c2 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/SMQMEC_C.XPT"))%>% 
  dplyr::select('SEQN','SMQ620','SMQ680')

smq_c <- smq_c1 %>% full_join(smq_c2, by= 'SEQN')

smq_c$SMQ_HIST <-apply(smq_c,1,function(x){
  if(any(x[2]==2,x[4]==2,na.rm = T)){return ('Never smoker')}
  else if (!any(x[2]==2,x[4]==2,na.rm = T) & any(x[3]%in% c(1,2),x[5]==1,na.rm = T)){return ('Current smoker')}
  else if (any(x[2] ==1,x[4]==1,na.rm = T) & (!x[3] %in% c(1,2) & x[5] %in% c(2))){return ('Former smoker')}
  else if (any(x[2] ==1,x[4]==1,na.rm = T) & (x[3] %in% c(3) & !x[5] %in% c(1))){return ('Former smoker')}
  else {return ('unknown')}
  
})


## physical activity 
paq_c1 <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/PAQIAF_C.XPT"))%>% 
  dplyr::select('SEQN','PADLEVEL', 'PADDURAT','PADTIMES') %>%
  dplyr::group_by(SEQN,)%>% 
  summarise(TWMT = sum(PADDURAT*PADTIMES*PADLEVEL, na.rm =T)/4, .groups = 'drop' )

paq_c2 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/PAQ_C.XPT"))%>% 
  dplyr::select('SEQN','PAD200', 'PAD320','PAD020','PAQ050Q','PAQ050U')

paq_c <- paq_c1 %>% full_join(paq_c2, by= 'SEQN')%>%
  mutate(TWMT = ifelse(PAD200 %in% c(2,3) & PAD320 %in% c(2,3),0,TWMT))

## Weight history
whq_c <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/WHQ_C.XPT"))%>%
  dplyr::select('SEQN','WHD020','WHD050','WHQ070','WHD080D','WHD100D')%>%
  ## convert special code to NA
  replace_with_na(replace = list(WHD020 = c(7777,9999),
                                 WHD050 = c(7777,9999)))%>%
  mutate(WT_DIFF_PB = WHD050 - WHD020)

 

## obsesity metric
bmx_c <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/BMX_c.XPT")) %>%
  dplyr::select('SEQN', 'BMXWAIST','BMXBMI','BMXHT','BMXWT','BMXARMC')

## cardiovascular health
cdq_c <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/CDQ_C.XPT"))%>%
  dplyr::select('SEQN', 'CDQ010')

## prescription
rxq_c <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/RXQ_RX_c.XPT"))



## prescription info join with drugs
rxq_sp_c <- rxq_c %>% left_join(sp_drug, by='RXDDRGID') %>%
  dplyr::group_by(SEQN) %>%
  ## _per means per person
  summarise(acei_per = ifelse(sum(acei, na.rm=T)>0,1,0), 
            betablocker_per =ifelse( sum(betablocker, na.rm=T)>0,1,0), 
            arb_per = ifelse(sum(arb, na.rm=T)>0,1,0), 
            aspirin_per = ifelse(sum(aspirin, na.rm = T)>0,1,0),
            statin_per = ifelse(sum(statin, na.rm = T)>0,1,0),
            anti_platelet_per = ifelse(sum(anti_platelet, na.rm = T)>0,1,0),
            anti_htn_per = ifelse(sum(anti_htn, na.rm = T)>0,1,0),
            anti_hyperlipid_per = ifelse(sum(anti_hyperlipid, na.rm = T)>0,1,0),
            anti_diabetes_per = ifelse(sum(anti_diabetes, na.rm = T)>0,1,0),
            .groups = 'drop' )%>%
  mutate(optimal_regimen_per = rowSums(subset(., select=c(anti_htn_per, anti_hyperlipid_per, anti_platelet_per))))


## pregnancy
rhq_c <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/RHQ_c.XPT"))%>%
  select(SEQN, RHD143)

## total cholesterol 
tchol_c <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/L13_c.XPT")) %>%
  dplyr::select('SEQN', 'LBXTC', 'LBXHDD')


## Glycohemoglobin
ghb_c <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/L10_c.XPT")) %>%
  dplyr::select('SEQN', 'LBXGH')



## Ldl
ldl_c <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/L13AM_C.XPT")) %>%
  dplyr::select('SEQN', 'LBDLDL','LBXTR','WTSAF2YR')


## Fasting glucose
glu_ins_c <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/L10AM_C.XPT")) %>%
  dplyr::select('SEQN', 'WTSAF2YR','LBXGLU','LBXIN')

## FASTING SUBSAMPLE
fast_c <- glu_ins_c %>% 
  full_join(ldl_c, by = c('SEQN','WTSAF2YR'))%>%
  group_by(SEQN)%>%
  summarise_all(mean, na.rm = TRUE,.groups = 'drop' )
  
## BIO PROFILE
biopro_c <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/L40_C.XPT")) %>%
  dplyr::select('SEQN', 'LBXSATSI', 'LBXSASSI', 'LBXSBU','LBXSGL','LBXSLDSI',
                'LBXSKSI','LBXSCLSI','LBXSNASI','LBXSCH','LBXSTP','LBXSTR',
                'LBDSCRSI','LBXSCR',
                'LBXSC3SI','LBXSCA','LBXSIR','LBXSTB'  )




## DXX
dxx_c <- read_xpt(url("https://wwwn.cdc.gov/nchs/data/nhanes/dxa/dxx_c.xpt")) %>% 
  dplyr::select('SEQN', '_MULT_',
                'DXDTOPF','DXDTOBMD',
                'DXXLABMD','DXDLAPF',
                'DXXLLBMD','DXDLLPF',
                'DXXRABMD','DXDRAPF',
                'DXXRLBMD','DXDRLPF',
                'DXDTRBMD','DXDTRPF',
                'DXDLALE','DXDRALE',
                'DXDLLLE','DXDRLLE',
                'DXDTRLE','DXXTRFAT',
                'DXXLAFAT','DXXRAFAT',
                'DXXLLFAT','DXXRLFAT',
                'DXDTOFAT','DXDTOLE',
                'DXDTOBMD')%>%
  rename(MULT = '_MULT_')%>%
  group_by(SEQN)%>%
  summarise(DXDTOPF = median(DXDTOPF,na.rm = T),
            DXDTOBMD = median(DXDTOBMD,na.rm = T),
            DXXLABMD = median(DXXLABMD,na.rm = T),
            DXDLAPF = median(DXDLAPF,na.rm = T),
            DXXLLBMD = median(DXXLLBMD,na.rm = T),
            DXDLLPF = median(DXDLLPF,na.rm = T),
            DXXRABMD = median(DXXRABMD,na.rm = T),
            DXDRAPF = median(DXDRAPF,na.rm = T),
            DXXRLBMD = median(DXXRLBMD,na.rm = T),
            DXDRLPF = median(DXDRLPF,na.rm = T),
            DXDTRBMD = median(DXDTRBMD,na.rm = T),
            DXDTRPF = median(DXDTRPF,na.rm = T),
            DXDLALE = median(DXDLALE,na.rm = T),
            DXDRALE = median(DXDRALE,na.rm = T),
            DXDLLLE = median(DXDLLLE,na.rm = T),
            DXDRLLE = median(DXDRLLE,na.rm = T),
            DXDTRLE = median(DXDTRLE,na.rm = T),
            DXXTRFAT = median(DXXTRFAT,na.rm = T),
            DXXLAFAT = median(DXXLAFAT,na.rm = T),
            DXXRAFAT = median(DXXRAFAT,na.rm = T),
            DXXLLFAT = median(DXXLLFAT,na.rm = T),
            DXXRLFAT = median(DXXRLFAT,na.rm = T),
            DXDTOFAT = median(DXDTOFAT,na.rm = T),
            DXDTOLE = median(DXDTOLE,na.rm = T),
            DXDTOBMD = median(DXDTOBMD,na.rm = T))




diet_c <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/DR1TOT_c.XPT"))%>%
  select(SEQN, DR1DAY,DR1DRSTZ, DR1TKCAL,DR1TPROT,DR1TCARB,DR1TTFAT,DR1TSFAT,DR1TMFAT,DR1TPFAT,
         DR1TCHOL,DR1TFIBE,DR1TVB1,DR1TVB2,DR1TNIAC,DR1TVB6,DR1TFOLA,DR1TVB12,DR1TVC,DR1TATOC,
         DR1TCALC,DR1TPHOS,DR1TMAGN, DR1TIRON,DR1TZINC,DR1TCOPP,DR1TSODI,DR1TPOTA,DR1TSELE,DR1TCAFF,
         DR1TTHEO,DR1TALCO,DR1TMOIS,
         DR1TS040,DR1TS060,DR1TS080,DR1TS100,DR1TS120,DR1TS140,DR1TS160,DR1TS180,
         DR1TM161,DR1TM181,DR1TM201,DR1TM221,
         DR1TP182,DR1TP183,DR1TP184,DR1TP204,DR1TP205,DR1TP225,DR1TP226,
         DR1_300, DR1_320)%>%
  rename(DAY_DIET =  DR1DAY,
         STATUS_DIET=DR1DRSTZ,
         CALORIE_DIET =DR1TKCAL,
         PROTEIN_DIET = DR1TPROT,
         CARB_DIET= DR1TCARB,
         FAT_DIET = DR1TTFAT,
         SFAT_DIET =DR1TSFAT,
         MFAT_DIET = DR1TMFAT,
         PFAT__DIET = DR1TPFAT,
         CHOL_DIET = DR1TCHOL,
         FIBE_DIET = DR1TFIBE,
         VB1_DIET = DR1TVB1,
         VB2_DIET = DR1TVB2,
         NIAC_DIET = DR1TNIAC,
         VB6_DIET = DR1TVB6,
         FOLATE_DIET = DR1TFOLA,
         VB12_DIET = DR1TVB12,
         VC_DIET = DR1TVC,
         VE_DIET = DR1TATOC,
         CALC_DIET= DR1TCALC,
         PHOS_DIET = DR1TPHOS,
         MG_DIET = DR1TMAGN,
         IRON_DIET = DR1TIRON,
         ZINC_DIET = DR1TZINC,
         COPP_DIET = DR1TCOPP,
         SODI_DIET = DR1TSODI,
         POTA_DIET = DR1TPOTA,
         SELE_DIET = DR1TSELE,
         CAFF_DIET = DR1TCAFF,
         THEO_DIET = DR1TTHEO,
         ALCO_DIET = DR1TALCO,
         MOIS_DIET = DR1TMOIS,
         COMPARE = DR1_300, 
         TOTWATER = DR1_320,
         TS040 = DR1TS040,
         TS060 = DR1TS060,
         TS080 = DR1TS080,
         TS100 = DR1TS100,
         TS120 = DR1TS120,
         TS140 = DR1TS140,
         TS160 = DR1TS160,
         TS180 = DR1TS180,
         TM161 = DR1TM161,
         TM181 = DR1TM181,
         TM201 = DR1TM201,
         TM221 = DR1TM221,
         TP182 = DR1TP182,
         TP183 = DR1TP183,
         TP184 = DR1TP184,
         TP204 = DR1TP204,
         TP205 = DR1TP205,
         TP225 = DR1TP225,
         TP226 = DR1TP226)%>%
  mutate(IS_WEEKEND_DIET = ifelse(DAY_DIET %in% c(1,6,7),1,0),## friday, sunday or saturday
         COMPARE_USUAL = ifelse(COMPARE ==1,1,0),
         COMPARE_LESS = ifelse(COMPARE ==2,1,0),
         COMPARE_MORE = ifelse(COMPARE ==3,1,0))%>%
  filter(STATUS_DIET==1)%>%
  dplyr::select(SEQN, IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
                CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226)

## urine content
urine_c <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/L16_C.XPT"))%>%
  dplyr::mutate(albuminuria = (URXUMA/URXUCR)*100)


## combine
comb_c <- demo_c %>% left_join(hiq_c, by='SEQN')%>%  left_join(ocq_c, by='SEQN')%>% left_join(diq_c, by='SEQN')%>%  
  left_join(bpq_c, by='SEQN')%>%left_join(bpx_c, by='SEQN')%>%left_join(mcq_c, by='SEQN')%>% 
  left_join(alq_c, by='SEQN')%>% left_join(smq_c, by='SEQN')%>% left_join(paq_c, by='SEQN')%>% 
  left_join(bmx_c, by='SEQN')%>% left_join(tchol_c, by='SEQN')%>% left_join(ghb_c, by='SEQN')%>% 
  left_join(rxq_sp_c, by='SEQN')%>% left_join(rhq_c, by='SEQN')%>%
  left_join(biopro_c, by='SEQN')%>% left_join(fast_c, by='SEQN')%>%
  left_join(whq_c, by ='SEQN')%>%
  left_join(dxx_c, by = 'SEQN')%>%
  left_join(cdq_c, by = 'SEQN')%>%
  left_join(diet_c, by ='SEQN')%>%
  left_join(urine_c, by ='SEQN')



VO2MAX2003 <- comb_c %>% 
  mutate(seqn = SEQN,
         time = 3,  
         year = '2003',
         age = RIDAGEYR,
         gender = case_when(RIAGENDR == 1 ~ 'Male',
                            RIAGENDR == 2 ~ 'Female',
                            TRUE ~ NA_character_),
         educ = case_when((DMDEDUC3 %in% c(0,1,2,3,4,5,6,7,8,9,10,11,12,55,66))|(DMDEDUC2 %in% c(1,2)) ~ 'Less than high school',
                         (DMDEDUC3 %in% c(13,14))|(DMDEDUC2 == 3) ~ 'High school diploma or GED',
                         (DMDEDUC3 == 15)|(DMDEDUC2 %in% c(4,5)) ~'Greater than high school',
                         TRUE ~ NA_character_),
         race_ethn = case_when( RIDRETH1 %in% c(1,2) ~ 'Hispanic',
                                RIDRETH1 == 3 ~ 'Non-Hispanic White',
                                RIDRETH1 == 4 ~ 'Non-Hispanic Black',
                                TRUE ~ 'Other'),
         marital_status = case_when(DMDMARTL %in% c(1,6) ~ 'married/live with other',
                                     DMDMARTL %in% c(2,3,4,5) ~ 'other',
                                     TRUE ~ NA_character_),
         family_income = case_when(INDFMPIR >=2 ~ 'High/Middle income',
                                    INDFMPIR < 2 ~ 'Low income',
                                    TRUE ~ NA_character_),
         health_insurance = case_when(HID010 == 1 ~ 1L, 
                                       HID010 == 2 ~ 0L,
                                       TRUE ~ NA_integer_),
         employment_status = case_when(OCD150 %in% c(1,2) ~ 'Working',
                                       (OCD150 == 3) ~'Unemployed',
                                       (OCD150==4 & OCQ380 ==5)~'Unemployed',
                                       OCD150 == 4 & OCQ380 %in% c(1,2,3,4,6) ~ 'Not in labor force',
                                        TRUE ~ NA_character_),
         htn_history = case_when(BPQ020 == 1 ~ 1L,
                              BPQ020 == 2 ~ 0L,
                              TRUE ~ NA_integer_),
         htn_treatment = case_when(BPQ050A == 1 | anti_htn_per==1 ~ 1L,
                                   (BPQ050A %in% c(7,9,NA)) & is.na(anti_htn_per)~ NA_integer_,
                              TRUE ~ 0L),
         high_chol_history = case_when(BPQ080 == 1 ~ 1L,
                                    BPQ080 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         high_chol_treatment = case_when(BPQ100D == 1 | anti_hyperlipid_per==1 ~ 1L,
                                         (BPQ100D %in% c(7,9,NA)) & is.na(anti_hyperlipid_per) ~ NA_integer_,
                              TRUE ~ 0L),
         diab_history= case_when(DIQ010 ==1 ~1L,
                              DIQ010 %in% c(2,3) ~ 0L,
                              TRUE ~ NA_integer_),
         diab_treatment = case_when(DIQ050 == 1|DIQ070==1|anti_diabetes_per==1~ 1L,
                                    DIQ050 %in% c(7,9,NA)& DIQ070 %in% c(7,9,NA) & is.na(anti_diabetes_per)~ NA_integer_,
                              TRUE ~ 0L),
         cancer_history = case_when(MCQ220 == 1 ~ 1L,
                                    MCQ220 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         CD_history = case_when(MCQ160B==1|MCQ160C==1|MCQ160D==1|MCQ160E==1|MCQ160F==1 ~ 1L,
                                MCQ160B%in%c(7,9,NA)&MCQ160C%in%c(7,9,NA)&MCQ160D%in%c(7,9,NA)&MCQ160E%in%c(7,9,NA)&MCQ160F%in%c(7,9,NA) ~ NA_integer_,
                              TRUE ~ 0L),
         first_cd_age = case_when(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F) ~ NA_real_,
                                   !(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F))~ pmin(MCQ180B,MCQ180C,MCQ180D,MCQ180E,MCQ180F,na.rm = T)),
         close_relatives_heartattack = case_when(MCQ250F == 1 ~ 1L,
                                    MCQ250F == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         close_relatives_diabetes = case_when(MCQ250A == 1 ~ 1L,
                                    MCQ250A == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         alcohol_intake = case_when(age <20 ~ 'Never drinker',
                                    ALQ110 == 2 ~ 'Never drinker',
                                    ALQ110 == 1 & ADD ==0 ~ 'Former drinker',
                                    ALQ110 == 1 & ALQ101 == 2 ~ 'Former drinker',
                                    ADD>0 & ADD<0.5 ~ 'Light drinker',
                                    ADD>=0.5 & ADD<2.5 & RIAGENDR == 1 ~ 'Moderate drinker',
                                    ADD>=0.5 & ADD<1.5 & RIAGENDR == 2 ~ 'Moderate drinker',
                                    ADD>=2.5 & RIAGENDR == 1 ~ 'Heavier drinker',
                                    ADD>=1.5 & RIAGENDR == 2 ~ 'Heavier drinker',
                                    TRUE ~ NA_character_),
         smoking_status = case_when(SMQ_HIST == 'Never smoker'  ~ 'Never smoker',
                                    SMQ_HIST == 'Former smoker' ~ 'Former smoker',
                                    SMQ_HIST == 'Current smoker' ~ 'Current smoker',
                                     TRUE ~ NA_character_),
         physical_activity = case_when(PAD200 %in% c(2,3) & PAD320 %in% c(2,3) ~ 'Inactive',
                                       TWMT < 10 ~ 'Inactive',
                                       TWMT >= 10 & TWMT < 150 ~ 'Insufficient active',
                                       TWMT >= 150 ~ 'Active',
                                       TRUE ~ NA_character_),
         pregnant = case_when((RHD143 == 1)|(RIDEXPRG==1) ~ 1L,
                               TRUE ~ 0L),
         WT_DIFF_KG = WT_DIFF_PB*0.45359237,
         lwlstyr = case_when(WHQ070 == 1 ~ 1L,
                              WHQ070 == 2 ~ 0L,
                               TRUE ~ NA_integer_),
         exerc2lwlastyr = case_when(WHD080D == 13|WHD100D ==13 ~ 1L,
                                    (is.na(WHD080D) & is.na(WHD100D) & WHQ070 == 1)|(WHQ070 == 2)  ~ 0L,
                                    TRUE ~ NA_integer_),
         coef_toweek = case_when(PAQ050U == 1 ~ 7,
                                 PAQ050U == 2 ~ 1,
                                 PAQ050U == 3 ~ 1/4,
                                 TRUE ~ NA_real_),
         walk_bicycle_times_wk = case_when(PAD020 %in% c(2,3) ~ 0L,
                                           PAD020== 1 ~ as.integer(floor(PAQ050Q*coef_toweek)),
                                           TRUE ~ NA_integer_),
         overweight = case_when(BMXBMI >=25 ~ 1L,
                                BMXBMI < 25 ~ 0L,
                                TRUE ~ NA_integer_),
         overall_obesity = case_when(BMXBMI >=30 ~ 1L,
                                     BMXBMI < 30 ~ 0L,
                                     TRUE ~ NA_integer_),
         abdominal_obesity = case_when(BMXWAIST >= 102 & RIAGENDR == 1 ~ 1L,
                                       BMXWAIST < 102 & RIAGENDR == 1 ~ 0L,
                                       BMXWAIST >= 88 & RIAGENDR == 2~ 1L,
                                       BMXWAIST < 88 & RIAGENDR == 2 ~ 0L,
                                       TRUE~ NA_integer_),
         HBF1 = case_when(DXDTOPF >= 25 & RIAGENDR == 1 ~ 1L,
                         DXDTOPF < 25 & RIAGENDR == 1 ~ 0L,
                         DXDTOPF >= 35 & RIAGENDR == 2 ~ 1L,
                         DXDTOPF < 35 & RIAGENDR == 2 ~ 0L,
                         TRUE~ NA_integer_),
         HBF2 = case_when(DXDTOPF >= 28 & RIAGENDR == 1 ~ 1L,
                         DXDTOPF < 28 & RIAGENDR == 1 ~ 0L,
                         DXDTOPF >= 38 & RIAGENDR == 2 ~ 1L,
                         DXDTOPF < 38 & RIAGENDR == 2 ~ 0L,
                         TRUE~ NA_integer_),
         diab_now = case_when(diab_treatment==1L|LBXGH >=6.5|LBXGLU >=126 ~ 1L, ## oral glu tolerance was added from 2011
                              is.na(diab_treatment)&is.na(LBXGH )&is.na(LBXGLU) ~ NA_integer_,
                              TRUE ~ 0L),
         htn_now = case_when(htn_treatment==1L|SY_mean>=140|DI_mean>=90 ~ 1L,
                             is.na(htn_treatment)&is.na(SY_mean)&is.na(DI_mean) ~ NA_integer_,
                             TRUE ~0L),
         highchol_now = case_when(high_chol_treatment==1L |LBXTC>=240|LBDLDL>=160 ~ 1L,
                                  is.na(high_chol_treatment)&is.na(LBXTC)&is.na(LBDLDL) ~ NA_integer_,
                                  TRUE ~ 0L),
         short_breathe = case_when(CDQ010 ==1 ~ 1L,
                                   TRUE ~ 0L))%>%
  mutate(LDL = LBDLDL,
         HDL = LBXHDD,
         TOTAL_CHOL = LBXTC,
         FAST_GLU = LBXGLU,
         HBA1C = LBXGH,
         FAST_INSULIN = LBXIN,
         FAST_TRI = LBXTR,
         ALT = LBXSATSI,
         AST = LBXSASSI,
         BUN = LBXSBU,
         GLU = LBXSGL,
         LDH = LBXSLDSI,
         POTAS = LBXSKSI,
         CHL = LBXSCLSI,
         SODI = LBXSNASI,
         CHOL = LBXSCH,
         TOTPRO = LBXSTP,
         CREATININE = LBXSCR,
         BILIRUBIN= LBXSTB,
         IRON = LBXSIR,
         CALCIUM = LBXSCA,
         BICARBONATE = LBXSC3SI)%>%
  select(seqn,time,year,age,gender,educ, race_ethn, marital_status,INDFMPIR, family_income, health_insurance, employment_status,
         SDMVPSU,SDMVSTRA,WTINT2YR,WTMEC2YR,WTSAF2YR,
         SY_mean, DI_mean, BMXBMI,BMXWAIST,BMXHT, bpx_metric,bpx_metric_ss,BPXCHR,BPXPLS,BMXWT,WT_DIFF_KG,BMXARMC,
         alcohol_intake,smoking_status,physical_activity,pregnant,lwlstyr, exerc2lwlastyr,walk_bicycle_times_wk,ADD, TWMT, short_breathe,
         overweight, overall_obesity, abdominal_obesity, HBF1,HBF2,
         htn_history, high_chol_history,diab_history, cancer_history, CD_history, first_cd_age,close_relatives_heartattack,close_relatives_diabetes,
         diab_now, htn_now,highchol_now,
         htn_treatment, high_chol_treatment, diab_treatment,aspirin_per, statin_per,acei_per,arb_per,betablocker_per,optimal_regimen_per, 
         LDL,HDL,TOTAL_CHOL,FAST_GLU,HBA1C,FAST_INSULIN,FAST_TRI,ALT,AST,BUN,GLU,LDH,POTAS,CHL,SODI,CHOL,TOTPRO, LBDSCRSI,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         DXDTOPF,DXXLABMD,DXDLAPF, DXXLLBMD, DXDLLPF,DXXRABMD,DXDRAPF , DXXRLBMD ,DXDRLPF , DXDTRBMD ,DXDTRPF,
         DXDLALE,DXDRALE,DXDLLLE,DXDRLLE,DXDTRLE,DXXTRFAT,DXXLAFAT,DXXRAFAT,DXXLLFAT,DXXRLFAT,DXDTOFAT,DXDTOLE,DXDTOBMD,
         IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
                CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226)

## write to csv file
# VO2MAX2003%>% write.csv(paste0(wd_path,'VO2MAX2003.csv'))


```
## 1999-2004 covariates
```{r}
VO2MAX_1999_2004 <- rbind(VO2MAX1999,VO2MAX2001,VO2MAX2003)
VO2MAX_1999_2004 %>% write.csv(paste0(wd_path,'VO2MAX_1999_2004.csv'), row.names = F)

```


## data_preprocessing
## 1999-2004
```{r}
data <- read.csv(paste0(wd_path, '/VO2MAX_1999_2004.csv')) 

data_eligible <- data %>% 
  filter(age >= 16 & age< 50 ) %>%
  filter(pregnant==0 | is.na(pregnant))%>%
  mutate(race_ethn = ifelse(is.na(race_ethn),'Other',race_ethn),
         PAI_binary = ifelse(physical_activity == 'Active',1,0),
         curr_smoker = ifelse(smoking_status == 'Current smoker',1,0),
         agec_l20 = ifelse(age<20,1,0),
         agec_20_29 = ifelse(age<30&age>=20,1,0),
         agec_30_39 = ifelse(age<40&age>=30,1,0),
         agec_40_49 = ifelse(age<50&age>=40,1,0))%>%
  mutate(short_breathe = ifelse(is.na(short_breathe),0,short_breathe))


## cvx data
cvx <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/1999-2000/CVX.XPT"))%>% 
  dplyr::select('SEQN', 'CVDESVO2','CVDVOMAX','CVDFITLV')
cvx_b <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2001-2002/CVX_B.XPT"))%>% 
  dplyr::select('SEQN', 'CVDESVO2','CVDVOMAX','CVDFITLV')
cvx_c<- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2003-2004/CVX_C.XPT"))%>% 
  dplyr::select('SEQN', 'CVDESVO2','CVDVOMAX','CVDFITLV')

cvx_combined <- rbind(cvx, cvx_b, cvx_c) %>%
  rename(seqn = 'SEQN')%>%
  mutate(VO2_IQR = quantile(CVDESVO2,na.rm =T)[4]- quantile(CVDESVO2,na.rm =T)[2],
         VO2_lower = quantile(CVDESVO2,na.rm =T)[2] - 1.5*VO2_IQR,
         VO2_upper = quantile(CVDESVO2,na.rm =T)[4] + 1.5*VO2_IQR) #%>%
  #filter(CVDESVO2 <= VO2_upper & CVDESVO2 >= VO2_lower)


## with missingenss
data_vo2max_all <- data_eligible  %>% 
  filter(CD_history==0 | is.na(CD_history))%>%
  mutate_if(., is.character, factor)%>%
  inner_join(cvx_combined, by = 'seqn') %>%
  mutate(CVDFITLV = CVDFITLV-1,
         CVDFITLV_low = factor(ifelse(CVDFITLV==0,1,0)))%>%
  mutate(ARM_PF = (DXDLAPF+DXDRAPF)/2,
         ARM_BMD = (DXXLABMD + DXXRABMD)/2,
         ARM_LEAN = (DXDLALE+DXDRALE)/2,
         LEG_PF = (DXDLLPF+DXDRLPF)/2,
         LEG_BMD = (DXXLLBMD+DXXRLBMD)/2,
         LEG_LEAN = (DXDLLLE + DXDRLLE)/2,
         TR_PF = DXDTRPF,
         TR_BMD = DXDTRBMD,
         TR_LEAN = DXDTRLE,
         TOTAL_PF = DXDTOPF,
         TOTAL_BMD = DXDTOBMD,
         TOTAL_LEAN = DXDTOLE)%>%
  ## exclude some extreme outliers
  select(age, gender,race_ethn, educ, marital_status,INDFMPIR, family_income, health_insurance, employment_status, smoking_status,marital_status,
         agec_l20,agec_20_29,agec_30_39,agec_40_49,
         htn_history, diab_history,high_chol_history, highchol_now, htn_now, diab_now, WTMEC2YR,WTINT2YR,
         ALT,AST,BUN,GLU,LDH,CHOL, TOTPRO, POTAS, SODI, CHL, HBA1C,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         SY_mean,DI_mean, BMXBMI,BMXWAIST,BPXPLS,BMXWT,BMXHT,alcohol_intake,
         TWMT,physical_activity,WT_DIFF_KG ,lwlstyr,exerc2lwlastyr,walk_bicycle_times_wk,
         CVDESVO2,CVDFITLV, CVDFITLV_low,
         ARM_PF ,ARM_BMD ,ARM_LEAN,LEG_PF,LEG_BMD,LEG_LEAN,TR_PF ,TR_BMD ,TR_LEAN ,TOTAL_PF,TOTAL_BMD,TOTAL_LEAN,
         IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
         CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226)%>%
  filter(!is.na(CVDFITLV_low))

write.csv(data_vo2max_all,paste0(wd_path,'/data_vo2max_all.csv'), row.names = F)

```


## after 2004
### 2005-2006
```{r}
## demographic infos
demo_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/DEMO_d.XPT"))%>%
  dplyr::select('SEQN','SDDSRVYR','RIDAGEYR','RIDAGEMN','RIAGENDR','RIDRETH1','DMDEDUC2','DMDEDUC3','DMDMARTL','INDFMPIR','WTINT2YR','WTMEC2YR','SDMVPSU','SDMVSTRA','RIDEXPRG')


## health insurance status
hiq_d <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/HIQ_d.XPT"))%>%
  dplyr::select('SEQN', 'HIQ011')

## occupation/employment status
ocq_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/OCQ_d.XPT"))%>% 
  dplyr::select('SEQN','OCD150','OCQ380')

## diabetes history
diq_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/DIQ_d.XPT"))%>% 
  dplyr::select('SEQN', 'DIQ010', 'DIQ050','DID070','DIQ080')


## hypertension and cholesterol history 
bpq_d <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/BPQ_d.XPT"))%>%
  dplyr::select('SEQN', 'BPQ020','BPQ050A','BPQ080','BPQ100D')





## bp measurement
bpx_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/BPX_d.XPT"))%>% 
  dplyr::select('SEQN','BPXSY1','BPXSY2','BPXSY3','BPXSY4','BPXDI1','BPXDI2','BPXDI3','BPXDI4','BPXCHR','BPXPLS')%>%
  mutate(SY_mean =rowMeans(subset(.,select = c('BPXSY1','BPXSY2','BPXSY3','BPXSY4')), na.rm = TRUE))%>%
  mutate(DI_mean =rowMeans(subset(.,select = c('BPXDI1','BPXDI2','BPXDI3','BPXDI4')), na.rm = TRUE))%>%
  # metric for htn 1: not control
  mutate(bpx_metric = case_when(SY_mean >= 140 | DI_mean >=90 ~ 1,
                                (SY_mean < 140 & DI_mean < 90)~2,
                                (SY_mean < 140 & is.na(DI_mean))~2,
                                (DI_mean < 90 & is.na(SY_mean))~2,
                                TRUE ~ NA_real_))%>%
  # ss stands for sensitivity
  mutate(bpx_metric_ss = case_when(SY_mean >= 130 | DI_mean >=80 ~ 1,
                                (SY_mean < 130 & DI_mean < 80)~2,
                                (SY_mean < 130 & is.na(DI_mean))~2,
                                (DI_mean < 80 & is.na(SY_mean))~2,
                                TRUE ~ NA_real_))%>%
  dplyr::select(SEQN,bpx_metric, bpx_metric_ss, SY_mean, DI_mean, BPXCHR, BPXPLS)




## comorbidities
mcq_d <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/MCQ_d.XPT"))%>% 
  dplyr::select('SEQN', 
                'MCQ160B','MCQ180B',
                'MCQ160C','MCQ180C', ## coronary heart disease and the age first diagnosed
                'MCQ160D','MCQ180D',
                'MCQ160E','MCQ180E', ## heart attack and the age first diagnosed
                'MCQ160F','MCQ180F', ## stroke and the age first diagnosed
                'MCQ220',# MCQ220 cancer
                'MCQ300A','MCQ300C',
                'MCQ160G')



## alcohol intake
alq_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/ALQ_d.XPT"))%>% 
  dplyr::select('SEQN','ALQ120Q','ALQ120U','ALQ130','ALQ110','ALQ101')%>%
  replace_with_na(replace = list(ALQ120Q = c(777,999),
                                 ALQ120U = c(7,9),
                                 ALQ130 = c(777,999),
                                 ALQ110 = c(7,9),
                                 ALQ101 = c(7,9)))%>%
  ## ADD is the estimate of average daily drinks
  mutate(ADD = case_when(ALQ101 == 2 ~ 0,
                         ALQ110 == 2 ~ 0,
                         ALQ120U == 1 ~ ALQ130*ALQ120Q/7,
                         ALQ120U == 2 ~ ALQ130*ALQ120Q/30,
                         ALQ120U == 3 ~ ALQ130*ALQ120Q/365,
                         TRUE ~ NA_real_))




## smoking status
## two data file regarding smoking in 2005-2006, combine to construct required variable
smq_d1 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/SMQ_d.XPT"))%>% 
  dplyr::select('SEQN','SMQ020', 'SMQ040','SMQ620')

smq_d2 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/SMQRTU_d.XPT"))%>% 
  dplyr::select('SEQN','SMQ680')

smq_d <- smq_d1 %>% full_join(smq_d2, by= 'SEQN')


smq_d$SMQ_HIST <-apply(smq_d,1,function(x){
  if(any(x[2]==2,x[4]%in% c(1,2,3,4,5,6,7),na.rm = T)){return ('Never smoker')}
  else if (!any(x[2]==2,x[4]%in% c(1,2,3,4,5,6,7),na.rm = T) & any(x[3]%in% c(1,2),x[5]==1,na.rm = T)){return ('Current smoker')}
  else if (any(x[2] ==1,x[4]==8,na.rm = T) & (!x[3] %in% c(1,2) & x[5] %in% c(2))){return ('Former smoker')}
  else if (any(x[2] ==1,x[4]==8,na.rm = T) & (x[3] %in% c(3) & !x[5] %in% c(1))){return ('Former smoker')}
  else {return ('unknown')}
  
})



## obsesity metric
bmx_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/BMX_d.XPT")) %>%
  dplyr::select('SEQN', 'BMXWAIST','BMXBMI','BMXHT','BMXWT','BMXARMC')


## total cholesterol 
tchol_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/TCHOL_d.XPT")) %>%
  dplyr::select('SEQN', 'LBXTC')


## Glycohemoglobin
ghb_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/GHB_d.XPT")) %>%
  dplyr::select('SEQN', 'LBXGH')


## hdl
hdl_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/HDL_D.XPT")) %>%
  dplyr::select('SEQN', 'LBDHDD')

## Ldl
ldl_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/TRIGLY_D.XPT")) %>%
  dplyr::select('SEQN', 'LBDLDL','LBXTR', 'WTSAF2YR')

## Fasting glucose
glu_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/GLU_D.XPT")) %>%
  dplyr::select('SEQN', 'LBXGLU','LBXIN')

## prescription
rxq_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/RXQ_RX_d.XPT"))


## BIO PROFILE
biopro_d <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/BIOPRO_D.XPT")) %>%
  dplyr::select('SEQN', 'LBXSATSI', 'LBXSASSI', 'LBXSBU','LBXSGL','LBXSLDSI',
                'LBXSKSI','LBXSCLSI','LBXSNASI','LBXSCH','LBXSTP','LBXSTR','LBDSCRSI','LBXSCR',
                'LBXSC3SI','LBXSCA','LBXSIR','LBXSTB')




## prescription info join with drugs
rxq_sp_d <- rxq_d %>% left_join(sp_drug, by='RXDDRGID') %>%
  dplyr::group_by(SEQN) %>%
  ## _per means per person
  summarise(acei_per = ifelse(sum(acei, na.rm=T)>0,1,0), 
            betablocker_per =ifelse( sum(betablocker, na.rm=T)>0,1,0), 
            arb_per = ifelse(sum(arb, na.rm=T)>0,1,0), 
            aspirin_per = ifelse(sum(aspirin, na.rm = T)>0,1,0),
            statin_per = ifelse(sum(statin, na.rm = T)>0,1,0),
            anti_platelet_per = ifelse(sum(anti_platelet, na.rm = T)>0,1,0),
            anti_htn_per = ifelse(sum(anti_htn, na.rm = T)>0,1,0),
            anti_hyperlipid_per = ifelse(sum(anti_hyperlipid, na.rm = T)>0,1,0),
            anti_diabetes_per = ifelse(sum(anti_diabetes, na.rm = T)>0,1,0),
            .groups = 'drop' )%>%
  mutate(optimal_regimen_per = rowSums(subset(., select=c(anti_htn_per, anti_hyperlipid_per, aspirin_per))))


## pregnancy
rhq_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/RHQ_d.XPT"))%>%
  select(SEQN, RHD143)



## physical activity 
paq_d1 <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/PAQIAF_D.XPT"))%>% 
  dplyr::select('SEQN','PADLEVEL', 'PADDURAT','PADTIMES') %>%
  dplyr::group_by(SEQN,)%>% 
  summarise(TWMT = sum(PADDURAT*PADTIMES*PADLEVEL, na.rm =T)/4, .groups = 'drop' )

paq_d2 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/PAQ_D.XPT"))%>% 
  dplyr::select('SEQN','PAD200', 'PAD320','PAD020','PAQ050Q','PAQ050U')

paq_d <- paq_d1 %>% full_join(paq_d2, by= 'SEQN')




  
## Weight history
whq_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/WHQ_D.XPT"))%>%
  dplyr::select('SEQN','WHD020','WHD050','WHQ070','WHD080D','WHD100D')%>%
  ## convert special code to NA
  replace_with_na(replace = list(WHD020 = c(7777,9999),
                                 WHD050 = c(7777,9999)))%>%
  mutate(WT_DIFF_PB = WHD050 - WHD020)



## urine content
urine_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/ALB_CR_D.XPT"))%>%
  dplyr::mutate(albuminuria = (URXUMS/URXUCR)*100)

##
dxx_d <- read_xpt(url("https://wwwn.cdc.gov/nchs/data/nhanes/dxa/dxx_d.xpt")) %>% 
  dplyr::select('SEQN', '_MULT_',
                'DXDTOPF','DXDTOBMD',
                'DXXLABMD','DXDLAPF',
                'DXXLLBMD','DXDLLPF',
                'DXXRABMD','DXDRAPF',
                'DXXRLBMD','DXDRLPF',
                'DXDTRBMD','DXDTRPF',
                'DXDLALE','DXDRALE',
                'DXDLLLE','DXDRLLE',
                'DXDTRLE','DXXTRFAT',
                'DXXLAFAT','DXXRAFAT',
                'DXXLLFAT','DXXRLFAT',
                'DXDTOFAT','DXDTOLE',
                'DXDTOBMD')%>%
  rename(MULT = '_MULT_')%>%
  group_by(SEQN)%>%
  summarise(DXDTOPF = median(DXDTOPF,na.rm = T),
            DXDTOBMD = median(DXDTOBMD,na.rm = T),
            DXXLABMD = median(DXXLABMD,na.rm = T),
            DXDLAPF = median(DXDLAPF,na.rm = T),
            DXXLLBMD = median(DXXLLBMD,na.rm = T),
            DXDLLPF = median(DXDLLPF,na.rm = T),
            DXXRABMD = median(DXXRABMD,na.rm = T),
            DXDRAPF = median(DXDRAPF,na.rm = T),
            DXXRLBMD = median(DXXRLBMD,na.rm = T),
            DXDRLPF = median(DXDRLPF,na.rm = T),
            DXDTRBMD = median(DXDTRBMD,na.rm = T),
            DXDTRPF = median(DXDTRPF,na.rm = T),
            DXDLALE = median(DXDLALE,na.rm = T),
            DXDRALE = median(DXDRALE,na.rm = T),
            DXDLLLE = median(DXDLLLE,na.rm = T),
            DXDRLLE = median(DXDRLLE,na.rm = T),
            DXDTRLE = median(DXDTRLE,na.rm = T),
            DXXTRFAT = median(DXXTRFAT,na.rm = T),
            DXXLAFAT = median(DXXLAFAT,na.rm = T),
            DXXRAFAT = median(DXXRAFAT,na.rm = T),
            DXXLLFAT = median(DXXLLFAT,na.rm = T),
            DXXRLFAT = median(DXXRLFAT,na.rm = T),
            DXDTOFAT = median(DXDTOFAT,na.rm = T),
            DXDTOLE = median(DXDTOLE,na.rm = T),
            DXDTOBMD = median(DXDTOBMD,na.rm = T))




diet_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/DR1TOT_D.XPT"))%>%
  select(SEQN, DR1DAY,DR1DRSTZ, DR1TKCAL,DR1TPROT,DR1TCARB,DR1TTFAT,DR1TSFAT,DR1TMFAT,DR1TPFAT,
         DR1TCHOL,DR1TFIBE,DR1TVB1,DR1TVB2,DR1TNIAC,DR1TVB6,DR1TFOLA,DR1TVB12,DR1TVC,DR1TATOC,
         DR1TCALC,DR1TPHOS,DR1TMAGN, DR1TIRON,DR1TZINC,DR1TCOPP,DR1TSODI,DR1TPOTA,DR1TSELE,DR1TCAFF,
         DR1TTHEO,DR1TALCO,DR1TMOIS,
         DR1TS040,DR1TS060,DR1TS080,DR1TS100,DR1TS120,DR1TS140,DR1TS160,DR1TS180,
         DR1TM161,DR1TM181,DR1TM201,DR1TM221,
         DR1TP182,DR1TP183,DR1TP184,DR1TP204,DR1TP205,DR1TP225,DR1TP226,
         DR1_300, DR1_320Z)%>%
  rename(DAY_DIET =  DR1DAY,
         STATUS_DIET=DR1DRSTZ,
         CALORIE_DIET =DR1TKCAL,
         PROTEIN_DIET = DR1TPROT,
         CARB_DIET= DR1TCARB,
         FAT_DIET = DR1TTFAT,
         SFAT_DIET =DR1TSFAT,
         MFAT_DIET = DR1TMFAT,
         PFAT__DIET = DR1TPFAT,
         CHOL_DIET = DR1TCHOL,
         FIBE_DIET = DR1TFIBE,
         VB1_DIET = DR1TVB1,
         VB2_DIET = DR1TVB2,
         NIAC_DIET = DR1TNIAC,
         VB6_DIET = DR1TVB6,
         FOLATE_DIET = DR1TFOLA,
         VB12_DIET = DR1TVB12,
         VC_DIET = DR1TVC,
         VE_DIET = DR1TATOC,
         CALC_DIET= DR1TCALC,
         PHOS_DIET = DR1TPHOS,
         MG_DIET = DR1TMAGN,
         IRON_DIET = DR1TIRON,
         ZINC_DIET = DR1TZINC,
         COPP_DIET = DR1TCOPP,
         SODI_DIET = DR1TSODI,
         POTA_DIET = DR1TPOTA,
         SELE_DIET = DR1TSELE,
         CAFF_DIET = DR1TCAFF,
         THEO_DIET = DR1TTHEO,
         ALCO_DIET = DR1TALCO,
         MOIS_DIET = DR1TMOIS,
         COMPARE = DR1_300, 
         TOTWATER = DR1_320Z,
         TS040 = DR1TS040,
         TS060 = DR1TS060,
         TS080 = DR1TS080,
         TS100 = DR1TS100,
         TS120 = DR1TS120,
         TS140 = DR1TS140,
         TS160 = DR1TS160,
         TS180 = DR1TS180,
         TM161 = DR1TM161,
         TM181 = DR1TM181,
         TM201 = DR1TM201,
         TM221 = DR1TM221,
         TP182 = DR1TP182,
         TP183 = DR1TP183,
         TP184 = DR1TP184,
         TP204 = DR1TP204,
         TP205 = DR1TP205,
         TP225 = DR1TP225,
         TP226 = DR1TP226)%>%
  mutate(IS_WEEKEND_DIET = ifelse(DAY_DIET %in% c(1,6,7),1,0),## friday, sunday or saturday
         COMPARE_USUAL = ifelse(COMPARE ==1,1,0),
         COMPARE_LESS = ifelse(COMPARE ==2,1,0),
         COMPARE_MORE = ifelse(COMPARE ==3,1,0))%>%
  filter(STATUS_DIET==1)%>%
  dplyr::select(SEQN, IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
                CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226)


## cardiovascular health
cdq_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/CDQ_D.XPT"))%>%
  dplyr::select('SEQN', 'CDQ010')


## Physical function
pfq_d <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2005-2006/PFQ_d.XPT"))%>%
  dplyr::select('SEQN',
                'PFQ020','PFQ030',
                'PFQ061B','PFQ061C','PFQ061H','PFQ061I',
                'PFQ063A','PFQ063B','PFQ063C','PFQ063D','PFQ063E')%>%
  mutate(adoles_limit1 = ifelse(PFQ020==1,1,0),
         adoles_limit2 = ifelse(PFQ030==1,1,0),
         adult_limit1 = ifelse(PFQ061B%in% c(3,4) | PFQ061C %in% c(3,4) | PFQ061H %in% c(3,4)| PFQ061I %in% c(3,4),1,0),
         adult_limit2 = ifelse(PFQ061B%in% c(2,3,4) | PFQ061C %in% c(2,3,4)| PFQ061H %in% c(2,3,4)| PFQ061I %in% c(2,3,4),1,0))%>%
  mutate(select_prob = ifelse((PFQ063A %in% c(19,21,25))|
                                (PFQ063B %in% c(19,21,25))|
                                (PFQ063C %in% c(19,21,25))|
                                (PFQ063D %in% c(19,21,25))|
                                (PFQ063E %in% c(19,21,25)),1,0))
  

## combine
comb_d <- demo_d %>% left_join(hiq_d, by='SEQN')%>%  left_join(ocq_d, by='SEQN')%>% left_join(diq_d, by='SEQN')%>%  
  left_join(bpq_d, by='SEQN')%>%left_join(bpx_d, by='SEQN')%>%left_join(mcq_d, by='SEQN')%>% 
  left_join(alq_d, by='SEQN')%>% left_join(smq_d, by='SEQN')%>% left_join(paq_d, by='SEQN')%>% 
  left_join(bmx_d, by='SEQN')%>% left_join(tchol_d, by='SEQN')%>% left_join(ghb_d, by='SEQN')%>% 
  left_join(rxq_sp_d, by='SEQN')%>% left_join(rhq_d, by='SEQN')%>% left_join(glu_d, by='SEQN')%>% 
  left_join(ldl_d, by='SEQN')%>% left_join(hdl_d, by='SEQN')%>% left_join(biopro_d, by = 'SEQN') %>%
  left_join(urine_d, by ='SEQN') %>% left_join(whq_d, by ='SEQN')%>%
  left_join(dxx_d, by = 'SEQN')%>%
  left_join(diet_d, by ='SEQN')%>%
  left_join(cdq_d, by ='SEQN')%>%
  left_join(pfq_d, by = 'SEQN')

#sp stands for secondary prevention

VO2MAX2005 <- comb_d %>% 
  mutate(seqn = SEQN,
         time = 4,  
         year = '2005',
         age = RIDAGEYR,
         gender = case_when(RIAGENDR == 1 ~ 'Male',
                            RIAGENDR == 2 ~ 'Female',
                            TRUE ~ NA_character_),
         educ = case_when((DMDEDUC3 %in% c(0,1,2,3,4,5,6,7,8,9,10,11,12,55,66))|(DMDEDUC2 %in% c(1,2)) ~ 'Less than high school',
                         (DMDEDUC3 %in% c(13,14))|(DMDEDUC2 == 3) ~ 'High school diploma or GED',
                         (DMDEDUC3 == 15)|(DMDEDUC2 %in% c(4,5)) ~'Greater than high school',
                         TRUE ~ NA_character_),
         race_ethn = case_when( RIDRETH1 %in% c(1,2) ~ 'Hispanic',
                                RIDRETH1 == 3 ~ 'Non-Hispanic White',
                                RIDRETH1 == 4 ~ 'Non-Hispanic Black',
                                TRUE ~ NA_character_),
         marital_status = case_when(DMDMARTL %in% c(1,6) ~ 'married/live with other',
                                     DMDMARTL %in% c(2,3,4,5) ~ 'other',
                                     TRUE ~ NA_character_),
         family_income = case_when(INDFMPIR >=2 ~ 'High/Middle income',
                                    INDFMPIR < 2 ~ 'Low income',
                                    TRUE ~ NA_character_),
         health_insurance = case_when(HIQ011 == 1 ~ 1L, 
                                       HIQ011 == 2 ~ 0L,
                                       TRUE ~ NA_integer_),
         employment_status = case_when(OCD150 %in% c(1,2) ~ 'Working',
                                       (OCD150 == 3) ~'Unemployed',
                                       (OCD150==4 & OCQ380 ==5)~'Unemployed',
                                       OCD150 == 4 & OCQ380 %in% c(1,2,3,4,6) ~ 'Not in labor force',
                                        TRUE ~ NA_character_),
         htn_history = case_when(BPQ020 == 1 ~ 1L,
                              BPQ020 == 2 ~ 0L,
                              TRUE ~ NA_integer_),
         htn_treatment = case_when(BPQ050A == 1 | anti_htn_per==1 ~ 1L,
                                   (BPQ050A %in% c(7,9,NA)) & is.na(anti_htn_per)~ NA_integer_,
                              TRUE ~ 0L),
         high_chol_history = case_when(BPQ080 == 1 ~ 1L,
                                    BPQ080 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         high_chol_treatment = case_when(BPQ100D == 1 | anti_hyperlipid_per==1 ~ 1L,
                                         (BPQ100D %in% c(7,9,NA)) & is.na(anti_hyperlipid_per) ~ NA_integer_,
                              TRUE ~ 0L),
         diab_history= case_when(DIQ010 ==1 ~1L,
                              DIQ010 %in% c(2,3) ~ 0L,
                              TRUE ~ NA_integer_),
         diab_treatment = case_when(DIQ050 == 1|DID070==1|anti_diabetes_per==1~ 1L,
                                    DIQ050 %in% c(7,9,NA)& DID070 %in% c(7,9,NA) & is.na(anti_diabetes_per)~ NA_integer_,
                              TRUE ~ 0L),
         cancer_history = case_when(MCQ220 == 1 ~ 1L,
                                    MCQ220 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         CD_history = case_when(MCQ160B==1|MCQ160C==1|MCQ160D==1|MCQ160E==1|MCQ160F==1 ~ 1L,
                                MCQ160B%in%c(7,9,NA)&MCQ160C%in%c(7,9,NA)&MCQ160D%in%c(7,9,NA)&MCQ160E%in%c(7,9,NA)&MCQ160F%in%c(7,9,NA) ~ NA_integer_,
                              TRUE ~ 0L),
         first_cd_age = case_when(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F) ~ NA_real_,
                                   !(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F))~ pmin(MCQ180B,MCQ180C,MCQ180D,MCQ180E,MCQ180F,na.rm = T)),
         close_relatives_heartattack = case_when(MCQ300A == 1 ~ 1L,
                                    MCQ300A == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         close_relatives_diabetes = case_when(MCQ300C == 1 ~ 1L,
                                    MCQ300C == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         alcohol_intake = case_when(age <20 ~ 'Never drinker',
                                    ALQ110 == 2 ~ 'Never drinker',
                                    ALQ110 == 1 & ADD ==0 ~ 'Former drinker',
                                    ALQ110 == 1 & ALQ101 == 2 ~ 'Former drinker',
                                    ADD>0 & ADD<0.5 ~ 'Light drinker',
                                    ADD>=0.5 & ADD<2.5 & RIAGENDR == 1 ~ 'Moderate drinker',
                                    ADD>=0.5 & ADD<1.5 & RIAGENDR == 2 ~ 'Moderate drinker',
                                    ADD>=2.5 & RIAGENDR == 1 ~ 'Heavier drinker',
                                    ADD>=1.5 & RIAGENDR == 2 ~ 'Heavier drinker',
                                    TRUE ~ NA_character_),
         smoking_status = case_when(SMQ_HIST == 'Never smoker'  ~ 'Never smoker',
                                    SMQ_HIST == 'Former smoker' ~ 'Former smoker',
                                    SMQ_HIST == 'Current smoker' ~ 'Current smoker',
                                     TRUE ~ NA_character_),
         physical_activity = case_when(PAD200 %in% c(2,3) & PAD320 %in% c(2,3) ~ 'Inactive',
                                       TWMT < 10 ~ 'Inactive',
                                       TWMT >= 10 & TWMT < 150 ~ 'Insufficient active',
                                       TWMT >= 150 ~ 'Active',
                                       TRUE ~ NA_character_),
         pregnant = case_when((RHD143 == 1)|(RIDEXPRG==1) ~ 1L,
                               TRUE ~ 0L),
         WT_DIFF_KG = WT_DIFF_PB*0.45359237,
         lwlstyr = case_when(WHQ070 == 1 ~ 1L,
                              WHQ070 == 2 ~ 0L,
                               TRUE ~ NA_integer_),
         exerc2lwlastyr = case_when(WHD080D == 13|WHD100D ==13 ~ 1L,
                                    (is.na(WHD080D) & is.na(WHD100D) & WHQ070 == 1)|(WHQ070 == 2)  ~ 0L,
                                    TRUE ~ NA_integer_),
         coef_toweek = case_when(PAQ050U == 1 ~ 7,
                                 PAQ050U == 2 ~ 1,
                                 PAQ050U == 3 ~ 1/4,
                                 TRUE ~ NA_real_),
         walk_bicycle_times_wk = case_when(PAD020 %in% c(2,3) ~ 0L,
                                           PAD020== 1 ~ as.integer(floor(PAQ050Q*coef_toweek)),
                                           TRUE ~ NA_integer_),
         overweight = case_when(BMXBMI >=25 ~ 1L,
                                BMXBMI < 25 ~ 0L,
                                TRUE ~ NA_integer_),
         overall_obesity = case_when(BMXBMI >=30 ~ 1L,
                                     BMXBMI < 30 ~ 0L,
                                     TRUE ~ NA_integer_),
         abdominal_obesity = case_when(BMXWAIST >= 102 & RIAGENDR == 1 ~ 1L,
                                       BMXWAIST < 102 & RIAGENDR == 1 ~ 0L,
                                       BMXWAIST >= 88 & RIAGENDR == 2~ 1L,
                                       BMXWAIST < 88 & RIAGENDR == 2 ~ 0L,
                                       TRUE~ NA_integer_),
         HBF1 = case_when(DXDTOPF >= 25 & RIAGENDR == 1 ~ 1L,
                         DXDTOPF < 25 & RIAGENDR == 1 ~ 0L,
                         DXDTOPF >= 35 & RIAGENDR == 2 ~ 1L,
                         DXDTOPF < 35 & RIAGENDR == 2 ~ 0L,
                         TRUE~ NA_integer_),
         HBF2 = case_when(DXDTOPF >= 28 & RIAGENDR == 1 ~ 1L,
                         DXDTOPF < 28 & RIAGENDR == 1 ~ 0L,
                         DXDTOPF >= 38 & RIAGENDR == 2 ~ 1L,
                         DXDTOPF < 38 & RIAGENDR == 2 ~ 0L,
                         TRUE~ NA_integer_),
         diab_now = case_when(diab_treatment==1L|LBXGH >=6.5|LBXGLU >=126 ~ 1L, ## oral glu tolerance was added from 2011
                              is.na(diab_treatment)&is.na(LBXGH )&is.na(LBXGLU) ~ NA_integer_,
                              TRUE ~ 0L),
         htn_now = case_when(htn_treatment==1L|SY_mean>=140|DI_mean>=90 ~ 1L,
                             is.na(htn_treatment)&is.na(SY_mean)&is.na(DI_mean) ~ NA_integer_,
                             TRUE ~0L),
         highchol_now = case_when(high_chol_treatment==1L |LBXTC>=240|LBDLDL>=160 ~ 1L,
                                  is.na(high_chol_treatment)&is.na(LBXTC)&is.na(LBDLDL) ~ NA_integer_,
                                  TRUE ~ 0L),
         short_breathe = case_when(CDQ010 ==1 ~ 1L,
                                   TRUE ~ 0L))%>%
   mutate(LDL = LBDLDL,
         HDL = LBDHDD,
         TOTAL_CHOL = LBXTC,
         FAST_GLU = LBXGLU,
         HBA1C = LBXGH,
         FAST_INSULIN = LBXIN,
         FAST_TRI = LBXTR,
         ALT = LBXSATSI,
         AST = LBXSASSI,
         BUN = LBXSBU,
         GLU = LBXSGL,
         LDH = LBXSLDSI,
         POTAS = LBXSKSI,
         CHL = LBXSCLSI,
         SODI = LBXSNASI,
         CHOL = LBXSCH,
         TOTPRO = LBXSTP,
         CREATININE = LBXSCR,
         BILIRUBIN= LBXSTB,
         IRON = LBXSIR,
         CALCIUM = LBXSCA,
         BICARBONATE = LBXSC3SI)%>%
  select(seqn,time,year,age,gender,educ, race_ethn, marital_status,INDFMPIR, family_income, health_insurance, employment_status,
         SDMVPSU,SDMVSTRA,WTINT2YR,WTMEC2YR,WTSAF2YR,
         SY_mean, DI_mean, BMXBMI,BMXWAIST,BMXHT, bpx_metric,bpx_metric_ss,BPXCHR,BPXPLS,BMXWT,WT_DIFF_KG,BMXARMC,
         alcohol_intake,smoking_status,physical_activity,pregnant,lwlstyr, exerc2lwlastyr,walk_bicycle_times_wk,ADD, TWMT, short_breathe,
         overweight, overall_obesity, abdominal_obesity, HBF1,HBF2,
         htn_history, high_chol_history,diab_history, cancer_history, CD_history, first_cd_age,close_relatives_heartattack,close_relatives_diabetes,
         diab_now, htn_now,highchol_now,
         htn_treatment, high_chol_treatment, diab_treatment,aspirin_per, statin_per,acei_per,arb_per,betablocker_per,optimal_regimen_per, 
         LDL,HDL,TOTAL_CHOL,FAST_GLU,HBA1C,FAST_INSULIN,FAST_TRI,ALT,AST,BUN,GLU,LDH,POTAS,CHL,SODI,CHOL,TOTPRO, LBDSCRSI,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         DXDTOPF,DXXLABMD,DXDLAPF, DXXLLBMD, DXDLLPF,DXXRABMD,DXDRAPF , DXXRLBMD ,DXDRLPF , DXDTRBMD ,DXDTRPF,
         DXDLALE,DXDRALE,DXDLLLE,DXDRLLE,DXDTRLE,DXXTRFAT,DXXLAFAT,DXXRAFAT,DXXLLFAT,DXXRLFAT,DXDTOFAT,DXDTOLE,DXDTOBMD,
         IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
                CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226,
         DIQ080,MCQ160G,adoles_limit1,adoles_limit2,adult_limit1,adult_limit2,select_prob)
         
    
VO2MAX2005_BASIC <- VO2MAX2005 %>%
  select(seqn,time,year,age,gender,educ, race_ethn, marital_status,INDFMPIR, family_income, health_insurance, employment_status,
         SDMVPSU,SDMVSTRA,WTINT2YR,WTMEC2YR,WTSAF2YR,
         SY_mean, DI_mean, BMXBMI,BMXWAIST,BMXHT, bpx_metric,bpx_metric_ss,BPXCHR,BPXPLS,BMXWT,WT_DIFF_KG,BMXARMC,
         alcohol_intake,smoking_status,physical_activity,pregnant,lwlstyr, exerc2lwlastyr,walk_bicycle_times_wk,ADD, TWMT, short_breathe,
         overweight, overall_obesity, abdominal_obesity,
         htn_history, high_chol_history,diab_history, cancer_history, CD_history, first_cd_age,close_relatives_heartattack,close_relatives_diabetes,
         diab_now, htn_now,highchol_now,
         htn_treatment, high_chol_treatment, diab_treatment,aspirin_per, statin_per,acei_per,arb_per,betablocker_per,optimal_regimen_per, 
         LDL,HDL,TOTAL_CHOL,FAST_GLU,HBA1C,FAST_INSULIN,FAST_TRI,ALT,AST,BUN,GLU,LDH,POTAS,CHL,SODI,CHOL,TOTPRO,
         LBDSCRSI,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         DIQ080,MCQ160G,adoles_limit1,adoles_limit2,adult_limit1,adult_limit2,select_prob)
        

## write to csv file
# VO2MAX2005_BASIC %>% write.csv(paste0(wd_path,'/VO2MAX2005_BASIC.csv'))
  



```


### 2007-2008 (basic)
```{r}
## demographic infos
demo_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/DEMO_e.XPT"))%>%
  dplyr::select('SEQN','SDDSRVYR','RIDAGEYR','RIDAGEMN','RIAGENDR','RIDRETH1','DMDEDUC2','DMDEDUC3','DMDMARTL','INDFMPIR','WTINT2YR','WTMEC2YR','SDMVPSU','SDMVSTRA','RIDEXPRG')


## health insurance status
hiq_e <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/HIQ_e.XPT"))%>%
  dplyr::select('SEQN', 'HIQ011')

## occupation/employment status
ocq_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/OCQ_e.XPT"))%>% 
  dplyr::select('SEQN','OCD150','OCQ380')

## diabetes history
diq_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/DIQ_e.XPT"))%>% 
  dplyr::select('SEQN', 'DIQ010', 'DIQ050','DID070','DIQ080')


## hypertension and cholesterol history 
bpq_e <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/BPQ_e.XPT"))%>%
  dplyr::select('SEQN', 'BPQ020','BPQ050A','BPQ080','BPQ100D')





## bp measurement
bpx_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/BPX_e.XPT"))%>% 
  dplyr::select('SEQN','BPXSY1','BPXSY2','BPXSY3','BPXSY4','BPXDI1','BPXDI2','BPXDI3','BPXDI4','BPXCHR','BPXPLS')%>%
  mutate(SY_mean =rowMeans(subset(.,select = c('BPXSY1','BPXSY2','BPXSY3','BPXSY4')), na.rm = TRUE))%>%
  mutate(DI_mean =rowMeans(subset(.,select = c('BPXDI1','BPXDI2','BPXDI3','BPXDI4')), na.rm = TRUE))%>%
  # metric for htn 1: not control
  mutate(bpx_metric = case_when(SY_mean >= 140 | DI_mean >=90 ~ 1,
                                (SY_mean < 140 & DI_mean < 90)~2,
                                (SY_mean < 140 & is.na(DI_mean))~2,
                                (DI_mean < 90 & is.na(SY_mean))~2,
                                TRUE ~ NA_real_))%>%
  # ss stands for sensitivity
  mutate(bpx_metric_ss = case_when(SY_mean >= 130 | DI_mean >=80 ~ 1,
                                (SY_mean < 130 & DI_mean < 80)~2,
                                (SY_mean < 130 & is.na(DI_mean))~2,
                                (DI_mean < 80 & is.na(SY_mean))~2,
                                TRUE ~ NA_real_))%>%
  dplyr::select(SEQN,bpx_metric, bpx_metric_ss, SY_mean, DI_mean, BPXCHR, BPXPLS)




## comorbidities
mcq_e <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/MCQ_e.XPT"))%>% 
  dplyr::select('SEQN', 
                'MCQ160B','MCQ180B',
                'MCQ160C','MCQ180C', ## coronary heart disease and the age first diagnosed
                'MCQ160D','MCQ180D',
                'MCQ160E','MCQ180E', ## heart attack and the age first diagnosed
                'MCQ160F','MCQ180F', ## stroke and the age first diagnosed
                'MCQ220',# MCQ220 cancer
                'MCQ300A','MCQ300C',
                'MCQ160G')


## alcohol intake
alq_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/ALQ_e.XPT"))%>% 
  dplyr::select('SEQN','ALQ120Q','ALQ120U','ALQ130','ALQ110','ALQ101')%>%
  replace_with_na(replace = list(ALQ120Q = c(777,999),
                                 ALQ120U = c(7,9),
                                 ALQ130 = c(777,999),
                                 ALQ110 = c(7,9),
                                 ALQ101 = c(7,9)))%>%
  ## ADD is the estimate of average daily drinks
  mutate(ADD = case_when(ALQ101 == 2 ~ 0,
                         ALQ110 == 2 ~ 0,
                         ALQ120U == 1 ~ ALQ130*ALQ120Q/7,
                         ALQ120U == 2 ~ ALQ130*ALQ120Q/30,
                         ALQ120U == 3 ~ ALQ130*ALQ120Q/365,
                         TRUE ~ NA_real_))




## smoking status
## two data file regarding smoking in 2007-2008, combine to construct required variable
smq_e1 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/SMQ_e.XPT"))%>% 
  dplyr::select('SEQN','SMQ020', 'SMQ040','SMQ620')

smq_e2 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/SMQRTU_e.XPT"))%>%
  dplyr::select('SEQN','SMQ680')

smq_e <- smq_e1 %>% full_join(smq_e2, by= 'SEQN')


smq_e$SMQ_HIST <-apply(smq_e,1,function(x){
  if(any(x[2]==2,x[4]%in% c(1,2,3,4,5,6,7),na.rm = T)){return ('Never smoker')}
  else if (!any(x[2]==2,x[4]%in% c(1,2,3,4,5,6,7),na.rm = T) & any(x[3]%in% c(1,2),x[5]==1,na.rm = T)){return ('Current smoker')}
  else if (any(x[2] ==1,x[4]==8,na.rm = T) & (!x[3] %in% c(1,2) & x[5] %in% c(2))){return ('Former smoker')}
  else if (any(x[2] ==1,x[4]==8,na.rm = T) & (x[3] %in% c(3) & !x[5] %in% c(1))){return ('Former smoker')}
  else {return ('unknown')}
  
})



## obsesity metric
bmx_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/BMX_e.XPT")) %>%
  dplyr::select('SEQN', 'BMXWAIST','BMXBMI','BMXHT','BMXWT','BMXARMC')


## total cholesterol 
tchol_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/TCHOL_e.XPT")) %>%
  dplyr::select('SEQN', 'LBXTC')


## Glycohemoglobin
ghb_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/GHB_e.XPT")) %>%
  dplyr::select('SEQN', 'LBXGH')


## hdl
hdl_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/HDL_e.XPT")) %>%
  dplyr::select('SEQN', 'LBDHDD')

## Ldl
ldl_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/TRIGLY_e.XPT")) %>%
  dplyr::select('SEQN', 'LBDLDL','LBXTR', 'WTSAF2YR')

## Fasting glucose
glu_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/GLU_e.XPT")) %>%
  dplyr::select('SEQN', 'LBXGLU','LBXIN')

## prescription
rxq_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/RXQ_RX_e.XPT"))


## BIO PROFILE
biopro_e <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/BIOPRO_e.XPT")) %>%
  dplyr::select('SEQN', 'LBXSATSI', 'LBXSASSI', 'LBXSBU','LBXSGL','LBXSLDSI',
                'LBXSKSI','LBXSCLSI','LBXSNASI','LBXSCH','LBXSTP','LBXSTR','LBDSCRSI','LBXSCR',
                'LBXSC3SI','LBXSCA','LBXSIR','LBXSTB')




## prescription info join with drugs
rxq_sp_e <- rxq_e %>% left_join(sp_drug, by='RXDDRGID') %>%
  dplyr::group_by(SEQN) %>%
  ## _per means per person
  summarise(acei_per = ifelse(sum(acei, na.rm=T)>0,1,0), 
            betablocker_per =ifelse( sum(betablocker, na.rm=T)>0,1,0), 
            arb_per = ifelse(sum(arb, na.rm=T)>0,1,0), 
            aspirin_per = ifelse(sum(aspirin, na.rm = T)>0,1,0),
            statin_per = ifelse(sum(statin, na.rm = T)>0,1,0),
            anti_platelet_per = ifelse(sum(anti_platelet, na.rm = T)>0,1,0),
            anti_htn_per = ifelse(sum(anti_htn, na.rm = T)>0,1,0),
            anti_hyperlipid_per = ifelse(sum(anti_hyperlipid, na.rm = T)>0,1,0),
            anti_diabetes_per = ifelse(sum(anti_diabetes, na.rm = T)>0,1,0),
            .groups = 'drop' )%>%
  mutate(optimal_regimen_per = rowSums(subset(., select=c(anti_htn_per, anti_hyperlipid_per, aspirin_per))))


## pregnancy
rhq_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/RHQ_e.XPT"))%>%
  select(SEQN, RHD143)



## physical activity 
paq_e <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/PAQ_E.XPT"))%>%
  dplyr::select('SEQN','PAQ650','PAQ665','PAQ655','PAD660','PAQ670','PAD675','PAQ635','PAQ640')%>%
  ## convert special code to NA
  mutate(PAQ670 = ifelse(PAQ670 %in% c(77,99),NA,PAQ670),
         PAD675 = ifelse(PAD675 %in% c(7777,9999),NA,PAD675),
         PAQ655 = ifelse(PAQ655 %in% c(77,99),NA,PAQ655),
         PAD660 = ifelse(PAD660 %in% c(7777,9999),NA,PAD660))%>%
  mutate(moder = PAQ670*PAD675) %>%
  # vigorous-intensity = 2 * moderate-intensity
  mutate(vigor_eq = 2*PAQ655*PAD660)%>%
  ## TWMT stands for total weekly moderate-intensity-exercise time 
  ## TWMT >150 : active, TWMT < 10 :INACTIVE, TMWT in (10,150) : Insufficient active
  mutate(TWMT =rowSums(subset(.,select = c('moder','vigor_eq')), na.rm = T))%>%
  mutate(TWMT = replace(TWMT, is.na(moder)&is.na(vigor_eq), NA))%>%
  mutate(TWMT = ifelse(PAQ650 == 2 & PAQ665 == 2,0,TWMT))
 



## Weight history
whq_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/WHQ_e.XPT"))%>%
  dplyr::select('SEQN','WHD020','WHD050','WHQ070','WHD080D','WHD100D')%>%
  ## convert special code to NA
  replace_with_na(replace = list(WHD020 = c(7777,9999),
                                 WHD050 = c(7777,9999)))%>%
  mutate(WT_DIFF_PB = WHD050 - WHD020)



## urine content
urine_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/ALB_CR_e.XPT"))%>%
  dplyr::mutate(albuminuria = (URXUMS/URXUCR)*100)



diet_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/DR1TOT_e.XPT"))%>%
  select(SEQN, DR1DAY,DR1DRSTZ, DR1TKCAL,DR1TPROT,DR1TCARB,DR1TTFAT,DR1TSFAT,DR1TMFAT,DR1TPFAT,
         DR1TCHOL,DR1TFIBE,DR1TVB1,DR1TVB2,DR1TNIAC,DR1TVB6,DR1TFOLA,DR1TVB12,DR1TVC,DR1TATOC,
         DR1TCALC,DR1TPHOS,DR1TMAGN, DR1TIRON,DR1TZINC,DR1TCOPP,DR1TSODI,DR1TPOTA,DR1TSELE,DR1TCAFF,
         DR1TTHEO,DR1TALCO,DR1TMOIS,
         DR1TS040,DR1TS060,DR1TS080,DR1TS100,DR1TS120,DR1TS140,DR1TS160,DR1TS180,
         DR1TM161,DR1TM181,DR1TM201,DR1TM221,
         DR1TP182,DR1TP183,DR1TP184,DR1TP204,DR1TP205,DR1TP225,DR1TP226,
         DR1_300, DR1_320Z)%>%
  rename(DAY_DIET =  DR1DAY,
         STATUS_DIET=DR1DRSTZ,
         CALORIE_DIET =DR1TKCAL,
         PROTEIN_DIET = DR1TPROT,
         CARB_DIET= DR1TCARB,
         FAT_DIET = DR1TTFAT,
         SFAT_DIET =DR1TSFAT,
         MFAT_DIET = DR1TMFAT,
         PFAT__DIET = DR1TPFAT,
         CHOL_DIET = DR1TCHOL,
         FIBE_DIET = DR1TFIBE,
         VB1_DIET = DR1TVB1,
         VB2_DIET = DR1TVB2,
         NIAC_DIET = DR1TNIAC,
         VB6_DIET = DR1TVB6,
         FOLATE_DIET = DR1TFOLA,
         VB12_DIET = DR1TVB12,
         VC_DIET = DR1TVC,
         VE_DIET = DR1TATOC,
         CALC_DIET= DR1TCALC,
         PHOS_DIET = DR1TPHOS,
         MG_DIET = DR1TMAGN,
         IRON_DIET = DR1TIRON,
         ZINC_DIET = DR1TZINC,
         COPP_DIET = DR1TCOPP,
         SODI_DIET = DR1TSODI,
         POTA_DIET = DR1TPOTA,
         SELE_DIET = DR1TSELE,
         CAFF_DIET = DR1TCAFF,
         THEO_DIET = DR1TTHEO,
         ALCO_DIET = DR1TALCO,
         MOIS_DIET = DR1TMOIS,
         COMPARE = DR1_300, 
         TOTWATER = DR1_320Z,
         TS040 = DR1TS040,
         TS060 = DR1TS060,
         TS080 = DR1TS080,
         TS100 = DR1TS100,
         TS120 = DR1TS120,
         TS140 = DR1TS140,
         TS160 = DR1TS160,
         TS180 = DR1TS180,
         TM161 = DR1TM161,
         TM181 = DR1TM181,
         TM201 = DR1TM201,
         TM221 = DR1TM221,
         TP182 = DR1TP182,
         TP183 = DR1TP183,
         TP184 = DR1TP184,
         TP204 = DR1TP204,
         TP205 = DR1TP205,
         TP225 = DR1TP225,
         TP226 = DR1TP226)%>%
  mutate(IS_WEEKEND_DIET = ifelse(DAY_DIET %in% c(1,6,7),1,0),## friday, sunday or saturday
         COMPARE_USUAL = ifelse(COMPARE ==1,1,0),
         COMPARE_LESS = ifelse(COMPARE ==2,1,0),
         COMPARE_MORE = ifelse(COMPARE ==3,1,0))%>%
  filter(STATUS_DIET==1)%>%
  dplyr::select(SEQN, IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
                CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226)


## cardiovascular health
cdq_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/CDQ_e.XPT"))%>%
  dplyr::select('SEQN', 'CDQ010')


## Physical function
pfq_e <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2007-2008/PFQ_E.XPT"))%>%
  dplyr::select('SEQN',
                'PFQ020','PFQ030',
                'PFQ061B','PFQ061C','PFQ061H','PFQ061I',
                'PFQ063A','PFQ063B','PFQ063C','PFQ063D','PFQ063E')%>%
  mutate(adoles_limit1 = ifelse(PFQ020==1,1,0),
         adoles_limit2 = ifelse(PFQ030==1,1,0),
         adult_limit1 = ifelse(PFQ061B%in% c(3,4) | PFQ061C %in% c(3,4) | PFQ061H %in% c(3,4)| PFQ061I %in% c(3,4),1,0),
         adult_limit2 = ifelse(PFQ061B%in% c(2,3,4) | PFQ061C %in% c(2,3,4)| PFQ061H %in% c(2,3,4)| PFQ061I %in% c(2,3,4),1,0))%>%
  mutate(select_prob = ifelse((PFQ063A %in% c(19,21,25))|
                                (PFQ063B %in% c(19,21,25))|
                                (PFQ063C %in% c(19,21,25))|
                                (PFQ063D %in% c(19,21,25))|
                                (PFQ063E %in% c(19,21,25)),1,0))

## combine
comb_e <- demo_e %>% left_join(hiq_e, by='SEQN')%>%  left_join(ocq_e, by='SEQN')%>% left_join(diq_e, by='SEQN')%>%  
  left_join(bpq_e, by='SEQN')%>%left_join(bpx_e, by='SEQN')%>%left_join(mcq_e, by='SEQN')%>% 
  left_join(alq_e, by='SEQN')%>% left_join(smq_e, by='SEQN')%>% left_join(paq_e, by='SEQN')%>% 
  left_join(bmx_e, by='SEQN')%>% left_join(tchol_e, by='SEQN')%>% left_join(ghb_e, by='SEQN')%>% 
  left_join(rxq_sp_e, by='SEQN')%>% left_join(rhq_e, by='SEQN')%>% left_join(glu_e, by='SEQN')%>% 
  left_join(ldl_e, by='SEQN')%>% left_join(hdl_e, by='SEQN')%>% left_join(biopro_e, by = 'SEQN') %>%
  left_join(urine_e, by ='SEQN') %>% left_join(whq_e, by ='SEQN')%>%
  left_join(diet_e, by ='SEQN')%>%
  left_join(cdq_e, by ='SEQN')%>%
  left_join(pfq_e, by = 'SEQN')

#sp stands for secondary prevention




VO2MAX2007_BASIC <- comb_e %>% 
  mutate(seqn = SEQN,
         time = 5,  
         year = '2007',
         age = RIDAGEYR,
         gender = case_when(RIAGENDR == 1 ~ 'Male',
                            RIAGENDR == 2 ~ 'Female',
                            TRUE ~ NA_character_),
         educ = case_when((DMDEDUC3 %in% c(0,1,2,3,4,5,6,7,8,9,10,11,12,55,66))|(DMDEDUC2 %in% c(1,2)) ~ 'Less than high school',
                         (DMDEDUC3 %in% c(13,14))|(DMDEDUC2 == 3) ~ 'High school diploma or GED',
                         (DMDEDUC3 == 15)|(DMDEDUC2 %in% c(4,5)) ~'Greater than high school',
                         TRUE ~ NA_character_),
         race_ethn = case_when( RIDRETH1 %in% c(1,2) ~ 'Hispanic',
                                RIDRETH1 == 3 ~ 'Non-Hispanic White',
                                RIDRETH1 == 4 ~ 'Non-Hispanic Black',
                                TRUE ~ NA_character_),
         marital_status = case_when(DMDMARTL %in% c(1,6) ~ 'married/live with other',
                                     DMDMARTL %in% c(2,3,4,5) ~ 'other',
                                     TRUE ~ NA_character_),
         family_income = case_when(INDFMPIR >=2 ~ 'High/Middle income',
                                    INDFMPIR < 2 ~ 'Low income',
                                    TRUE ~ NA_character_),
         health_insurance = case_when(HIQ011 == 1 ~ 1L, 
                                       HIQ011 == 2 ~ 0L,
                                       TRUE ~ NA_integer_),
         employment_status = case_when(OCD150 %in% c(1,2) ~ 'Working',
                                       (OCD150 == 3) ~'Unemployed',
                                       (OCD150==4 & OCQ380 ==5)~'Unemployed',
                                       OCD150 == 4 & OCQ380 %in% c(1,2,3,4,6) ~ 'Not in labor force',
                                        TRUE ~ NA_character_),
         htn_history = case_when(BPQ020 == 1 ~ 1L,
                              BPQ020 == 2 ~ 0L,
                              TRUE ~ NA_integer_),
         htn_treatment = case_when(BPQ050A == 1 | anti_htn_per==1 ~ 1L,
                                   (BPQ050A %in% c(7,9,NA)) & is.na(anti_htn_per)~ NA_integer_,
                              TRUE ~ 0L),
         high_chol_history = case_when(BPQ080 == 1 ~ 1L,
                                    BPQ080 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         high_chol_treatment = case_when(BPQ100D == 1 | anti_hyperlipid_per==1 ~ 1L,
                                         (BPQ100D %in% c(7,9,NA)) & is.na(anti_hyperlipid_per) ~ NA_integer_,
                              TRUE ~ 0L),
         diab_history= case_when(DIQ010 ==1 ~1L,
                              DIQ010 %in% c(2,3) ~ 0L,
                              TRUE ~ NA_integer_),
         diab_treatment = case_when(DIQ050 == 1|DID070==1|anti_diabetes_per==1~ 1L,
                                    DIQ050 %in% c(7,9,NA)& DID070 %in% c(7,9,NA) & is.na(anti_diabetes_per)~ NA_integer_,
                              TRUE ~ 0L),
         cancer_history = case_when(MCQ220 == 1 ~ 1L,
                                    MCQ220 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         CD_history = case_when(MCQ160B==1|MCQ160C==1|MCQ160D==1|MCQ160E==1|MCQ160F==1 ~ 1L,
                                MCQ160B%in%c(7,9,NA)&MCQ160C%in%c(7,9,NA)&MCQ160D%in%c(7,9,NA)&MCQ160E%in%c(7,9,NA)&MCQ160F%in%c(7,9,NA) ~ NA_integer_,
                              TRUE ~ 0L),
         first_cd_age = case_when(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F) ~ NA_real_,
                                   !(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F))~ pmin(MCQ180B,MCQ180C,MCQ180D,MCQ180E,MCQ180F,na.rm = T)),
         close_relatives_heartattack = case_when(MCQ300A == 1 ~ 1L,
                                    MCQ300A == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         close_relatives_diabetes = case_when(MCQ300C == 1 ~ 1L,
                                    MCQ300C == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         alcohol_intake = case_when(age <20 ~ 'Never drinker',
                                    ALQ110 == 2 ~ 'Never drinker',
                                    ALQ110 == 1 & ADD ==0 ~ 'Former drinker',
                                    ALQ110 == 1 & ALQ101 == 2 ~ 'Former drinker',
                                    ADD>0 & ADD<0.5 ~ 'Light drinker',
                                    ADD>=0.5 & ADD<2.5 & RIAGENDR == 1 ~ 'Moderate drinker',
                                    ADD>=0.5 & ADD<1.5 & RIAGENDR == 2 ~ 'Moderate drinker',
                                    ADD>=2.5 & RIAGENDR == 1 ~ 'Heavier drinker',
                                    ADD>=1.5 & RIAGENDR == 2 ~ 'Heavier drinker',
                                    TRUE ~ NA_character_),
         smoking_status = case_when(SMQ_HIST == 'Never smoker'  ~ 'Never smoker',
                                    SMQ_HIST == 'Former smoker' ~ 'Former smoker',
                                    SMQ_HIST == 'Current smoker' ~ 'Current smoker',
                                     TRUE ~ NA_character_),
         physical_activity = case_when(PAQ650 == 2 & PAQ665 == 2 ~ 'Inactive',
                                       TWMT < 10 ~ 'Inactive',
                                       TWMT >= 10 & TWMT < 150 ~ 'Insufficient active',
                                       TWMT >= 150 ~ 'Active',
                                       TRUE ~ NA_character_),
         pregnant = case_when((RHD143 == 1)|(RIDEXPRG==1) ~ 1L,
                               TRUE ~ 0L),
         WT_DIFF_KG = WT_DIFF_PB*0.45359237,
         lwlstyr = case_when(WHQ070 == 1 ~ 1L,
                              WHQ070 == 2 ~ 0L,
                               TRUE ~ NA_integer_),
         exerc2lwlastyr = case_when(WHD080D == 13|WHD100D ==13 ~ 1L,
                                    (is.na(WHD080D) & is.na(WHD100D) & WHQ070 == 1)|(WHQ070 == 2)  ~ 0L,
                                    TRUE ~ NA_integer_),
         walk_bicycle_times_wk = case_when(PAQ635 == 2 ~ 0L,
                                           PAQ635 == 1 & PAQ640<20 ~ as.integer(PAQ640),
                                           TRUE ~ NA_integer_),
         overweight = case_when(BMXBMI >=25 ~ 1L,
                                BMXBMI < 25 ~ 0L,
                                TRUE ~ NA_integer_),
         overall_obesity = case_when(BMXBMI >=30 ~ 1L,
                                     BMXBMI < 30 ~ 0L,
                                     TRUE ~ NA_integer_),
         abdominal_obesity = case_when(BMXWAIST >= 102 & RIAGENDR == 1 ~ 1L,
                                       BMXWAIST < 102 & RIAGENDR == 1 ~ 0L,
                                       BMXWAIST >= 88 & RIAGENDR == 2~ 1L,
                                       BMXWAIST < 88 & RIAGENDR == 2 ~ 0L,
                                       TRUE~ NA_integer_),
         diab_now = case_when(diab_treatment==1L|LBXGH >=6.5|LBXGLU >=126 ~ 1L, ## oral glu tolerance was added from 2011
                              is.na(diab_treatment)&is.na(LBXGH )&is.na(LBXGLU) ~ NA_integer_,
                              TRUE ~ 0L),
         htn_now = case_when(htn_treatment==1L|SY_mean>=140|DI_mean>=90 ~ 1L,
                             is.na(htn_treatment)&is.na(SY_mean)&is.na(DI_mean) ~ NA_integer_,
                             TRUE ~0L),
         highchol_now = case_when(high_chol_treatment==1L |LBXTC>=240|LBDLDL>=160 ~ 1L,
                                  is.na(high_chol_treatment)&is.na(LBXTC)&is.na(LBDLDL) ~ NA_integer_,
                                  TRUE ~ 0L),
         short_breathe = case_when(CDQ010 ==1 ~ 1L,
                                   TRUE ~ 0L))%>%
   mutate(LDL = LBDLDL,
         HDL = LBDHDD,
         TOTAL_CHOL = LBXTC,
         FAST_GLU = LBXGLU,
         HBA1C = LBXGH,
         FAST_INSULIN = LBXIN,
         FAST_TRI = LBXTR,
         ALT = LBXSATSI,
         AST = LBXSASSI,
         BUN = LBXSBU,
         GLU = LBXSGL,
         LDH = LBXSLDSI,
         POTAS = LBXSKSI,
         CHL = LBXSCLSI,
         SODI = LBXSNASI,
         CHOL = LBXSCH,
         TOTPRO = LBXSTP,
         CREATININE = LBXSCR,
         BILIRUBIN= LBXSTB,
         IRON = LBXSIR,
         CALCIUM = LBXSCA,
         BICARBONATE = LBXSC3SI)%>%
  select(seqn,time,year,age,gender,educ, race_ethn, marital_status,INDFMPIR, family_income, health_insurance, employment_status,
         SDMVPSU,SDMVSTRA,WTINT2YR,WTMEC2YR,WTSAF2YR,
         SY_mean, DI_mean, BMXBMI,BMXWAIST,BMXHT, bpx_metric,bpx_metric_ss,BPXCHR,BPXPLS,BMXWT,WT_DIFF_KG,BMXARMC,
         alcohol_intake,smoking_status,physical_activity,pregnant,lwlstyr, exerc2lwlastyr,walk_bicycle_times_wk,ADD, TWMT, short_breathe,
         overweight, overall_obesity, abdominal_obesity,
         htn_history, high_chol_history,diab_history, cancer_history, CD_history, first_cd_age,close_relatives_heartattack,close_relatives_diabetes,
         diab_now, htn_now,highchol_now,
         htn_treatment, high_chol_treatment, diab_treatment,aspirin_per, statin_per,acei_per,arb_per,betablocker_per,optimal_regimen_per, 
         LDL,HDL,TOTAL_CHOL,FAST_GLU,HBA1C,FAST_INSULIN,FAST_TRI,ALT,AST,BUN,GLU,LDH,POTAS,CHL,SODI,CHOL,TOTPRO,
         LBDSCRSI,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         DIQ080,MCQ160G,adoles_limit1,adoles_limit2,adult_limit1,adult_limit2,select_prob)
         
    

## write to csv file
## only basic version
#VO2MAX2007_BASIC %>% write.csv(paste0(wd_path,'VO2MAX2007_BASIC.csv'))  

```



### 2009-2010 (basic)
```{r}
## demographic infos
demo_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/DEMO_f.XPT"))%>%
  dplyr::select('SEQN','SDDSRVYR','RIDAGEYR','RIDAGEMN','RIAGENDR','RIDRETH1','DMDEDUC2','DMDEDUC3','DMDMARTL','INDFMPIR','WTINT2YR','WTMEC2YR','SDMVPSU','SDMVSTRA','RIDEXPRG')


## health insurance status
hiq_f <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/HIQ_f.XPT"))%>%
  dplyr::select('SEQN', 'HIQ011')

## occupation/employment status
ocq_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/OCQ_f.XPT"))%>% 
  dplyr::select('SEQN','OCD150','OCQ380')

## diabetes history
diq_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/DIQ_f.XPT"))%>% 
  dplyr::select('SEQN', 'DIQ010', 'DIQ050','DIQ070','DIQ080')


## hypertension and cholesterol history 
bpq_f <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/BPQ_f.XPT"))%>%
  dplyr::select('SEQN', 'BPQ020','BPQ050A','BPQ080','BPQ100D')





## bp measurement
bpx_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/BPX_f.XPT"))%>% 
  dplyr::select('SEQN','BPXSY1','BPXSY2','BPXSY3','BPXSY4','BPXDI1','BPXDI2','BPXDI3','BPXDI4','BPXCHR','BPXPLS')%>%
  mutate(SY_mean =rowMeans(subset(.,select = c('BPXSY1','BPXSY2','BPXSY3','BPXSY4')), na.rm = TRUE))%>%
  mutate(DI_mean =rowMeans(subset(.,select = c('BPXDI1','BPXDI2','BPXDI3','BPXDI4')), na.rm = TRUE))%>%
  # metric for htn 1: not control
  mutate(bpx_metric = case_when(SY_mean >= 140 | DI_mean >=90 ~ 1,
                                (SY_mean < 140 & DI_mean < 90)~2,
                                (SY_mean < 140 & is.na(DI_mean))~2,
                                (DI_mean < 90 & is.na(SY_mean))~2,
                                TRUE ~ NA_real_))%>%
  # ss stands for sensitivity
  mutate(bpx_metric_ss = case_when(SY_mean >= 130 | DI_mean >=80 ~ 1,
                                (SY_mean < 130 & DI_mean < 80)~2,
                                (SY_mean < 130 & is.na(DI_mean))~2,
                                (DI_mean < 80 & is.na(SY_mean))~2,
                                TRUE ~ NA_real_))%>%
  dplyr::select(SEQN,bpx_metric, bpx_metric_ss, SY_mean, DI_mean, BPXCHR, BPXPLS)




## comorbidities
mcq_f <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/MCQ_f.XPT"))%>% 
  dplyr::select('SEQN', 
                'MCQ160B','MCQ180B',
                'MCQ160C','MCQ180C', ## coronary heart disease and the age first diagnosed
                'MCQ160D','MCQ180D',
                'MCQ160E','MCQ180E', ## heart attack and the age first diagnosed
                'MCQ160F','MCQ180F', ## stroke and the age first diagnosed
                'MCQ220',# MCQ220 cancer
                'MCQ300A','MCQ300C',
                'MCQ160G')


## alcohol intake
alq_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/ALQ_f.XPT"))%>% 
  dplyr::select('SEQN','ALQ120Q','ALQ120U','ALQ130','ALQ110','ALQ101')%>%
  replace_with_na(replace = list(ALQ120Q = c(777,999),
                                 ALQ120U = c(7,9),
                                 ALQ130 = c(777,999),
                                 ALQ110 = c(7,9),
                                 ALQ101 = c(7,9)))%>%
  ## ADD is the estimate of average daily drinks
  mutate(ADD = case_when(ALQ101 == 2 ~ 0,
                         ALQ110 == 2 ~ 0,
                         ALQ120U == 1 ~ ALQ130*ALQ120Q/7,
                         ALQ120U == 2 ~ ALQ130*ALQ120Q/30,
                         ALQ120U == 3 ~ ALQ130*ALQ120Q/365,
                         TRUE ~ NA_real_))




## smoking status
## two data file regarding smoking in 2009-2010, combine to construct required variable
smq_f1 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/SMQ_f.XPT"))%>% 
  dplyr::select('SEQN','SMQ020', 'SMQ040','SMQ620')

smq_f2 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/SMQRTU_f.XPT"))%>%
  dplyr::select('SEQN','SMQ680')

smq_f <- smq_f1 %>% full_join(smq_f2, by= 'SEQN')


smq_f$SMQ_HIST <-apply(smq_f,1,function(x){
  if(any(x[2]==2,x[4]%in% c(1,2,3,4,5,6,7),na.rm = T)){return ('Never smoker')}
  else if (!any(x[2]==2,x[4]%in% c(1,2,3,4,5,6,7),na.rm = T) & any(x[3]%in% c(1,2),x[5]==1,na.rm = T)){return ('Current smoker')}
  else if (any(x[2] ==1,x[4]==8,na.rm = T) & (!x[3] %in% c(1,2) & x[5] %in% c(2))){return ('Former smoker')}
  else if (any(x[2] ==1,x[4]==8,na.rm = T) & (x[3] %in% c(3) & !x[5] %in% c(1))){return ('Former smoker')}
  else {return ('unknown')}
  
})



## obsesity metric
bmx_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/BMX_f.XPT")) %>%
  dplyr::select('SEQN', 'BMXWAIST','BMXBMI','BMXHT','BMXWT','BMXARMC')


## total cholesterol 
tchol_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/TCHOL_f.XPT")) %>%
  dplyr::select('SEQN', 'LBXTC')


## Glycohemoglobin
ghb_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/GHB_f.XPT")) %>%
  dplyr::select('SEQN', 'LBXGH')


## hdl
hdl_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/HDL_f.XPT")) %>%
  dplyr::select('SEQN', 'LBDHDD')

## Ldl
ldl_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/TRIGLY_f.XPT")) %>%
  dplyr::select('SEQN', 'LBDLDL','LBXTR', 'WTSAF2YR')

## Fasting glucose
glu_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/GLU_f.XPT")) %>%
  dplyr::select('SEQN', 'LBXGLU','LBXIN')

## prescription
rxq_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/RXQ_RX_f.XPT"))


## BIO PROFILE
biopro_f <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/BIOPRO_f.XPT")) %>%
  dplyr::select('SEQN', 'LBXSATSI', 'LBXSASSI', 'LBXSBU','LBXSGL','LBXSLDSI',
                'LBXSKSI','LBXSCLSI','LBXSNASI','LBXSCH','LBXSTP','LBXSTR','LBDSCRSI','LBXSCR',
                'LBXSC3SI','LBXSCA','LBXSIR','LBXSTB')




## prescription info join with drugs
rxq_sp_f <- rxq_f %>% left_join(sp_drug, by='RXDDRGID') %>%
  dplyr::group_by(SEQN) %>%
  ## _per means per person
  summarise(acei_per = ifelse(sum(acei, na.rm=T)>0,1,0), 
            betablocker_per =ifelse( sum(betablocker, na.rm=T)>0,1,0), 
            arb_per = ifelse(sum(arb, na.rm=T)>0,1,0), 
            aspirin_per = ifelse(sum(aspirin, na.rm = T)>0,1,0),
            statin_per = ifelse(sum(statin, na.rm = T)>0,1,0),
            anti_platelet_per = ifelse(sum(anti_platelet, na.rm = T)>0,1,0),
            anti_htn_per = ifelse(sum(anti_htn, na.rm = T)>0,1,0),
            anti_hyperlipid_per = ifelse(sum(anti_hyperlipid, na.rm = T)>0,1,0),
            anti_diabetes_per = ifelse(sum(anti_diabetes, na.rm = T)>0,1,0),
            .groups = 'drop' )%>%
  mutate(optimal_regimen_per = rowSums(subset(., select=c(anti_htn_per, anti_hyperlipid_per, aspirin_per))))


## pregnancy
rhq_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/RHQ_f.XPT"))%>%
  select(SEQN, RHD143)



## physical activity 
paq_f <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/PAQ_f.XPT"))%>%
  dplyr::select('SEQN','PAQ650','PAQ665','PAQ655','PAD660','PAQ670','PAD675','PAQ635','PAQ640')%>%
  ## convert special code to NA
  mutate(PAQ670 = ifelse(PAQ670 %in% c(77,99),NA,PAQ670),
         PAD675 = ifelse(PAD675 %in% c(7777,9999),NA,PAD675),
         PAQ655 = ifelse(PAQ655 %in% c(77,99),NA,PAQ655),
         PAD660 = ifelse(PAD660 %in% c(7777,9999),NA,PAD660))%>%
  mutate(moder = PAQ670*PAD675) %>%
  # vigorous-intensity = 2 * moderate-intensity
  mutate(vigor_eq = 2*PAQ655*PAD660)%>%
  ## TWMT stands for total weekly moderate-intensity-exercise time 
  ## TWMT >150 : active, TWMT < 10 :INACTIVE, TMWT in (10,150) : Insufficient active
  mutate(TWMT =rowSums(subset(.,select = c('moder','vigor_eq')), na.rm = T))%>%
  mutate(TWMT = replace(TWMT, is.na(moder)&is.na(vigor_eq), NA))%>%
  mutate(TWMT = ifelse(PAQ650 == 2 & PAQ665 == 2,0,TWMT))
 



## Weight history
whq_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/WHQ_f.XPT"))%>%
  dplyr::select('SEQN','WHD020','WHD050','WHQ070','WHD080D','WHD100D')%>%
  ## convert special code to NA
  replace_with_na(replace = list(WHD020 = c(7777,9999),
                                 WHD050 = c(7777,9999)))%>%
  mutate(WT_DIFF_PB = WHD050 - WHD020)



## urine content
urine_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/ALB_CR_f.XPT"))%>%
  dplyr::mutate(albuminuria = (URXUMS/URXUCR)*100)



diet_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/DR1TOT_f.XPT"))%>%
  select(SEQN, DR1DAY,DR1DRSTZ, DR1TKCAL,DR1TPROT,DR1TCARB,DR1TTFAT,DR1TSFAT,DR1TMFAT,DR1TPFAT,
         DR1TCHOL,DR1TFIBE,DR1TVB1,DR1TVB2,DR1TNIAC,DR1TVB6,DR1TFOLA,DR1TVB12,DR1TVC,DR1TATOC,
         DR1TCALC,DR1TPHOS,DR1TMAGN, DR1TIRON,DR1TZINC,DR1TCOPP,DR1TSODI,DR1TPOTA,DR1TSELE,DR1TCAFF,
         DR1TTHEO,DR1TALCO,DR1TMOIS,
         DR1TS040,DR1TS060,DR1TS080,DR1TS100,DR1TS120,DR1TS140,DR1TS160,DR1TS180,
         DR1TM161,DR1TM181,DR1TM201,DR1TM221,
         DR1TP182,DR1TP183,DR1TP184,DR1TP204,DR1TP205,DR1TP225,DR1TP226,
         DR1_300, DR1_320Z)%>%
  rename(DAY_DIET =  DR1DAY,
         STATUS_DIET=DR1DRSTZ,
         CALORIE_DIET =DR1TKCAL,
         PROTEIN_DIET = DR1TPROT,
         CARB_DIET= DR1TCARB,
         FAT_DIET = DR1TTFAT,
         SFAT_DIET =DR1TSFAT,
         MFAT_DIET = DR1TMFAT,
         PFAT__DIET = DR1TPFAT,
         CHOL_DIET = DR1TCHOL,
         FIBE_DIET = DR1TFIBE,
         VB1_DIET = DR1TVB1,
         VB2_DIET = DR1TVB2,
         NIAC_DIET = DR1TNIAC,
         VB6_DIET = DR1TVB6,
         FOLATE_DIET = DR1TFOLA,
         VB12_DIET = DR1TVB12,
         VC_DIET = DR1TVC,
         VE_DIET = DR1TATOC,
         CALC_DIET= DR1TCALC,
         PHOS_DIET = DR1TPHOS,
         MG_DIET = DR1TMAGN,
         IRON_DIET = DR1TIRON,
         ZINC_DIET = DR1TZINC,
         COPP_DIET = DR1TCOPP,
         SODI_DIET = DR1TSODI,
         POTA_DIET = DR1TPOTA,
         SELE_DIET = DR1TSELE,
         CAFF_DIET = DR1TCAFF,
         THEO_DIET = DR1TTHEO,
         ALCO_DIET = DR1TALCO,
         MOIS_DIET = DR1TMOIS,
         COMPARE = DR1_300, 
         TOTWATER = DR1_320Z,
         TS040 = DR1TS040,
         TS060 = DR1TS060,
         TS080 = DR1TS080,
         TS100 = DR1TS100,
         TS120 = DR1TS120,
         TS140 = DR1TS140,
         TS160 = DR1TS160,
         TS180 = DR1TS180,
         TM161 = DR1TM161,
         TM181 = DR1TM181,
         TM201 = DR1TM201,
         TM221 = DR1TM221,
         TP182 = DR1TP182,
         TP183 = DR1TP183,
         TP184 = DR1TP184,
         TP204 = DR1TP204,
         TP205 = DR1TP205,
         TP225 = DR1TP225,
         TP226 = DR1TP226)%>%
  mutate(IS_WEEKEND_DIET = ifelse(DAY_DIET %in% c(1,6,7),1,0),## friday, sunday or saturday
         COMPARE_USUAL = ifelse(COMPARE ==1,1,0),
         COMPARE_LESS = ifelse(COMPARE ==2,1,0),
         COMPARE_MORE = ifelse(COMPARE ==3,1,0))%>%
  filter(STATUS_DIET==1)%>%
  dplyr::select(SEQN, IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
                CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226)


## cardiovascular health
cdq_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/CDQ_f.XPT"))%>%
  dplyr::select('SEQN', 'CDQ010')


## Physical function
pfq_f <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2009-2010/PFQ_f.XPT"))%>%
  dplyr::select('SEQN',
                'PFQ020','PFQ030',
                'PFQ061B','PFQ061C','PFQ061H','PFQ061I',
                'PFQ063A','PFQ063B','PFQ063C','PFQ063D','PFQ063E')%>%
  mutate(adoles_limit1 = ifelse(PFQ020==1,1,0),
         adoles_limit2 = ifelse(PFQ030==1,1,0),
         adult_limit1 = ifelse(PFQ061B%in% c(3,4) | PFQ061C %in% c(3,4) | PFQ061H %in% c(3,4)| PFQ061I %in% c(3,4),1,0),
         adult_limit2 = ifelse(PFQ061B%in% c(2,3,4) | PFQ061C %in% c(2,3,4)| PFQ061H %in% c(2,3,4)| PFQ061I %in% c(2,3,4),1,0))%>%
  mutate(select_prob = ifelse((PFQ063A %in% c(19,21,25))|
                                (PFQ063B %in% c(19,21,25))|
                                (PFQ063C %in% c(19,21,25))|
                                (PFQ063D %in% c(19,21,25))|
                                (PFQ063E %in% c(19,21,25)),1,0))

## combine
comb_f <- demo_f %>% left_join(hiq_f, by='SEQN')%>%  left_join(ocq_f, by='SEQN')%>% left_join(diq_f, by='SEQN')%>%  
  left_join(bpq_f, by='SEQN')%>%left_join(bpx_f, by='SEQN')%>%left_join(mcq_f, by='SEQN')%>% 
  left_join(alq_f, by='SEQN')%>% left_join(smq_f, by='SEQN')%>% left_join(paq_f, by='SEQN')%>% 
  left_join(bmx_f, by='SEQN')%>% left_join(tchol_f, by='SEQN')%>% left_join(ghb_f, by='SEQN')%>% 
  left_join(rxq_sp_f, by='SEQN')%>% left_join(rhq_f, by='SEQN')%>% left_join(glu_f, by='SEQN')%>% 
  left_join(ldl_f, by='SEQN')%>% left_join(hdl_f, by='SEQN')%>% left_join(biopro_f, by = 'SEQN') %>%
  left_join(urine_f, by ='SEQN') %>% left_join(whq_f, by ='SEQN')%>%
  left_join(diet_f, by ='SEQN')%>%
  left_join(cdq_f, by ='SEQN')%>%
  left_join(pfq_f, by = 'SEQN')

#sp stands for secondary prevention

VO2MAX2009_BASIC <- comb_f %>% 
  mutate(seqn = SEQN,
         time = 6,  
         year = '2009',
         age = RIDAGEYR,
         gender = case_when(RIAGENDR == 1 ~ 'Male',
                            RIAGENDR == 2 ~ 'Female',
                            TRUE ~ NA_character_),
         educ = case_when((DMDEDUC3 %in% c(0,1,2,3,4,5,6,7,8,9,10,11,12,55,66))|(DMDEDUC2 %in% c(1,2)) ~ 'Less than high school',
                         (DMDEDUC3 %in% c(13,14))|(DMDEDUC2 == 3) ~ 'High school diploma or GED',
                         (DMDEDUC3 == 15)|(DMDEDUC2 %in% c(4,5)) ~'Greater than high school',
                         TRUE ~ NA_character_),
         race_ethn = case_when( RIDRETH1 %in% c(1,2) ~ 'Hispanic',
                                RIDRETH1 == 3 ~ 'Non-Hispanic White',
                                RIDRETH1 == 4 ~ 'Non-Hispanic Black',
                                TRUE ~ NA_character_),
         marital_status = case_when(DMDMARTL %in% c(1,6) ~ 'married/live with other',
                                     DMDMARTL %in% c(2,3,4,5) ~ 'other',
                                     TRUE ~ NA_character_),
         family_income = case_when(INDFMPIR >=2 ~ 'High/Middle income',
                                    INDFMPIR < 2 ~ 'Low income',
                                    TRUE ~ NA_character_),
         health_insurance = case_when(HIQ011 == 1 ~ 1L, 
                                       HIQ011 == 2 ~ 0L,
                                       TRUE ~ NA_integer_),
         employment_status = case_when(OCD150 %in% c(1,2) ~ 'Working',
                                       (OCD150 == 3) ~'Unemployed',
                                       (OCD150==4 & OCQ380 ==5)~'Unemployed',
                                       OCD150 == 4 & OCQ380 %in% c(1,2,3,4,6) ~ 'Not in labor force',
                                        TRUE ~ NA_character_),
         htn_history = case_when(BPQ020 == 1 ~ 1L,
                              BPQ020 == 2 ~ 0L,
                              TRUE ~ NA_integer_),
         htn_treatment = case_when(BPQ050A == 1 | anti_htn_per==1 ~ 1L,
                                   (BPQ050A %in% c(7,9,NA)) & is.na(anti_htn_per)~ NA_integer_,
                              TRUE ~ 0L),
         high_chol_history = case_when(BPQ080 == 1 ~ 1L,
                                    BPQ080 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         high_chol_treatment = case_when(BPQ100D == 1 | anti_hyperlipid_per==1 ~ 1L,
                                         (BPQ100D %in% c(7,9,NA)) & is.na(anti_hyperlipid_per) ~ NA_integer_,
                              TRUE ~ 0L),
         diab_history= case_when(DIQ010 ==1 ~1L,
                              DIQ010 %in% c(2,3) ~ 0L,
                              TRUE ~ NA_integer_),
         diab_treatment = case_when(DIQ050 == 1|DIQ070==1|anti_diabetes_per==1~ 1L,
                                    DIQ050 %in% c(7,9,NA)& DIQ070 %in% c(7,9,NA) & is.na(anti_diabetes_per)~ NA_integer_,
                              TRUE ~ 0L),
         cancer_history = case_when(MCQ220 == 1 ~ 1L,
                                    MCQ220 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         CD_history = case_when(MCQ160B==1|MCQ160C==1|MCQ160D==1|MCQ160E==1|MCQ160F==1 ~ 1L,
                                MCQ160B%in%c(7,9,NA)&MCQ160C%in%c(7,9,NA)&MCQ160D%in%c(7,9,NA)&MCQ160E%in%c(7,9,NA)&MCQ160F%in%c(7,9,NA) ~ NA_integer_,
                              TRUE ~ 0L),
         first_cd_age = case_when(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F) ~ NA_real_,
                                   !(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F))~ pmin(MCQ180B,MCQ180C,MCQ180D,MCQ180E,MCQ180F,na.rm = T)),
         close_relatives_heartattack = case_when(MCQ300A == 1 ~ 1L,
                                    MCQ300A == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         close_relatives_diabetes = case_when(MCQ300C == 1 ~ 1L,
                                    MCQ300C == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         alcohol_intake = case_when(age <20 ~ 'Never drinker',
                                    ALQ110 == 2 ~ 'Never drinker',
                                    ALQ110 == 1 & ADD ==0 ~ 'Former drinker',
                                    ALQ110 == 1 & ALQ101 == 2 ~ 'Former drinker',
                                    ADD>0 & ADD<0.5 ~ 'Light drinker',
                                    ADD>=0.5 & ADD<2.5 & RIAGENDR == 1 ~ 'Moderate drinker',
                                    ADD>=0.5 & ADD<1.5 & RIAGENDR == 2 ~ 'Moderate drinker',
                                    ADD>=2.5 & RIAGENDR == 1 ~ 'Heavier drinker',
                                    ADD>=1.5 & RIAGENDR == 2 ~ 'Heavier drinker',
                                    TRUE ~ NA_character_),
         smoking_status = case_when(SMQ_HIST == 'Never smoker'  ~ 'Never smoker',
                                    SMQ_HIST == 'Former smoker' ~ 'Former smoker',
                                    SMQ_HIST == 'Current smoker' ~ 'Current smoker',
                                     TRUE ~ NA_character_),
         physical_activity = case_when(PAQ650 == 2 & PAQ665 == 2 ~ 'Inactive',
                                       TWMT < 10 ~ 'Inactive',
                                       TWMT >= 10 & TWMT < 150 ~ 'Insufficient active',
                                       TWMT >= 150 ~ 'Active',
                                       TRUE ~ NA_character_),
         pregnant = case_when((RHD143 == 1 )|(RIDEXPRG==1) ~ 1L,
                               TRUE ~ 0L),
         WT_DIFF_KG = WT_DIFF_PB*0.45359237,
         lwlstyr = case_when(WHQ070 == 1 ~ 1L,
                              WHQ070 == 2 ~ 0L,
                               TRUE ~ NA_integer_),
         exerc2lwlastyr = case_when(WHD080D == 13|WHD100D ==13 ~ 1L,
                                    (is.na(WHD080D) & is.na(WHD100D) & WHQ070 == 1)|(WHQ070 == 2)  ~ 0L,
                                    TRUE ~ NA_integer_),
         walk_bicycle_times_wk = case_when(PAQ635 == 2 ~ 0L,
                                           PAQ635 == 1 & PAQ640<20 ~ as.integer(PAQ640),
                                           TRUE ~ NA_integer_),
         overweight = case_when(BMXBMI >=25 ~ 1L,
                                BMXBMI < 25 ~ 0L,
                                TRUE ~ NA_integer_),
         overall_obesity = case_when(BMXBMI >=30 ~ 1L,
                                     BMXBMI < 30 ~ 0L,
                                     TRUE ~ NA_integer_),
         abdominal_obesity = case_when(BMXWAIST >= 102 & RIAGENDR == 1 ~ 1L,
                                       BMXWAIST < 102 & RIAGENDR == 1 ~ 0L,
                                       BMXWAIST >= 88 & RIAGENDR == 2~ 1L,
                                       BMXWAIST < 88 & RIAGENDR == 2 ~ 0L,
                                       TRUE~ NA_integer_),
         diab_now = case_when(diab_treatment==1L|LBXGH >=6.5|LBXGLU >=126 ~ 1L, ## oral glu tolerance was added from 2011
                              is.na(diab_treatment)&is.na(LBXGH )&is.na(LBXGLU) ~ NA_integer_,
                              TRUE ~ 0L),
         htn_now = case_when(htn_treatment==1L|SY_mean>=140|DI_mean>=90 ~ 1L,
                             is.na(htn_treatment)&is.na(SY_mean)&is.na(DI_mean) ~ NA_integer_,
                             TRUE ~0L),
         highchol_now = case_when(high_chol_treatment==1L |LBXTC>=240|LBDLDL>=160 ~ 1L,
                                  is.na(high_chol_treatment)&is.na(LBXTC)&is.na(LBDLDL) ~ NA_integer_,
                                  TRUE ~ 0L),
         short_breathe = case_when(CDQ010 ==1 ~ 1L,
                                   TRUE ~ 0L))%>%
   mutate(LDL = LBDLDL,
         HDL = LBDHDD,
         TOTAL_CHOL = LBXTC,
         FAST_GLU = LBXGLU,
         HBA1C = LBXGH,
         FAST_INSULIN = LBXIN,
         FAST_TRI = LBXTR,
         ALT = LBXSATSI,
         AST = LBXSASSI,
         BUN = LBXSBU,
         GLU = LBXSGL,
         LDH = LBXSLDSI,
         POTAS = LBXSKSI,
         CHL = LBXSCLSI,
         SODI = LBXSNASI,
         CHOL = LBXSCH,
         TOTPRO = LBXSTP,
         CREATININE = LBXSCR,
         BILIRUBIN= LBXSTB,
         IRON = LBXSIR,
         CALCIUM = LBXSCA,
         BICARBONATE = LBXSC3SI)%>%
  select(seqn,time,year,age,gender,educ, race_ethn, marital_status,INDFMPIR, family_income, health_insurance, employment_status,
         SDMVPSU,SDMVSTRA,WTINT2YR,WTMEC2YR,WTSAF2YR,
         SY_mean, DI_mean, BMXBMI,BMXWAIST,BMXHT, bpx_metric,bpx_metric_ss,BPXCHR,BPXPLS,BMXWT,WT_DIFF_KG,BMXARMC,
         alcohol_intake,smoking_status,physical_activity,pregnant,lwlstyr, exerc2lwlastyr,walk_bicycle_times_wk,ADD, TWMT, short_breathe,
         overweight, overall_obesity, abdominal_obesity,
         htn_history, high_chol_history,diab_history, cancer_history, CD_history, first_cd_age,close_relatives_heartattack,close_relatives_diabetes,
         diab_now, htn_now,highchol_now,
         htn_treatment, high_chol_treatment, diab_treatment,aspirin_per, statin_per,acei_per,arb_per,betablocker_per,optimal_regimen_per, 
         LDL,HDL,TOTAL_CHOL,FAST_GLU,HBA1C,FAST_INSULIN,FAST_TRI,ALT,AST,BUN,GLU,LDH,POTAS,CHL,SODI,CHOL,TOTPRO,
         LBDSCRSI,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         DIQ080,MCQ160G,adoles_limit1,adoles_limit2,adult_limit1,adult_limit2,select_prob)
         
## write to csv file
## only basic version
# VO2MAX2009_BASIC %>% write.csv(paste0(wd_path,'VO2MAX2009_BASIC.csv'))  

```



## 2011-2012
```{r}

## demographic infos
demo_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/DEMO_G.XPT"))%>%
  dplyr::select('SEQN','SDDSRVYR','RIDAGEYR','RIAGENDR','RIDRETH1','RIDRETH3','DMDEDUC2','DMDEDUC3','DMDMARTL','INDFMIN2','INDFMPIR','WTINT2YR','WTMEC2YR','SDMVPSU','SDMVSTRA','RIDEXPRG') 

## health insurance status
hiq_g <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/HIQ_G.XPT"))%>%
  dplyr::select('SEQN', 'HIQ011')

## occupation/employment status
ocq_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/OCQ_G.XPT"))%>% 
  dplyr::select('SEQN','OCD150','OCQ380')

## diabetes history
diq_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/DIQ_G.XPT"))%>% 
  dplyr::select('SEQN', 'DIQ010', 'DIQ050','DIQ070','DIQ080')


## hypertension and cholesterol history 
bpq_g <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/BPQ_G.XPT"))%>%
  dplyr::select('SEQN', 'BPQ020','BPQ050A','BPQ080','BPQ100D')


## bp measurement
bpx_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/BPX_G.XPT"))%>% 
  dplyr::select('SEQN','BPXSY1','BPXSY2','BPXSY3','BPXSY4','BPXDI1','BPXDI2','BPXDI3','BPXDI4','BPXCHR','BPXPLS')%>%
  mutate(SY_mean =rowMeans(subset(.,select = c('BPXSY1','BPXSY2','BPXSY3','BPXSY4')), na.rm = TRUE))%>%
  mutate(DI_mean =rowMeans(subset(.,select = c('BPXDI1','BPXDI2','BPXDI3','BPXDI4')), na.rm = TRUE))%>%
  # metric for htn 1: not control
  mutate(bpx_metric = case_when(SY_mean >= 140 | DI_mean >=90 ~ 1,
                                (SY_mean < 140 & DI_mean < 90)~0,
                                (SY_mean < 140 & is.na(DI_mean))~0,
                                (DI_mean < 90 & is.na(SY_mean))~0,
                                TRUE ~ NA_real_))%>%
  # ss stands for sensitivity
  mutate(bpx_metric_ss = case_when(SY_mean >= 130 | DI_mean >=80 ~ 1,
                                (SY_mean < 130 & DI_mean < 80)~0,
                                (SY_mean < 130 & is.na(DI_mean))~0,
                                (DI_mean < 80 & is.na(SY_mean))~0,
                                TRUE ~ NA_real_))%>%
  dplyr::select(SEQN,bpx_metric, bpx_metric_ss, SY_mean, DI_mean,BPXCHR,BPXPLS)




## comorbidities
mcq_g <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/MCQ_G.XPT"))%>% 
   dplyr::select('SEQN', 
                'MCQ160B','MCQ180B',
                'MCQ160C','MCQ180C', ## coronary heart disease and the age first diagnosed
                'MCQ160D','MCQ180D',
                'MCQ160E','MCQ180E', ## heart attack and the age first diagnosed
                'MCQ160F','MCQ180F', ## stroke and the age first diagnosed
                'MCQ220',# MCQ220 cancer
                'MCQ300C','MCQ300A',
                'MCQ160G') 


## alcohol intake
alq_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/ALQ_G.XPT"))%>% 
  dplyr::select('SEQN','ALQ120Q','ALQ120U','ALQ130','ALQ110','ALQ101')%>%
  replace_with_na(replace = list(ALQ120Q = c(777,999),
                                 ALQ120U = c(7,9),
                                 ALQ130 = c(777,999),
                                 ALQ110 = c(7,9),
                                 ALQ101 = c(7,9)))%>%
  ## ADD is the estimate of average daily drinks
  mutate(ADD = case_when(ALQ101 == 2 ~ 0,
                         ALQ110 == 2 ~ 0,
                         ALQ120U == 1 ~ ALQ130*ALQ120Q/7,
                         ALQ120U == 2 ~ ALQ130*ALQ120Q/30,
                         ALQ120U == 3 ~ ALQ130*ALQ120Q/365,
                         TRUE ~ NA_real_))


## smoking status
## two data file regarding smoking in 2011-2012, combine to construct required variable
smq_g1 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/SMQ_G.XPT"))%>% 
  dplyr::select('SEQN','SMQ020', 'SMQ040','SMQ621')

smq_g2 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/SMQRTU_G.XPT"))%>% 
  dplyr::select('SEQN','SMQ680')

smq_g <- smq_g1 %>% full_join(smq_g2, by= 'SEQN')


smq_g$SMQ_HIST <-apply(smq_g,1,function(x){
  if(any(x[2]==2,x[4]%in% c(1,2,3,4,5,6,7),na.rm = T)){return ('Never smoker')}
  else if (!any(x[2]==2,x[4]%in% c(1,2,3,4,5,6,7),na.rm = T) & any(x[3]%in% c(1,2),x[5]==1,na.rm = T)){return ('Current smoker')}
  else if (any(x[2] ==1,x[4]==8,na.rm = T) & (!x[3] %in% c(1,2) & x[5] %in% c(2))){return ('Former smoker')}
  else if (any(x[2] ==1,x[4]==8,na.rm = T) & (x[3] %in% c(3) & !x[5] %in% c(1))){return ('Former smoker')}
  else {return ('unknown')}
  
})




## physical activity 
paq_g <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/PAQ_G.XPT"))%>%
  dplyr::select('SEQN','PAQ650','PAQ665','PAQ655','PAD660','PAQ670','PAD675','PAQ635','PAQ640')%>%
  ## convert special code to NA
  mutate(PAQ670 = ifelse(PAQ670 %in% c(77,99),NA,PAQ670),
         PAD675 = ifelse(PAD675 %in% c(7777,9999),NA,PAD675),
         PAQ655 = ifelse(PAQ655 %in% c(77,99),NA,PAQ655),
         PAD660 = ifelse(PAD660 %in% c(7777,9999),NA,PAD660))%>%
  mutate(moder = PAQ670*PAD675) %>%
  # vigorous-intensity = 2 * moderate-intensity
  mutate(vigor_eq = 2*PAQ655*PAD660)%>%
  ## TWMT stands for total weekly moderate-intensity-exercise time 
  ## TWMT >150 : active, TWMT < 10 :INACTIVE, TMWT in (10,150) : Insufficient active
  mutate(TWMT =rowSums(subset(.,select = c('moder','vigor_eq')), na.rm = T))%>%
  mutate(TWMT = replace(TWMT, is.na(moder)&is.na(vigor_eq), NA))%>%
  mutate(TWMT = ifelse(PAQ650 == 2 & PAQ665 == 2,0,TWMT))
 


## Physical function
pfq_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/PFQ_G.XPT"))%>%
  dplyr::select('SEQN',
                'PFQ020','PFQ030',
                'PFQ061B','PFQ061C','PFQ061H','PFQ061I',
                'PFQ063A','PFQ063B','PFQ063C','PFQ063D','PFQ063E')%>%
  mutate(adoles_limit1 = ifelse(PFQ020==1,1,0),
         adoles_limit2 = ifelse(PFQ030==1,1,0),
         adult_limit1 = ifelse(PFQ061B%in% c(3,4) | PFQ061C %in% c(3,4) | PFQ061H %in% c(3,4)| PFQ061I %in% c(3,4),1,0),
         adult_limit2 = ifelse(PFQ061B%in% c(2,3,4) | PFQ061C %in% c(2,3,4)| PFQ061H %in% c(2,3,4)| PFQ061I %in% c(2,3,4),1,0))%>%
  mutate(select_prob = ifelse((PFQ063A %in% c(19,21,25))|
                                (PFQ063B %in% c(19,21,25))|
                                (PFQ063C %in% c(19,21,25))|
                                (PFQ063D %in% c(19,21,25))|
                                (PFQ063E %in% c(19,21,25)),1,0))


# 
# sum((pfq_g$adoles_limit1|pfq_g$adult_limit1), na.rm = T)
# sum((pfq_g$adoles_limit2|pfq_g$adult_limit2), na.rm = T)
# sum((pfq_g$adoles_limit1|pfq_g$adult_limit1)&(pfq_g$select_prob), na.rm=T)
# sum((pfq_g$adoles_limit2|pfq_g$adult_limit2)&(pfq_g$select_prob), na.rm=T)





  
## Weight history
whq_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/WHQ_G.XPT"))%>%
  dplyr::select('SEQN','WHD020','WHD050','WHQ070','WHD080D','WHD100D')%>%
  ## convert special code to NA
  replace_with_na(replace = list(WHD020 = c(7777,9999),
                                 WHD050 = c(7777,9999)))%>%
  mutate(WT_DIFF_PB = WHD050 - WHD020)




## obsesity metric
bmx_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/BMX_G.XPT")) %>%
  dplyr::select('SEQN', 'BMXWAIST','BMXBMI','BMXHT','BMXWT','BMXARMC')

## cardiovascular health
cdq_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/CDQ_G.XPT"))%>%
  dplyr::select('SEQN', 'CDQ010')

## total cholesterol 
tchol_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/TCHOL_G.XPT")) %>%
  dplyr::select('SEQN', 'LBXTC')


## Glycohemoglobin
ghb_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/GHB_G.XPT")) %>%
  dplyr::select('SEQN', 'LBXGH')


## hdl
hdl_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/HDL_G.XPT")) %>%
  dplyr::select('SEQN', 'LBDHDD')

## Ldl
ldl_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/TRIGLY_G.XPT")) %>%
  dplyr::select('SEQN', 'LBXTR','LBDLDL','WTSAF2YR')

## Fasting glucose
glu_ins_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/GLU_G.XPT")) %>%
  dplyr::select('SEQN', 'LBXGLU', 'LBXIN','WTSAF2YR')


## FASTING SUBSAMPLE
fast_g <- glu_ins_g %>% 
  full_join(ldl_g, by = c('SEQN','WTSAF2YR'))
  

## BIO PROFILE
biopro_g <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/BIOPRO_G.XPT")) %>%
  dplyr::select('SEQN', 'LBXSATSI', 'LBXSASSI', 'LBXSBU','LBXSGL','LBXSLDSI',
                'LBXSKSI','LBXSCLSI','LBXSNASI','LBXSCH','LBXSTP','LBXSTR','LBDSCRSI','LBXSCR',
                'LBXSC3SI','LBXSCA','LBXSIR','LBXSTB')


## prescription
rxq_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/RXQ_RX_g.XPT"))



## prescription info join with drugs
rxq_sp_g <- rxq_g %>% left_join(sp_drug, by='RXDDRGID') %>%
  dplyr::group_by(SEQN) %>%
  ## _per means per person
  summarise(acei_per = ifelse(sum(acei, na.rm=T)>0,1,0), 
            betablocker_per =ifelse( sum(betablocker, na.rm=T)>0,1,0), 
            arb_per = ifelse(sum(arb, na.rm=T)>0,1,0), 
            aspirin_per = ifelse(sum(aspirin, na.rm = T)>0,1,0),
            statin_per = ifelse(sum(statin, na.rm = T)>0,1,0),
            anti_platelet_per = ifelse(sum(anti_platelet, na.rm = T)>0,1,0),
            anti_htn_per = ifelse(sum(anti_htn, na.rm = T)>0,1,0),
            anti_hyperlipid_per = ifelse(sum(anti_hyperlipid, na.rm = T)>0,1,0),
            anti_diabetes_per = ifelse(sum(anti_diabetes, na.rm = T)>0,1,0),
            .groups = 'drop' )%>%
  mutate(optimal_regimen_per = rowSums(subset(., select=c(anti_htn_per, anti_hyperlipid_per, anti_platelet_per))))


## pregnancy
rhq_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/RHQ_G.XPT"))%>%
  select(SEQN, RHD143)



## DXX

dxx_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/DXX_G.XPT")) %>% 
  dplyr::select('SEQN', 
                'DXDTOPF','DXDTOBMD',
                'DXXLABMD','DXDLAPF',
                'DXXLLBMD','DXDLLPF',
                'DXXRABMD','DXDRAPF',
                'DXXRLBMD','DXDRLPF',
                'DXDTRBMD','DXDTRPF',
                'DXDLALE','DXDRALE',
                'DXDLLLE','DXDRLLE',
                'DXDTRLE','DXXTRFAT',
                'DXXLAFAT','DXXRAFAT',
                'DXXLLFAT','DXXRLFAT',
                'DXDTOFAT','DXDTOLE',
                'DXDTOBMD')




diet_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/DR1TOT_G.XPT"))%>%
  select(SEQN, DR1DAY,DR1DRSTZ, DR1TKCAL,DR1TPROT,DR1TCARB,DR1TTFAT,DR1TSFAT,DR1TMFAT,DR1TPFAT,
         DR1TCHOL,DR1TFIBE,DR1TVB1,DR1TVB2,DR1TNIAC,DR1TVB6,DR1TFOLA,DR1TVB12,DR1TVC,DR1TATOC,
         DR1TCALC,DR1TPHOS,DR1TMAGN, DR1TIRON,DR1TZINC,DR1TCOPP,DR1TSODI,DR1TPOTA,DR1TSELE,DR1TCAFF,
         DR1TTHEO,DR1TALCO,DR1TMOIS,
         DR1TS040,DR1TS060,DR1TS080,DR1TS100,DR1TS120,DR1TS140,DR1TS160,DR1TS180,
         DR1TM161,DR1TM181,DR1TM201,DR1TM221,
         DR1TP182,DR1TP183,DR1TP184,DR1TP204,DR1TP205,DR1TP225,DR1TP226,
         DR1_300, DR1_320Z)%>%
  rename(DAY_DIET =  DR1DAY,
         STATUS_DIET=DR1DRSTZ,
         CALORIE_DIET =DR1TKCAL,
         PROTEIN_DIET = DR1TPROT,
         CARB_DIET= DR1TCARB,
         FAT_DIET = DR1TTFAT,
         SFAT_DIET =DR1TSFAT,
         MFAT_DIET = DR1TMFAT,
         PFAT__DIET = DR1TPFAT,
         CHOL_DIET = DR1TCHOL,
         FIBE_DIET = DR1TFIBE,
         VB1_DIET = DR1TVB1,
         VB2_DIET = DR1TVB2,
         NIAC_DIET = DR1TNIAC,
         VB6_DIET = DR1TVB6,
         FOLATE_DIET = DR1TFOLA,
         VB12_DIET = DR1TVB12,
         VC_DIET = DR1TVC,
         VE_DIET = DR1TATOC,
         CALC_DIET= DR1TCALC,
         PHOS_DIET = DR1TPHOS,
         MG_DIET = DR1TMAGN,
         IRON_DIET = DR1TIRON,
         ZINC_DIET = DR1TZINC,
         COPP_DIET = DR1TCOPP,
         SODI_DIET = DR1TSODI,
         POTA_DIET = DR1TPOTA,
         SELE_DIET = DR1TSELE,
         CAFF_DIET = DR1TCAFF,
         THEO_DIET = DR1TTHEO,
         ALCO_DIET = DR1TALCO,
         MOIS_DIET = DR1TMOIS,
         COMPARE = DR1_300, 
         TOTWATER = DR1_320Z,
         TS040 = DR1TS040,
         TS060 = DR1TS060,
         TS080 = DR1TS080,
         TS100 = DR1TS100,
         TS120 = DR1TS120,
         TS140 = DR1TS140,
         TS160 = DR1TS160,
         TS180 = DR1TS180,
         TM161 = DR1TM161,
         TM181 = DR1TM181,
         TM201 = DR1TM201,
         TM221 = DR1TM221,
         TP182 = DR1TP182,
         TP183 = DR1TP183,
         TP184 = DR1TP184,
         TP204 = DR1TP204,
         TP205 = DR1TP205,
         TP225 = DR1TP225,
         TP226 = DR1TP226)%>%
  mutate(IS_WEEKEND_DIET = ifelse(DAY_DIET %in% c(1,6,7),1,0),## friday, sunday or saturday
         COMPARE_USUAL = ifelse(COMPARE ==1,1,0),
         COMPARE_LESS = ifelse(COMPARE ==2,1,0),
         COMPARE_MORE = ifelse(COMPARE ==3,1,0))%>%
  filter(STATUS_DIET==1)%>%
  dplyr::select(SEQN, IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
                CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226)



## urine content
urine_g <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2011-2012/ALB_CR_G.XPT"))%>%
  dplyr::mutate(albuminuria = (URXUMS/URXUCR)*100)

## combine
comb_g <- demo_g %>% left_join(hiq_g, by='SEQN')%>%  left_join(ocq_g, by='SEQN')%>% left_join(diq_g, by='SEQN')%>%  
  left_join(bpq_g, by='SEQN')%>%left_join(bpx_g, by='SEQN')%>%left_join(mcq_g, by='SEQN')%>% 
  left_join(alq_g, by='SEQN')%>% left_join(smq_g, by='SEQN')%>% left_join(paq_g, by='SEQN')%>% 
  left_join(bmx_g, by='SEQN')%>% left_join(tchol_g, by='SEQN')%>% left_join(ghb_g, by='SEQN')%>% 
  left_join(rxq_sp_g, by='SEQN')%>% left_join(rhq_g, by='SEQN')%>%left_join(hdl_g, by = 'SEQN')%>%
  left_join(fast_g, by = 'SEQN')%>% 
  left_join(biopro_g, by = 'SEQN')%>%
  left_join(pfq_g, by = 'SEQN')%>%
  left_join(whq_g, by = 'SEQN')%>%
  left_join(dxx_g, by = 'SEQN')%>%
  left_join(cdq_g, by = 'SEQN')%>%
  left_join(diet_g, by = 'SEQN')%>%
  left_join(urine_g, by = 'SEQN')



#sp stands for secondary prevention

VO2MAX2011 <- comb_g %>% 
  mutate(seqn = SEQN,
         time = 7,  
         year = '2011',
         age = RIDAGEYR,
         gender = case_when(RIAGENDR == 1 ~ 'Male',
                            RIAGENDR == 2 ~ 'Female',
                            TRUE ~ NA_character_),
         educ = case_when((DMDEDUC3 %in% c(0,1,2,3,4,5,6,7,8,9,10,11,12,55,66))|(DMDEDUC2 %in% c(1,2)) ~ 'Less than high school',
                         (DMDEDUC3 %in% c(13,14))|(DMDEDUC2 == 3) ~ 'High school diploma or GED',
                         (DMDEDUC3 == 15)|(DMDEDUC2 %in% c(4,5)) ~'Greater than high school',
                         TRUE ~ NA_character_),
         race_ethn = case_when( RIDRETH3 %in% c(1,2) ~ 'Hispanic',
                                RIDRETH3 == 3 ~ 'Non-Hispanic White',
                                RIDRETH3 == 4 ~ 'Non-Hispanic Black',
                                TRUE ~ 'Other'),
         race_ethn2 = case_when( RIDRETH3 %in% c(1,2) ~ 'Hispanic',
                                RIDRETH3 == 3 ~ 'Non-Hispanic White',
                                RIDRETH3 == 4 ~ 'Non-Hispanic Black',
                                RIDRETH3 == 6 ~ 'Non-Hispanic Asian',
                                TRUE ~ NA_character_),
         marital_status = case_when(DMDMARTL %in% c(1,6) ~ 'married/live with other',
                                     DMDMARTL %in% c(2,3,4,5) ~ 'other',
                                     TRUE ~ NA_character_),
         family_income = case_when(INDFMPIR >=2 ~ 'High/Middle income',
                                    INDFMPIR < 2 ~ 'Low income',
                                    TRUE ~ NA_character_),
         health_insurance = case_when(HIQ011 == 1 ~ 1L, 
                                       HIQ011 == 2 ~ 0L,
                                       TRUE ~ NA_integer_),
         employment_status = case_when(OCD150 %in% c(1,2) ~ 'Working',
                                       (OCD150 == 3) ~'Unemployed',
                                       (OCD150==4 & OCQ380 ==5)~'Unemployed',
                                       OCD150 == 4 & OCQ380 %in% c(1,2,3,4,6) ~ 'Not in labor force',
                                        TRUE ~ NA_character_),
         
         htn_history = case_when(BPQ020 == 1 ~ 1L,
                              BPQ020 == 2 ~ 0L,
                              TRUE ~ NA_integer_),
         htn_treatment = case_when(BPQ050A == 1 | anti_htn_per==1 ~ 1L,
                                   (BPQ050A %in% c(7,9,NA)) & is.na(anti_htn_per)~ NA_integer_,
                              TRUE ~ 0L),
         high_chol_history = case_when(BPQ080 == 1 ~ 1L,
                                    BPQ080 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         high_chol_treatment = case_when(BPQ100D == 1 | anti_hyperlipid_per==1 ~ 1L,
                                         (BPQ100D %in% c(7,9,NA)) & is.na(anti_hyperlipid_per) ~ NA_integer_,
                              TRUE ~ 0L),
         diab_history= case_when(DIQ010 ==1 ~1L,
                              DIQ010 %in% c(2,3) ~ 0L,
                              TRUE ~ NA_integer_),
         diab_treatment = case_when(DIQ050 == 1|DIQ070==1|anti_diabetes_per==1~ 1L,
                                    DIQ050 %in% c(7,9,NA)& DIQ070 %in% c(7,9,NA) & is.na(anti_diabetes_per)~ NA_integer_,
                              TRUE ~ 0L),
         cancer_history = case_when(MCQ220 == 1 ~ 1L,
                                    MCQ220 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         CD_history = case_when(MCQ160B==1|MCQ160C==1|MCQ160D==1|MCQ160E==1|MCQ160F==1 ~ 1L,
                                MCQ160B%in%c(7,9,NA)&MCQ160C%in%c(7,9,NA)&MCQ160D%in%c(7,9,NA)&MCQ160E%in%c(7,9,NA)&MCQ160F%in%c(7,9,NA) ~ NA_integer_,
                              TRUE ~ 0L),
         first_cd_age = case_when(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F) ~ NA_real_,
                                   !(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F))~ pmin(MCQ180B,MCQ180C,MCQ180D,MCQ180E,MCQ180F,na.rm = T)),
         close_relatives_heartattack = case_when(MCQ300A == 1 ~ 1L,
                                    MCQ300A == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         close_relatives_diabetes = case_when(MCQ300C == 1 ~ 1L,
                                    MCQ300C == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         alcohol_intake = case_when(age <20 ~ 'Never drinker',
                                    ALQ110 == 2 ~ 'Never drinker',
                                    ALQ110 == 1 & ADD ==0 ~ 'Former drinker',
                                    ALQ110 == 1 & ALQ101 == 2 ~ 'Former drinker',
                                    ADD>0 & ADD<0.5 ~ 'Light drinker',
                                    ADD>=0.5 & ADD<2.5 & RIAGENDR == 1 ~ 'Moderate drinker',
                                    ADD>=0.5 & ADD<1.5 & RIAGENDR == 2 ~ 'Moderate drinker',
                                    ADD>=2.5 & RIAGENDR == 1 ~ 'Heavier drinker',
                                    ADD>=1.5 & RIAGENDR == 2 ~ 'Heavier drinker',
                                    TRUE ~ NA_character_),
         smoking_status = case_when(SMQ_HIST == 'Never smoker'  ~ 'Never smoker',
                                    SMQ_HIST == 'Former smoker' ~ 'Former smoker',
                                    SMQ_HIST == 'Current smoker' ~ 'Current smoker',
                                     TRUE ~ NA_character_),
         physical_activity = case_when(PAQ650 == 2 & PAQ665 == 2 ~ 'Inactive',
                                       TWMT < 10 ~ 'Inactive',
                                       TWMT >= 10 & TWMT < 150 ~ 'Insufficient active',
                                       TWMT >= 150 ~ 'Active',
                                       TRUE ~ NA_character_),
         pregnant = case_when((RHD143 == 1 )|(RIDEXPRG==1) ~ 1L,
                               TRUE ~ 0L),
         WT_DIFF_KG = WT_DIFF_PB *0.45359237,
         lwlstyr = case_when(WHQ070 == 1 ~ 1L,
                              WHQ070 == 2 ~ 0L,
                               TRUE ~ NA_integer_),
         exerc2lwlastyr = case_when(WHD080D == 13|WHD100D ==13 ~ 1L,
                                    (is.na(WHD080D) & is.na(WHD100D) & WHQ070 == 1)|(WHQ070 == 2)  ~ 0L,
                                    TRUE ~ NA_integer_),
         walk_bicycle_times_wk = case_when(PAQ635 == 2 ~ 0L,
                                           PAQ635 == 1 & PAQ640<20 ~ as.integer(PAQ640),
                                           TRUE ~ NA_integer_),
         overweight = case_when(race_ethn2 != 'Non-Hispanic Asian' & BMXBMI >=25 ~ 1L,
                                race_ethn2 != 'Non-Hispanic Asian' & BMXBMI < 25 ~ 0L,
                                race_ethn2 == 'Non-Hispanic Asian' & BMXBMI >=23 ~ 1L,
                                race_ethn2 == 'Non-Hispanic Asian' & BMXBMI < 23 ~ 0L,
                                TRUE ~ NA_integer_),
         overall_obesity = case_when(race_ethn2 != 'Non-Hispanic Asian' & BMXBMI >=30 ~ 1L,
                                     race_ethn2 != 'Non-Hispanic Asian' & BMXBMI < 30 ~ 0L,
                                     race_ethn2 == 'Non-Hispanic Asian' & BMXBMI >=27.5 ~ 1L,
                                     race_ethn2 == 'Non-Hispanic Asian' & BMXBMI < 27.5 ~ 0L,
                                     TRUE ~ NA_integer_),
         abdominal_obesity = case_when(race_ethn2 != 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST >=102 ~ 1L,
                                       race_ethn2 != 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST < 102 ~ 0L,
                                       race_ethn2 != 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST >= 88 ~ 1L,
                                       race_ethn2 != 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST <  88 ~ 0L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST >=  90 ~ 1L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST <  90 ~ 0L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST >=  80 ~ 1L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST <  80 ~ 0L,
                                       TRUE ~ NA_integer_),
         HBF1 = case_when(DXDTOPF >= 25 & RIAGENDR == 1 ~ 1L,
                         DXDTOPF < 25 & RIAGENDR == 1 ~ 0L,
                         DXDTOPF >= 35 & RIAGENDR == 2 ~ 1L,
                         DXDTOPF < 35 & RIAGENDR == 2 ~ 0L,
                         TRUE~ NA_integer_),
         HBF2 = case_when(DXDTOPF >= 28 & RIAGENDR == 1 ~ 1L,
                         DXDTOPF < 28 & RIAGENDR == 1 ~ 0L,
                         DXDTOPF >= 38 & RIAGENDR == 2 ~ 1L,
                         DXDTOPF < 38 & RIAGENDR == 2 ~ 0L,
                         TRUE~ NA_integer_),
         diab_now = case_when(diab_treatment==1L|LBXGH >=6.5|LBXGLU >=126 ~ 1L, ## oral glu tolerance was added from 2011
                              is.na(diab_treatment)&is.na(LBXGH )&is.na(LBXGLU) ~ NA_integer_,
                              TRUE ~ 0L),
         htn_now = case_when(htn_treatment==1L|SY_mean>=140|DI_mean>=90 ~ 1L,
                             is.na(htn_treatment)&is.na(SY_mean)&is.na(DI_mean) ~ NA_integer_,
                             TRUE ~0L),
         highchol_now = case_when(high_chol_treatment==1L |LBXTC>=240|LBDLDL>=160 ~ 1L,
                                  is.na(high_chol_treatment)&is.na(LBXTC)&is.na(LBDLDL) ~ NA_integer_,
                                  TRUE ~ 0L),
         short_breathe = case_when(CDQ010 ==1 ~ 1L,
                                   TRUE ~ 0L))%>%
  mutate(LDL = LBDLDL,
         HDL = LBDHDD,
         TOTAL_CHOL = LBXTC,
         FAST_GLU = LBXGLU,
         HBA1C = LBXGH,
         FAST_INSULIN = LBXIN,
         FAST_TRI = LBXTR,
         ALT = LBXSATSI,
         AST = LBXSASSI,
         BUN = LBXSBU,
         GLU = LBXSGL,
         LDH = LBXSLDSI,
         POTAS = LBXSKSI,
         CHL = LBXSCLSI,
         SODI = LBXSNASI,
         CHOL = LBXSCH,
         TOTPRO = LBXSTP,
         CREATININE = LBXSCR,
         BILIRUBIN= LBXSTB,
         IRON = LBXSIR,
         CALCIUM = LBXSCA,
         BICARBONATE = LBXSC3SI)%>%
  select(seqn,time,year,age,gender,educ, race_ethn, marital_status,INDFMPIR, family_income, health_insurance, employment_status,
         SDMVPSU,SDMVSTRA,WTINT2YR,WTMEC2YR,WTSAF2YR,
         SY_mean, DI_mean, BMXBMI,BMXWAIST,BMXHT, bpx_metric,bpx_metric_ss,BPXCHR,BPXPLS,BMXWT,WT_DIFF_KG,BMXARMC,
         alcohol_intake,smoking_status,physical_activity,pregnant,lwlstyr, exerc2lwlastyr,walk_bicycle_times_wk,ADD, TWMT, short_breathe,
         overweight, overall_obesity, abdominal_obesity, HBF1,HBF2,
         htn_history, high_chol_history,diab_history, cancer_history, CD_history, first_cd_age,close_relatives_heartattack,close_relatives_diabetes,
         diab_now, htn_now,highchol_now,
         htn_treatment, high_chol_treatment, diab_treatment,aspirin_per, statin_per,acei_per,arb_per,betablocker_per,optimal_regimen_per, 
         LDL,HDL,TOTAL_CHOL,FAST_GLU,HBA1C,FAST_INSULIN,FAST_TRI,ALT,AST,BUN,GLU,LDH,POTAS,CHL,SODI,CHOL,TOTPRO, LBDSCRSI,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         DXDTOPF,DXXLABMD,DXDLAPF, DXXLLBMD, DXDLLPF,DXXRABMD,DXDRAPF , DXXRLBMD ,DXDRLPF , DXDTRBMD ,DXDTRPF,
         DXDLALE,DXDRALE,DXDLLLE,DXDRLLE,DXDTRLE,DXXTRFAT,DXXLAFAT,DXXRAFAT,DXXLLFAT,DXXRLFAT,DXDTOFAT,DXDTOLE,DXDTOBMD,
         IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
                CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226,
         DIQ080,MCQ160G,adoles_limit1,adoles_limit2,adult_limit1,adult_limit2,select_prob)
    
    
VO2MAX2011_BASIC <- VO2MAX2011 %>%
  select(seqn,time,year,age,gender,educ, race_ethn, marital_status,INDFMPIR, family_income, health_insurance, employment_status,
         SDMVPSU,SDMVSTRA,WTINT2YR,WTMEC2YR,WTSAF2YR,
         SY_mean, DI_mean, BMXBMI,BMXWAIST,BMXHT, bpx_metric,bpx_metric_ss,BPXCHR,BPXPLS,BMXWT,WT_DIFF_KG,BMXARMC,
         alcohol_intake,smoking_status,physical_activity,pregnant,lwlstyr, exerc2lwlastyr,walk_bicycle_times_wk,ADD, TWMT, short_breathe,
         overweight, overall_obesity, abdominal_obesity, 
         htn_history, high_chol_history,diab_history, cancer_history, CD_history, first_cd_age,close_relatives_heartattack,close_relatives_diabetes,
         diab_now, htn_now,highchol_now,
         htn_treatment, high_chol_treatment, diab_treatment,aspirin_per, statin_per,acei_per,arb_per,betablocker_per,optimal_regimen_per, 
         LDL,HDL,TOTAL_CHOL,FAST_GLU,HBA1C,FAST_INSULIN,FAST_TRI,ALT,AST,BUN,GLU,LDH,POTAS,CHL,SODI,CHOL,TOTPRO,
         LBDSCRSI,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         DIQ080,MCQ160G,adoles_limit1,adoles_limit2,adult_limit1,adult_limit2,select_prob)

## write to csv file
# VO2MAX2011%>% write.csv(paste0(wd_path,'VO2MAX2011.csv'))
# VO2MAX2011_BASIC%>% write.csv(paste0(wd_path,'VO2MAX2011_BASIC.csv'))  

```


## 2013-2014
```{r}
## demographic infos
demo_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/DEMO_h.XPT"))%>%
  dplyr::select('SEQN','SDDSRVYR','RIDAGEYR','RIAGENDR','RIDRETH1','RIDRETH3','DMDEDUC2','DMDEDUC3','DMDMARTL','INDFMIN2','INDFMPIR','WTINT2YR','WTMEC2YR','SDMVPSU','SDMVSTRA','RIDEXPRG') 

## health insurance status
hiq_h <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/HIQ_h.XPT"))%>%
  dplyr::select('SEQN', 'HIQ011')

## occupation/employment status
ocq_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/OCQ_h.XPT"))%>% 
  dplyr::select('SEQN','OCD150','OCQ380')

## diabetes history
diq_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/DIQ_h.XPT"))%>% 
  dplyr::select('SEQN', 'DIQ010', 'DIQ050','DIQ070','DIQ080')


## hypertension and cholesterol history 
bpq_h <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/BPQ_h.XPT"))%>%
  dplyr::select('SEQN', 'BPQ020','BPQ050A','BPQ080','BPQ100D')


## bp measurement
bpx_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/BPX_h.XPT"))%>% 
  dplyr::select('SEQN','BPXSY1','BPXSY2','BPXSY3','BPXSY4','BPXDI1','BPXDI2','BPXDI3','BPXDI4','BPXCHR','BPXPLS')%>%
  mutate(SY_mean =rowMeans(subset(.,select = c('BPXSY1','BPXSY2','BPXSY3','BPXSY4')), na.rm = TRUE))%>%
  mutate(DI_mean =rowMeans(subset(.,select = c('BPXDI1','BPXDI2','BPXDI3','BPXDI4')), na.rm = TRUE))%>%
  # metric for htn 1: not control
  mutate(bpx_metric = case_when(SY_mean >= 140 | DI_mean >=90 ~ 1,
                                (SY_mean < 140 & DI_mean < 90)~0,
                                (SY_mean < 140 & is.na(DI_mean))~0,
                                (DI_mean < 90 & is.na(SY_mean))~0,
                                TRUE ~ NA_real_))%>%
  # ss stands for sensitivity
  mutate(bpx_metric_ss = case_when(SY_mean >= 130 | DI_mean >=80 ~ 1,
                                (SY_mean < 130 & DI_mean < 80)~0,
                                (SY_mean < 130 & is.na(DI_mean))~0,
                                (DI_mean < 80 & is.na(SY_mean))~0,
                                TRUE ~ NA_real_))%>%
  dplyr::select(SEQN,bpx_metric, bpx_metric_ss, SY_mean, DI_mean,BPXCHR,BPXPLS)




## comorbidities
mcq_h <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/MCQ_h.XPT"))%>% 
   dplyr::select('SEQN', 
                'MCQ160B','MCQ180B',
                'MCQ160C','MCQ180C', ## coronary heart disease and the age first diagnosed
                'MCQ160D','MCQ180D',
                'MCQ160E','MCQ180E', ## heart attack and the age first diagnosed
                'MCQ160F','MCQ180F', ## stroke and the age first diagnosed
                'MCQ220',# MCQ220 cancer
                'MCQ300C','MCQ300A',
                'MCQ160G') 


## alcohol intake
alq_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/ALQ_h.XPT"))%>% 
  dplyr::select('SEQN','ALQ120Q','ALQ120U','ALQ130','ALQ110','ALQ101')%>%
  replace_with_na(replace = list(ALQ120Q = c(777,999),
                                 ALQ120U = c(7,9),
                                 ALQ130 = c(777,999),
                                 ALQ110 = c(7,9),
                                 ALQ101 = c(7,9)))%>%
  ## ADD is the estimate of average daily drinks
  mutate(ADD = case_when(ALQ101 == 2 ~ 0,
                         ALQ110 == 2 ~ 0,
                         ALQ120U == 1 ~ ALQ130*ALQ120Q/7,
                         ALQ120U == 2 ~ ALQ130*ALQ120Q/30,
                         ALQ120U == 3 ~ ALQ130*ALQ120Q/365,
                         TRUE ~ NA_real_))



## smoking status
## two data file regarding smoking in 2013-2014, combine to construct required variable
smq_h1 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/SMQ_h.XPT"))%>% 
  dplyr::select('SEQN','SMQ020', 'SMQ040','SMQ621')


smq_h2 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/SMQRTU_h.XPT"))%>% 
  dplyr::select('SEQN','SMQ681')

smq_h <- smq_h1 %>% full_join(smq_h2, by= 'SEQN')


smq_h$SMQ_HIST <-apply(smq_h,1,function(x){
  if(any(x[2]==2,x[4]%in% c(1,2,3,4,5,6,7),na.rm = T)){return ('Never smoker')}
  else if (!any(x[2]==2,x[4]%in% c(1,2,3,4,5,6,7),na.rm = T) & any(x[3]%in% c(1,2),x[5]==1,na.rm = T)){return ('Current smoker')}
  else if (any(x[2] ==1,x[4]==8,na.rm = T) & (!x[3] %in% c(1,2) & x[5] %in% c(2))){return ('Former smoker')}
  else if (any(x[2] ==1,x[4]==8,na.rm = T) & (x[3] %in% c(3) & !x[5] %in% c(1))){return ('Former smoker')}
  else {return ('unknown')}
})





## physical activity 
paq_h <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/PAQ_h.XPT"))%>%
  dplyr::select('SEQN','PAQ650','PAQ665','PAQ655','PAD660','PAQ670','PAD675','PAQ635','PAQ640')%>%
  ## convert special code to NA
  mutate(PAQ670 = ifelse(PAQ670 %in% c(77,99),NA,PAQ670),
         PAD675 = ifelse(PAD675 %in% c(7777,9999),NA,PAD675),
         PAQ655 = ifelse(PAQ655 %in% c(77,99),NA,PAQ655),
         PAD660 = ifelse(PAD660 %in% c(7777,9999),NA,PAD660))%>%
  mutate(moder = PAQ670*PAD675) %>%
  # vigorous-intensity = 2 * moderate-intensity
  mutate(vigor_eq = 2*PAQ655*PAD660)%>%
  ## TWMT stands for total weekly moderate-intensity-exercise time 
  ## TWMT >150 : active, TWMT < 10 :INACTIVE, TMWT in (10,150) : Insufficient active
  mutate(TWMT =rowSums(subset(.,select = c('moder','vigor_eq')), na.rm = T))%>%
  mutate(TWMT = replace(TWMT, is.na(moder)&is.na(vigor_eq), NA))%>%
  mutate(TWMT = ifelse(PAQ650 == 2 & PAQ665 == 2,0,TWMT))
 


## Physical function
pfq_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/PFQ_H.XPT"))%>%
  dplyr::select('SEQN',
                'PFQ020','PFQ030',
                'PFQ061B','PFQ061C','PFQ061H','PFQ061I',
                'PFQ063A','PFQ063B','PFQ063C','PFQ063D','PFQ063E')%>%
  mutate(adoles_limit1 = ifelse(PFQ020==1,1,0),
         adoles_limit2 = ifelse(PFQ030==1,1,0),
         adult_limit1 = ifelse(PFQ061B%in% c(3,4) | PFQ061C %in% c(3,4) | PFQ061H %in% c(3,4)| PFQ061I %in% c(3,4),1,0),
         adult_limit2 = ifelse(PFQ061B%in% c(2,3,4) | PFQ061C %in% c(2,3,4)| PFQ061H %in% c(2,3,4)| PFQ061I %in% c(2,3,4),1,0))%>%
  mutate(select_prob = ifelse((PFQ063A %in% c(19,21,25))|
                                (PFQ063B %in% c(19,21,25))|
                                (PFQ063C %in% c(19,21,25))|
                                (PFQ063D %in% c(19,21,25))|
                                (PFQ063E %in% c(19,21,25)),1,0))
  
## Weight history
whq_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/WHQ_H.XPT"))%>%
  dplyr::select('SEQN','WHD050','WHD020','WHQ070','WHD080D')%>%
  ## convert special code to NA
  replace_with_na(replace = list(WHD020 = c(7777,9999),
                                 WHD050 = c(7777,9999)))%>%
  mutate(WT_DIFF_PB = WHD050 - WHD020)



## obsesity metric
bmx_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/BMX_h.XPT")) %>%
  dplyr::select('SEQN', 'BMXWAIST','BMXBMI','BMXHT','BMXWT', 'BMXARMC')

## cardiovascular health
cdq_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/CDQ_H.XPT"))%>%
  dplyr::select('SEQN', 'CDQ010')

## total cholesterol 
tchol_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/TCHOL_h.XPT")) %>%
  dplyr::select('SEQN', 'LBXTC')


## Glycohemoglobin
ghb_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/GHB_h.XPT")) %>%
  dplyr::select('SEQN', 'LBXGH')


## hdl
hdl_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/HDL_H.XPT")) %>%
  dplyr::select('SEQN', 'LBDHDD')


## Ldl
ldl_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/TRIGLY_H.XPT")) %>%
  dplyr::select('SEQN', 'LBXTR','LBDLDL', 'WTSAF2YR')

## Fasting glucose
glu_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/GLU_H.XPT")) %>%
  dplyr::select('SEQN', 'LBXGLU','WTSAF2YR')

## INSULIN
ins_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/INS_H.XPT")) %>%
  dplyr::select('SEQN', 'LBXIN','WTSAF2YR')

## FASTING SUBSAMPLE
fast_h <- glu_h %>% 
  full_join(ins_h, by = c('SEQN','WTSAF2YR')) %>%
  full_join(ldl_h, by = c('SEQN','WTSAF2YR'))
  

## BIO PROFILE
biopro_h <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/BIOPRO_H.XPT")) %>%
  dplyr::select('SEQN', 'LBXSATSI', 'LBXSASSI', 'LBXSBU','LBXSGL','LBXSLDSI',
                'LBXSKSI','LBXSCLSI','LBXSNASI','LBXSCH','LBXSTP','LBXSTR',
                'LBDSCRSI','LBXSCR',
                'LBXSC3SI','LBXSCA','LBXSIR','LBXSTB')


## prescription
rxq_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/RXQ_RX_h.XPT"))



## prescription info join with drugs
rxq_sp_h <- rxq_h %>% left_join(sp_drug, by='RXDDRGID') %>%
  dplyr::group_by(SEQN) %>%
  ## _per means per person
  summarise(acei_per = ifelse(sum(acei, na.rm=T)>0,1,0), 
            betablocker_per =ifelse( sum(betablocker, na.rm=T)>0,1,0), 
            arb_per = ifelse(sum(arb, na.rm=T)>0,1,0), 
            aspirin_per = ifelse(sum(aspirin, na.rm = T)>0,1,0),
            statin_per = ifelse(sum(statin, na.rm = T)>0,1,0),
            anti_platelet_per = ifelse(sum(anti_platelet, na.rm = T)>0,1,0),
            anti_htn_per = ifelse(sum(anti_htn, na.rm = T)>0,1,0),
            anti_hyperlipid_per = ifelse(sum(anti_hyperlipid, na.rm = T)>0,1,0),
            anti_diabetes_per = ifelse(sum(anti_diabetes, na.rm = T)>0,1,0),
            .groups = 'drop' )%>%
  mutate(optimal_regimen_per = rowSums(subset(., select=c(anti_htn_per, anti_hyperlipid_per, anti_platelet_per))))


## rxq reason
rxq_main_reason_h <-rxq_h %>% 
  mutate(main_reason1 = grepl('^I[2-][0-9]',RXDRSC1),
         main_reason2 = grepl('^I[2-][0-9]',RXDRSC2),
         main_reason3 = grepl('^I[2-][0-9]',RXDRSC3),
         main_reason = main_reason1|main_reason2|main_reason3) %>%
   dplyr::group_by(SEQN) %>%
   dplyr::summarise(cvd_main_reason = ifelse(sum(main_reason, na.rm=T)>0,1,0))
  


## pregnancy
rhq_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/RHQ_h.XPT"))%>%
  select(SEQN, RHD143)


## DXX
dxx_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/DXX_H.XPT")) %>% 
  dplyr::select('SEQN', 
                'DXDTOPF','DXDTOBMD',
                'DXXLABMD','DXDLAPF',
                'DXXLLBMD','DXDLLPF',
                'DXXRABMD','DXDRAPF',
                'DXXRLBMD','DXDRLPF',
                'DXDTRBMD','DXDTRPF',
                'DXDLALE','DXDRALE',
                'DXDLLLE','DXDRLLE',
                'DXDTRLE','DXXTRFAT',
                'DXXLAFAT','DXXRAFAT',
                'DXXLLFAT','DXXRLFAT',
                'DXDTOFAT','DXDTOLE',
                'DXDTOBMD')




diet_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/DR1TOT_H.XPT"))%>%
  select(SEQN, DR1DAY,DR1DRSTZ, DR1TKCAL,DR1TPROT,DR1TCARB,DR1TTFAT,DR1TSFAT,DR1TMFAT,DR1TPFAT,
         DR1TCHOL,DR1TFIBE,DR1TVB1,DR1TVB2,DR1TNIAC,DR1TVB6,DR1TFOLA,DR1TVB12,DR1TVC,DR1TATOC,
         DR1TCALC,DR1TPHOS,DR1TMAGN, DR1TIRON,DR1TZINC,DR1TCOPP,DR1TSODI,DR1TPOTA,DR1TSELE,DR1TCAFF,
         DR1TTHEO,DR1TALCO,DR1TMOIS,
         DR1TS040,DR1TS060,DR1TS080,DR1TS100,DR1TS120,DR1TS140,DR1TS160,DR1TS180,
         DR1TM161,DR1TM181,DR1TM201,DR1TM221,
         DR1TP182,DR1TP183,DR1TP184,DR1TP204,DR1TP205,DR1TP225,DR1TP226,
         DR1_300, DR1_320Z)%>%
  rename(DAY_DIET =  DR1DAY,
         STATUS_DIET=DR1DRSTZ,
         CALORIE_DIET =DR1TKCAL,
         PROTEIN_DIET = DR1TPROT,
         CARB_DIET= DR1TCARB,
         FAT_DIET = DR1TTFAT,
         SFAT_DIET =DR1TSFAT,
         MFAT_DIET = DR1TMFAT,
         PFAT__DIET = DR1TPFAT,
         CHOL_DIET = DR1TCHOL,
         FIBE_DIET = DR1TFIBE,
         VB1_DIET = DR1TVB1,
         VB2_DIET = DR1TVB2,
         NIAC_DIET = DR1TNIAC,
         VB6_DIET = DR1TVB6,
         FOLATE_DIET = DR1TFOLA,
         VB12_DIET = DR1TVB12,
         VC_DIET = DR1TVC,
         VE_DIET = DR1TATOC,
         CALC_DIET= DR1TCALC,
         PHOS_DIET = DR1TPHOS,
         MG_DIET = DR1TMAGN,
         IRON_DIET = DR1TIRON,
         ZINC_DIET = DR1TZINC,
         COPP_DIET = DR1TCOPP,
         SODI_DIET = DR1TSODI,
         POTA_DIET = DR1TPOTA,
         SELE_DIET = DR1TSELE,
         CAFF_DIET = DR1TCAFF,
         THEO_DIET = DR1TTHEO,
         ALCO_DIET = DR1TALCO,
         MOIS_DIET = DR1TMOIS,
         COMPARE = DR1_300, 
         TOTWATER = DR1_320Z,
         TS040 = DR1TS040,
         TS060 = DR1TS060,
         TS080 = DR1TS080,
         TS100 = DR1TS100,
         TS120 = DR1TS120,
         TS140 = DR1TS140,
         TS160 = DR1TS160,
         TS180 = DR1TS180,
         TM161 = DR1TM161,
         TM181 = DR1TM181,
         TM201 = DR1TM201,
         TM221 = DR1TM221,
         TP182 = DR1TP182,
         TP183 = DR1TP183,
         TP184 = DR1TP184,
         TP204 = DR1TP204,
         TP205 = DR1TP205,
         TP225 = DR1TP225,
         TP226 = DR1TP226)%>%
  mutate(IS_WEEKEND_DIET = ifelse(DAY_DIET %in% c(1,6,7),1,0),## friday, sunday or saturday
         COMPARE_USUAL = ifelse(COMPARE ==1,1,0),
         COMPARE_LESS = ifelse(COMPARE ==2,1,0),
         COMPARE_MORE = ifelse(COMPARE ==3,1,0))%>%
  filter(STATUS_DIET==1)%>%
  dplyr::select(SEQN, IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
                CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226)


## urine content
urine_h <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2013-2014/ALB_CR_H.XPT"))%>%
  dplyr::mutate(albuminuria = (URXUMS/URXUCR)*100)

## combine
comb_h <- demo_h %>% left_join(hiq_h, by='SEQN')%>%  left_join(ocq_h, by='SEQN')%>% left_join(diq_h, by='SEQN')%>%  
  left_join(bpq_h, by='SEQN')%>%left_join(bpx_h, by='SEQN')%>%left_join(mcq_h, by='SEQN')%>% 
  left_join(alq_h, by='SEQN')%>% left_join(smq_h, by='SEQN')%>% left_join(paq_h, by='SEQN')%>% 
  left_join(bmx_h, by='SEQN')%>% left_join(tchol_h, by='SEQN')%>% left_join(ghb_h, by='SEQN')%>% 
  left_join(rxq_sp_h, by='SEQN')%>% left_join(rhq_h, by='SEQN')%>%left_join(hdl_h, by = 'SEQN')%>%
  left_join(fast_h, by = 'SEQN')%>% 
  left_join(biopro_h, by = 'SEQN') %>%
  left_join(rxq_main_reason_h, by = 'SEQN')%>%
  left_join(pfq_h, by = 'SEQN')%>%
  left_join(whq_h, by = 'SEQN')%>%
  left_join(dxx_h, by = 'SEQN')%>%
  left_join(cdq_h, by = 'SEQN')%>%
  left_join(diet_h, by = 'SEQN')%>%
  left_join(urine_h, by = 'SEQN')


#sp stands for secondary prevention
VO2MAX2013 <- comb_h %>% 
  mutate(seqn = SEQN,
         time = 8,  
         year = '2013',
         age = RIDAGEYR,
         gender = case_when(RIAGENDR == 1 ~ 'Male',
                            RIAGENDR == 2 ~ 'Female',
                            TRUE ~ NA_character_),
         educ = case_when((DMDEDUC3 %in% c(0,1,2,3,4,5,6,7,8,9,10,11,12,55,66))|(DMDEDUC2 %in% c(1,2)) ~ 'Less than high school',
                         (DMDEDUC3 %in% c(13,14))|(DMDEDUC2 == 3) ~ 'High school diploma or GED',
                         (DMDEDUC3 == 15)|(DMDEDUC2 %in% c(4,5)) ~'Greater than high school',
                         TRUE ~ NA_character_),
         race_ethn = case_when( RIDRETH3 %in% c(1,2) ~ 'Hispanic',
                                RIDRETH3 == 3 ~ 'Non-Hispanic White',
                                RIDRETH3 == 4 ~ 'Non-Hispanic Black',
                                TRUE ~ 'Other'),
         race_ethn2 = case_when( RIDRETH3 %in% c(1,2) ~ 'Hispanic',
                                RIDRETH3 == 3 ~ 'Non-Hispanic White',
                                RIDRETH3 == 4 ~ 'Non-Hispanic Black',
                                RIDRETH3 == 6 ~ 'Non-Hispanic Asian',
                                TRUE ~ NA_character_),
         marital_status = case_when(DMDMARTL %in% c(1,6) ~ 'married/live with other',
                                     DMDMARTL %in% c(2,3,4,5) ~ 'other',
                                     TRUE ~ NA_character_),
         family_income = case_when(INDFMPIR >=2 ~ 'High/Middle income',
                                    INDFMPIR < 2 ~ 'Low income',
                                    TRUE ~ NA_character_),
         health_insurance = case_when(HIQ011 == 1 ~ 1L, 
                                       HIQ011 == 2 ~ 0L,
                                       TRUE ~ NA_integer_),
         employment_status = case_when(OCD150 %in% c(1,2) ~ 'Working',
                                       (OCD150 == 3) ~'Unemployed',
                                       (OCD150==4 & OCQ380 ==5)~'Unemployed',
                                       OCD150 == 4 & OCQ380 %in% c(1,2,3,4,6) ~ 'Not in labor force',
                                        TRUE ~ NA_character_),
         htn_history = case_when(BPQ020 == 1 ~ 1L,
                              BPQ020 == 2 ~ 0L,
                              TRUE ~ NA_integer_),
         htn_treatment = case_when(BPQ050A == 1 | anti_htn_per==1 ~ 1L,
                                   (BPQ050A %in% c(7,9,NA)) & is.na(anti_htn_per)~ NA_integer_,
                              TRUE ~ 0L),
         high_chol_history = case_when(BPQ080 == 1 ~ 1L,
                                    BPQ080 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         high_chol_treatment = case_when(BPQ100D == 1 | anti_hyperlipid_per==1 ~ 1L,
                                         (BPQ100D %in% c(7,9,NA)) & is.na(anti_hyperlipid_per) ~ NA_integer_,
                              TRUE ~ 0L),
         diab_history= case_when(DIQ010 ==1 ~1L,
                              DIQ010 %in% c(2,3) ~ 0L,
                              TRUE ~ NA_integer_),
         diab_treatment = case_when(DIQ050 == 1|DIQ070==1|anti_diabetes_per==1~ 1L,
                                    DIQ050 %in% c(7,9,NA)& DIQ070 %in% c(7,9,NA) & is.na(anti_diabetes_per)~ NA_integer_,
                              TRUE ~ 0L),
         cancer_history = case_when(MCQ220 == 1 ~ 1L,
                                    MCQ220 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         CD_history = case_when(MCQ160B==1|MCQ160C==1|MCQ160D==1|MCQ160E==1|MCQ160F==1 ~ 1L,
                                MCQ160B%in%c(7,9,NA)&MCQ160C%in%c(7,9,NA)&MCQ160D%in%c(7,9,NA)&MCQ160E%in%c(7,9,NA)&MCQ160F%in%c(7,9,NA) ~ NA_integer_,
                              TRUE ~ 0L),
         first_cd_age = case_when(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F) ~ NA_real_,
                                   !(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F))~ pmin(MCQ180B,MCQ180C,MCQ180D,MCQ180E,MCQ180F,na.rm = T)),
         close_relatives_heartattack = case_when(MCQ300A == 1 ~ 1L,
                                    MCQ300A == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         close_relatives_diabetes = case_when(MCQ300C == 1 ~ 1L,
                                    MCQ300C == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         alcohol_intake = case_when(age <20 ~ 'Never drinker',
                                    ALQ110 == 2 ~ 'Never drinker',
                                    ALQ110 == 1 & ADD ==0 ~ 'Former drinker',
                                    ALQ110 == 1 & ALQ101 == 2 ~ 'Former drinker',
                                    ADD>0 & ADD<0.5 ~ 'Light drinker',
                                    ADD>=0.5 & ADD<2.5 & RIAGENDR == 1 ~ 'Moderate drinker',
                                    ADD>=0.5 & ADD<1.5 & RIAGENDR == 2 ~ 'Moderate drinker',
                                    ADD>=2.5 & RIAGENDR == 1 ~ 'Heavier drinker',
                                    ADD>=1.5 & RIAGENDR == 2 ~ 'Heavier drinker',
                                    TRUE ~ NA_character_),
         smoking_status = case_when(SMQ_HIST == 'Never smoker'  ~ 'Never smoker',
                                    SMQ_HIST == 'Former smoker' ~ 'Former smoker',
                                    SMQ_HIST == 'Current smoker' ~ 'Current smoker',
                                     TRUE ~ NA_character_),
         physical_activity = case_when(PAQ650 == 2 & PAQ665 == 2 ~ 'Inactive',
                                       TWMT < 10 ~ 'Inactive',
                                       TWMT >= 10 & TWMT < 150 ~ 'Insufficient active',
                                       TWMT >= 150 ~ 'Active',
                                       TRUE ~ NA_character_),
         pregnant = case_when((RHD143 == 1)|(RIDEXPRG==1) ~ 1L,
                               TRUE ~ 0L),
         WT_DIFF_KG = WT_DIFF_PB*0.45359237,
         lwlstyr = case_when(WHQ070 == 1 ~ 1L,
                              WHQ070 == 2 ~ 0L,
                               TRUE ~ NA_integer_),
         exerc2lwlastyr = case_when(WHD080D == 13 ~ 1L,
                                    (is.na(WHD080D) & WHQ070 == 1)|(WHQ070 == 2)  ~ 0L,
                                    TRUE ~ NA_integer_),
         walk_bicycle_times_wk = case_when(PAQ635 == 2 ~ 0L,
                                           PAQ635 == 1 & PAQ640<20 ~ as.integer(PAQ640),
                                           TRUE ~ NA_integer_),
         overweight = case_when(race_ethn2 != 'Non-Hispanic Asian' & BMXBMI >=25 ~ 1L,
                                race_ethn2 != 'Non-Hispanic Asian' & BMXBMI < 25 ~ 0L,
                                race_ethn2 == 'Non-Hispanic Asian' & BMXBMI >=23 ~ 1L,
                                race_ethn2 == 'Non-Hispanic Asian' & BMXBMI < 23 ~ 0L,
                                TRUE ~ NA_integer_),
         overall_obesity = case_when(race_ethn2 != 'Non-Hispanic Asian' & BMXBMI >=30 ~ 1L,
                                     race_ethn2 != 'Non-Hispanic Asian' & BMXBMI < 30 ~ 0L,
                                     race_ethn2 == 'Non-Hispanic Asian' & BMXBMI >=27.5 ~ 1L,
                                     race_ethn2 == 'Non-Hispanic Asian' & BMXBMI < 27.5 ~ 0L,
                                     TRUE ~ NA_integer_),
         abdominal_obesity = case_when(race_ethn2 != 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST >=102 ~ 1L,
                                       race_ethn2 != 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST < 102 ~ 0L,
                                       race_ethn2 != 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST >= 88 ~ 1L,
                                       race_ethn2 != 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST <  88 ~ 0L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST >=  90 ~ 1L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST <  90 ~ 0L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST >=  80 ~ 1L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST <  80 ~ 0L,
                                       TRUE ~ NA_integer_),
         HBF1 = case_when(DXDTOPF >= 25 & RIAGENDR == 1 ~ 1L,
                         DXDTOPF < 25 & RIAGENDR == 1 ~ 0L,
                         DXDTOPF >= 35 & RIAGENDR == 2 ~ 1L,
                         DXDTOPF < 35 & RIAGENDR == 2 ~ 0L,
                         TRUE~ NA_integer_),
         HBF2 = case_when(DXDTOPF >= 28 & RIAGENDR == 1 ~ 1L,
                         DXDTOPF < 28 & RIAGENDR == 1 ~ 0L,
                         DXDTOPF >= 38 & RIAGENDR == 2 ~ 1L,
                         DXDTOPF < 38 & RIAGENDR == 2 ~ 0L,
                         TRUE~ NA_integer_),
         diab_now = case_when(diab_treatment==1L|LBXGH >=6.5|LBXGLU >=126 ~ 1L, ## oral glu tolerance was added from 2011
                              is.na(diab_treatment)&is.na(LBXGH )&is.na(LBXGLU) ~ NA_integer_,
                              TRUE ~ 0L),
         htn_now = case_when(htn_treatment==1L|SY_mean>=140|DI_mean>=90 ~ 1L,
                             is.na(htn_treatment)&is.na(SY_mean)&is.na(DI_mean) ~ NA_integer_,
                             TRUE ~0L),
         highchol_now = case_when(high_chol_treatment==1L |LBXTC>=240|LBDLDL>=160 ~ 1L,
                                  is.na(high_chol_treatment)&is.na(LBXTC)&is.na(LBDLDL) ~ NA_integer_,
                                  TRUE ~ 0L),
         short_breathe = case_when(CDQ010 ==1 ~ 1L,
                                   TRUE ~ 0L))%>%
  mutate(LDL = LBDLDL,
         HDL = LBDHDD,
         TOTAL_CHOL = LBXTC,
         FAST_GLU = LBXGLU,
         HBA1C = LBXGH,
         FAST_INSULIN = LBXIN,
         FAST_TRI = LBXTR,
         ALT = LBXSATSI,
         AST = LBXSASSI,
         BUN = LBXSBU,
         GLU = LBXSGL,
         LDH = LBXSLDSI,
         POTAS = LBXSKSI,
         CHL = LBXSCLSI,
         SODI = LBXSNASI,
         CHOL = LBXSCH,
         TOTPRO = LBXSTP,
         CREATININE = LBXSCR,
         BILIRUBIN= LBXSTB,
         IRON = LBXSIR,
         CALCIUM = LBXSCA,
         BICARBONATE = LBXSC3SI)%>%
  select(seqn,time,year,age,gender,educ, race_ethn, marital_status,INDFMPIR, family_income, health_insurance, employment_status,
         SDMVPSU,SDMVSTRA,WTINT2YR,WTMEC2YR,WTSAF2YR,
         SY_mean, DI_mean, BMXBMI,BMXWAIST,BMXHT, bpx_metric,bpx_metric_ss,BPXCHR,BPXPLS,BMXWT,WT_DIFF_KG,BMXARMC,
         alcohol_intake,smoking_status,physical_activity,pregnant,lwlstyr, exerc2lwlastyr,walk_bicycle_times_wk,ADD, TWMT, short_breathe,
         overweight, overall_obesity, abdominal_obesity, HBF1,HBF2,
         htn_history, high_chol_history,diab_history, cancer_history, CD_history, first_cd_age,close_relatives_heartattack,close_relatives_diabetes,
         diab_now, htn_now,highchol_now,
         htn_treatment, high_chol_treatment, diab_treatment,aspirin_per, statin_per,acei_per,arb_per,betablocker_per,optimal_regimen_per, 
         LDL,HDL,TOTAL_CHOL,FAST_GLU,HBA1C,FAST_INSULIN,FAST_TRI,ALT,AST,BUN,GLU,LDH,POTAS,CHL,SODI,CHOL,TOTPRO, LBDSCRSI,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         DXDTOPF,DXXLABMD,DXDLAPF, DXXLLBMD, DXDLLPF,DXXRABMD,DXDRAPF , DXXRLBMD ,DXDRLPF , DXDTRBMD ,DXDTRPF,
         DXDLALE,DXDRALE,DXDLLLE,DXDRLLE,DXDTRLE,DXXTRFAT,DXXLAFAT,DXXRAFAT,DXXLLFAT,DXXRLFAT,DXDTOFAT,DXDTOLE,DXDTOBMD,
         IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
                CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226,
         DIQ080,MCQ160G,adoles_limit1,adoles_limit2,adult_limit1,adult_limit2,select_prob)

    

VO2MAX2013_BASIC <- VO2MAX2013 %>%
  select(seqn,time,year,age,gender,educ, race_ethn, marital_status,INDFMPIR, family_income, health_insurance, employment_status,
         SDMVPSU,SDMVSTRA,WTINT2YR,WTMEC2YR,WTSAF2YR,
         SY_mean, DI_mean, BMXBMI,BMXWAIST,BMXHT, bpx_metric,bpx_metric_ss,BPXCHR,BPXPLS,BMXWT,WT_DIFF_KG,BMXARMC,
         alcohol_intake,smoking_status,physical_activity,pregnant,lwlstyr, exerc2lwlastyr,walk_bicycle_times_wk,ADD, TWMT, short_breathe,
         overweight, overall_obesity, abdominal_obesity, 
         htn_history, high_chol_history,diab_history, cancer_history, CD_history, first_cd_age,close_relatives_heartattack,close_relatives_diabetes,
         diab_now, htn_now,highchol_now,
         htn_treatment, high_chol_treatment, diab_treatment,aspirin_per, statin_per,acei_per,arb_per,betablocker_per,optimal_regimen_per, 
         LDL,HDL,TOTAL_CHOL,FAST_GLU,HBA1C,FAST_INSULIN,FAST_TRI,ALT,AST,BUN,GLU,LDH,POTAS,CHL,SODI,CHOL,TOTPRO,
         LBDSCRSI,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         DIQ080,MCQ160G,adoles_limit1,adoles_limit2,adult_limit1,adult_limit2,select_prob) 

## write to csv file
# VO2MAX2013%>% write.csv(paste0(wd_path,'VO2MAX2013.csv'))
# VO2MAX2013_BASIC%>% write.csv(paste0(wd_path,'VO2MAX2013_BASIC.csv'))
```


## 2015-2016
```{r}
## demographic infos
demo_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/DEMO_I.XPT"))%>%
  dplyr::select('SEQN','SDDSRVYR','RIDAGEYR','RIAGENDR','RIDRETH1','RIDRETH3','DMDEDUC2','DMDEDUC3','DMDMARTL','INDFMIN2','INDFMPIR','WTINT2YR','WTMEC2YR','SDMVPSU','SDMVSTRA','RIDEXPRG') 

## health insurance status
hiq_i <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/HIQ_I.XPT"))%>%
  dplyr::select('SEQN', 'HIQ011')

## occupation/employment status
ocq_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/OCQ_I.XPT"))%>% 
  dplyr::select('SEQN','OCD150','OCQ380')

## diabetes history
diq_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/DIQ_I.XPT"))%>% 
  dplyr::select('SEQN', 'DIQ010', 'DIQ050','DIQ070','DIQ080')


## hypertension and cholesterol history 
bpq_i <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/BPQ_I.XPT"))%>%
  dplyr::select('SEQN', 'BPQ020','BPQ050A','BPQ080','BPQ100D')


## bp measurement
bpx_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/BPX_I.XPT"))%>% 
  dplyr::select('SEQN','BPXSY1','BPXSY2','BPXSY3','BPXSY4','BPXDI1','BPXDI2','BPXDI3','BPXDI4','BPXCHR','BPXPLS')%>%
  mutate(SY_mean =rowMeans(subset(.,select = c('BPXSY1','BPXSY2','BPXSY3','BPXSY4')), na.rm = TRUE))%>%
  mutate(DI_mean =rowMeans(subset(.,select = c('BPXDI1','BPXDI2','BPXDI3','BPXDI4')), na.rm = TRUE))%>%
  # metric for htn 1: not control
  mutate(bpx_metric = case_when(SY_mean >= 140 | DI_mean >=90 ~ 1,
                                (SY_mean < 140 & DI_mean < 90)~0,
                                (SY_mean < 140 & is.na(DI_mean))~0,
                                (DI_mean < 90 & is.na(SY_mean))~0,
                                TRUE ~ NA_real_))%>%
  # ss stands for sensitivity
  mutate(bpx_metric_ss = case_when(SY_mean >= 130 | DI_mean >=80 ~ 1,
                                (SY_mean < 130 & DI_mean < 80)~0,
                                (SY_mean < 130 & is.na(DI_mean))~0,
                                (DI_mean < 80 & is.na(SY_mean))~0,
                                TRUE ~ NA_real_))%>%
  dplyr::select(SEQN,bpx_metric, bpx_metric_ss, SY_mean, DI_mean,BPXCHR,BPXPLS)




## comorbidities
mcq_i <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/MCQ_I.XPT"))%>% 
  dplyr::select('SEQN', 
                'MCQ160B','MCQ180B',
                'MCQ160C','MCQ180C', ## coronary heart disease and the age first diagnosed
                'MCQ160D','MCQ180D',
                'MCQ160E','MCQ180E', ## heart attack and the age first diagnosed
                'MCQ160F','MCQ180F', ## stroke and the age first diagnosed
                'MCQ220',# MCQ220 cancer
                'MCQ300C','MCQ300A',
                'MCQ160G') 

## alcohol intake
alq_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/ALQ_I.XPT"))%>% 
  dplyr::select('SEQN','ALQ120Q','ALQ120U','ALQ130','ALQ110','ALQ101')%>%
  replace_with_na(replace = list(ALQ120Q = c(777,999),
                                 ALQ120U = c(7,9),
                                 ALQ130 = c(777,999),
                                 ALQ110 = c(7,9),
                                 ALQ101 = c(7,9)))%>%
  ## ADD is the estimate of average daily drinks
  mutate(ADD = case_when(ALQ101 == 2 ~ 0,
                         ALQ110 == 2 ~ 0,
                         ALQ120U == 1 ~ ALQ130*ALQ120Q/7,
                         ALQ120U == 2 ~ ALQ130*ALQ120Q/30,
                         ALQ120U == 3 ~ ALQ130*ALQ120Q/365,
                         TRUE ~ NA_real_))



## smoking status
## two data file regarding smoking in 2015-2016, combine to construct required variable
smq_i1 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/SMQ_I.XPT"))%>% 
  dplyr::select('SEQN','SMQ020', 'SMQ040','SMQ621')


smq_i2 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/SMQRTU_I.XPT"))%>% 
  dplyr::select('SEQN','SMQ681')

smq_i <- smq_i1 %>% full_join(smq_i2, by= 'SEQN')


smq_i$SMQ_HIST <-apply(smq_i,1,function(x){
  if(any(x[2]==2,x[4]%in% c(1,2,3,4,5,6,7),na.rm = T)){return ('Never smoker')}
  else if (!any(x[2]==2,x[4]%in% c(1,2,3,4,5,6,7),na.rm = T) & any(x[3]%in% c(1,2),x[5]==1,na.rm = T)){return ('Current smoker')}
  else if (any(x[2] ==1,x[4]==8,na.rm = T) & (!x[3] %in% c(1,2) & x[5] %in% c(2))){return ('Former smoker')}
  else if (any(x[2] ==1,x[4]==8,na.rm = T) & (x[3] %in% c(3) & !x[5] %in% c(1))){return ('Former smoker')}
  else {return ('unknown')}
})



## physical activity 
paq_i <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/PAQ_I.XPT"))%>%
  dplyr::select('SEQN','PAQ650','PAQ665','PAQ655','PAD660','PAQ670','PAD675','PAQ635','PAQ640')%>%
  ## convert special code to NA
  mutate(PAQ670 = ifelse(PAQ670 %in% c(77,99),NA,PAQ670),
         PAD675 = ifelse(PAD675 %in% c(7777,9999),NA,PAD675),
         PAQ655 = ifelse(PAQ655 %in% c(77,99),NA,PAQ655),
         PAD660 = ifelse(PAD660 %in% c(7777,9999),NA,PAD660))%>%
  mutate(moder = PAQ670*PAD675) %>%
  # vigorous-intensity = 2 * moderate-intensity
  mutate(vigor_eq = 2*PAQ655*PAD660)%>%
  ## TWMT stands for total weekly moderate-intensity-exercise time 
  ## TWMT >150 : active, TWMT < 10 :INACTIVE, TMWT in (10,150) : Insufficient active
  mutate(TWMT =rowSums(subset(.,select = c('moder','vigor_eq')), na.rm = T))%>%
  mutate(TWMT = replace(TWMT, is.na(moder)&is.na(vigor_eq), NA))%>%
  mutate(TWMT = ifelse(PAQ650 == 2 & PAQ665 == 2,0,TWMT))
 

## Physical function
pfq_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/PFQ_I.XPT"))%>%
  dplyr::select('SEQN',
                'PFQ020','PFQ030',
                'PFQ061B','PFQ061C','PFQ061H','PFQ061I',
                'PFQ063A','PFQ063B','PFQ063C','PFQ063D','PFQ063E')%>%
  mutate(adoles_limit1 = ifelse(PFQ020==1,1,0),
         adoles_limit2 = ifelse(PFQ030==1,1,0),
         adult_limit1 = ifelse(PFQ061B%in% c(3,4) | PFQ061C %in% c(3,4) | PFQ061H %in% c(3,4)| PFQ061I %in% c(3,4),1,0),
         adult_limit2 = ifelse(PFQ061B%in% c(2,3,4) | PFQ061C %in% c(2,3,4)| PFQ061H %in% c(2,3,4)| PFQ061I %in% c(2,3,4),1,0))%>%
  mutate(select_prob = ifelse((PFQ063A %in% c(19,21,25))|
                                (PFQ063B %in% c(19,21,25))|
                                (PFQ063C %in% c(19,21,25))|
                                (PFQ063D %in% c(19,21,25))|
                                (PFQ063E %in% c(19,21,25)),1,0))
  
## Weight history
whq_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/WHQ_I.XPT"))%>%
  dplyr::select('SEQN','WHD050','WHD020','WHQ070','WHD080D')%>%
  ## convert special code to NA
  replace_with_na(replace = list(WHD020 = c(7777,9999),
                                 WHD050 = c(7777,9999)))%>%
  mutate(WT_DIFF_PB = WHD050 - WHD020)



## obsesity metric
bmx_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/BMX_I.XPT")) %>%
  dplyr::select('SEQN', 'BMXWAIST','BMXBMI','BMXHT','BMXWT','BMXARMC')

## cardiovascular health
cdq_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/CDQ_I.XPT"))%>%
  dplyr::select('SEQN', 'CDQ010')

## total cholesterol 
tchol_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/TCHOL_I.XPT")) %>%
  dplyr::select('SEQN', 'LBXTC')


## Glycohemoglobin
ghb_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/GHB_I.XPT")) %>%
  dplyr::select('SEQN', 'LBXGH')

## hdl
hdl_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/HDL_I.XPT")) %>%
  dplyr::select('SEQN', 'LBDHDD')

## Ldl
ldl_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/TRIGLY_I.XPT")) %>%
  dplyr::select('SEQN', 'LBXTR','LBDLDL', 'WTSAF2YR')

## Fasting glucose
glu_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/GLU_I.XPT")) %>%
  dplyr::select('SEQN', 'LBXGLU','WTSAF2YR')

## INSULIN
ins_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/INS_I.XPT")) %>%
  dplyr::select('SEQN', 'LBXIN','WTSAF2YR')

## FASTING SUBSAMPLE
fast_i <- glu_i %>% 
  full_join(ins_i, by = c('SEQN','WTSAF2YR')) %>%
  full_join(ldl_i, by = c('SEQN','WTSAF2YR'))
  

## high sensitive CRP
hscrp_i <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/HSCRP_I.XPT")) %>%
  dplyr::select('SEQN', 'LBXHSCRP')


## BIO PROFILE
biopro_i <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/BIOPRO_I.XPT")) %>%
  dplyr::select('SEQN', 'LBXSATSI', 'LBXSASSI', 'LBXSBU','LBXSGL','LBXSLDSI',
                'LBXSKSI','LBXSCLSI','LBXSNASI','LBXSCH','LBXSTP',
                'LBXSTR','LBDSCRSI','LBXSCR',
                'LBXSC3SI','LBXSCA','LBXSIR','LBXSTB')

## prescription
rxq_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/RXQ_RX_I.XPT"))



## prescription info join with drugs
rxq_sp_i <- rxq_i %>% left_join(sp_drug, by='RXDDRGID') %>%
  dplyr::group_by(SEQN) %>%
  ## _per means per person
  summarise(acei_per = ifelse(sum(acei, na.rm=T)>0,1,0), 
            betablocker_per =ifelse( sum(betablocker, na.rm=T)>0,1,0), 
            arb_per = ifelse(sum(arb, na.rm=T)>0,1,0), 
            aspirin_per = ifelse(sum(aspirin, na.rm = T)>0,1,0),
            statin_per = ifelse(sum(statin, na.rm = T)>0,1,0),
            anti_platelet_per = ifelse(sum(anti_platelet, na.rm = T)>0,1,0),
            anti_htn_per = ifelse(sum(anti_htn, na.rm = T)>0,1,0),
            anti_hyperlipid_per = ifelse(sum(anti_hyperlipid, na.rm = T)>0,1,0),
            anti_diabetes_per = ifelse(sum(anti_diabetes, na.rm = T)>0,1,0),
            .groups = 'drop' )%>%
  mutate(optimal_regimen_per = rowSums(subset(., select=c(anti_htn_per, anti_hyperlipid_per, anti_platelet_per))))




## rxq reason
rxq_main_reason_i <-rxq_i %>% 
  mutate(main_reason1 = grepl('^I[2-][0-9]',RXDRSC1),
         main_reason2 = grepl('^I[2-][0-9]',RXDRSC2),
         main_reason3 = grepl('^I[2-][0-9]',RXDRSC3),
         main_reason = main_reason1|main_reason2|main_reason3) %>%
   dplyr::group_by(SEQN) %>%
   dplyr::summarise(cvd_main_reason = ifelse(sum(main_reason, na.rm=T)>0,1,0))
  


## pregnancy
rhq_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/RHQ_I.XPT"))%>%
  select(SEQN, RHD143)



## DXX
dxx_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/DXX_I.XPT")) %>% 
  dplyr::select('SEQN', 
                'DXDTOPF','DXDTOBMD',
                'DXXLABMD','DXDLAPF',
                'DXXLLBMD','DXDLLPF',
                'DXXRABMD','DXDRAPF',
                'DXXRLBMD','DXDRLPF',
                'DXDTRBMD','DXDTRPF',
                'DXDLALE','DXDRALE',
                'DXDLLLE','DXDRLLE',
                'DXDTRLE','DXXTRFAT',
                'DXXLAFAT','DXXRAFAT',
                'DXXLLFAT','DXXRLFAT',
                'DXDTOFAT','DXDTOLE',
                'DXDTOBMD')



diet_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/DR1TOT_I.XPT"))%>%
  select(SEQN, DR1DAY,DR1DRSTZ, DR1TKCAL,DR1TPROT,DR1TCARB,DR1TTFAT,DR1TSFAT,DR1TMFAT,DR1TPFAT,
         DR1TCHOL,DR1TFIBE,DR1TVB1,DR1TVB2,DR1TNIAC,DR1TVB6,DR1TFOLA,DR1TVB12,DR1TVC,DR1TATOC,
         DR1TCALC,DR1TPHOS,DR1TMAGN, DR1TIRON,DR1TZINC,DR1TCOPP,DR1TSODI,DR1TPOTA,DR1TSELE,DR1TCAFF,
         DR1TTHEO,DR1TALCO,DR1TMOIS,
         DR1TS040,DR1TS060,DR1TS080,DR1TS100,DR1TS120,DR1TS140,DR1TS160,DR1TS180,
         DR1TM161,DR1TM181,DR1TM201,DR1TM221,
         DR1TP182,DR1TP183,DR1TP184,DR1TP204,DR1TP205,DR1TP225,DR1TP226,
         DR1_300, DR1_320Z)%>%
  rename(DAY_DIET =  DR1DAY,
         STATUS_DIET=DR1DRSTZ,
         CALORIE_DIET =DR1TKCAL,
         PROTEIN_DIET = DR1TPROT,
         CARB_DIET= DR1TCARB,
         FAT_DIET = DR1TTFAT,
         SFAT_DIET =DR1TSFAT,
         MFAT_DIET = DR1TMFAT,
         PFAT__DIET = DR1TPFAT,
         CHOL_DIET = DR1TCHOL,
         FIBE_DIET = DR1TFIBE,
         VB1_DIET = DR1TVB1,
         VB2_DIET = DR1TVB2,
         NIAC_DIET = DR1TNIAC,
         VB6_DIET = DR1TVB6,
         FOLATE_DIET = DR1TFOLA,
         VB12_DIET = DR1TVB12,
         VC_DIET = DR1TVC,
         VE_DIET = DR1TATOC,
         CALC_DIET= DR1TCALC,
         PHOS_DIET = DR1TPHOS,
         MG_DIET = DR1TMAGN,
         IRON_DIET = DR1TIRON,
         ZINC_DIET = DR1TZINC,
         COPP_DIET = DR1TCOPP,
         SODI_DIET = DR1TSODI,
         POTA_DIET = DR1TPOTA,
         SELE_DIET = DR1TSELE,
         CAFF_DIET = DR1TCAFF,
         THEO_DIET = DR1TTHEO,
         ALCO_DIET = DR1TALCO,
         MOIS_DIET = DR1TMOIS,
         COMPARE = DR1_300, 
         TOTWATER = DR1_320Z,
         TS040 = DR1TS040,
         TS060 = DR1TS060,
         TS080 = DR1TS080,
         TS100 = DR1TS100,
         TS120 = DR1TS120,
         TS140 = DR1TS140,
         TS160 = DR1TS160,
         TS180 = DR1TS180,
         TM161 = DR1TM161,
         TM181 = DR1TM181,
         TM201 = DR1TM201,
         TM221 = DR1TM221,
         TP182 = DR1TP182,
         TP183 = DR1TP183,
         TP184 = DR1TP184,
         TP204 = DR1TP204,
         TP205 = DR1TP205,
         TP225 = DR1TP225,
         TP226 = DR1TP226)%>%
  mutate(IS_WEEKEND_DIET = ifelse(DAY_DIET %in% c(1,6,7),1,0),## friday, sunday or saturday
         COMPARE_USUAL = ifelse(COMPARE ==1,1,0),
         COMPARE_LESS = ifelse(COMPARE ==2,1,0),
         COMPARE_MORE = ifelse(COMPARE ==3,1,0))%>%
  filter(STATUS_DIET==1)%>%
  dplyr::select(SEQN, IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
                CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226)



## urine content
urine_i <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/ALB_CR_I.XPT"))%>%
  dplyr::mutate(albuminuria = (URXUMS/URXUCR)*100)


## combine
comb_i <- demo_i %>% left_join(hiq_i, by='SEQN')%>%  left_join(ocq_i, by='SEQN')%>% left_join(diq_i, by='SEQN')%>%  
  left_join(bpq_i, by='SEQN')%>%left_join(bpx_i, by='SEQN')%>%left_join(mcq_i, by='SEQN')%>% 
  left_join(alq_i, by='SEQN')%>% left_join(smq_i, by='SEQN')%>% left_join(paq_i, by='SEQN')%>% 
  left_join(bmx_i, by='SEQN')%>% left_join(tchol_i, by='SEQN')%>% left_join(ghb_i, by='SEQN')%>% 
  left_join(rxq_sp_i, by='SEQN')%>% left_join(rhq_i, by='SEQN')%>%left_join(hdl_i, by='SEQN')%>% 
  left_join(fast_i, by = 'SEQN')%>% left_join(hscrp_i, by = 'SEQN') %>%
  left_join(biopro_i, by = 'SEQN') %>%
  left_join(rxq_main_reason_i, by = 'SEQN')%>%
  left_join(pfq_i, by = 'SEQN')%>%
  left_join(whq_i, by = 'SEQN')%>%
  left_join(dxx_i, by = 'SEQN')%>%
  left_join(cdq_i, by = 'SEQN')%>%
  left_join(diet_i, by = 'SEQN')%>%
  left_join(urine_i, by = 'SEQN')
  


#sp stands for secondary prevention

VO2MAX2015 <- comb_i %>% 
  mutate(seqn = SEQN,
         time = 9,  
         year = '2015',
         age = RIDAGEYR,
         gender = case_when(RIAGENDR == 1 ~ 'Male',
                            RIAGENDR == 2 ~ 'Female',
                            TRUE ~ NA_character_),
         educ = case_when((DMDEDUC3 %in% c(0,1,2,3,4,5,6,7,8,9,10,11,12,55,66))|(DMDEDUC2 %in% c(1,2)) ~ 'Less than high school',
                         (DMDEDUC3 %in% c(13,14))|(DMDEDUC2 == 3) ~ 'High school diploma or GED',
                         (DMDEDUC3 == 15)|(DMDEDUC2 %in% c(4,5)) ~'Greater than high school',
                         TRUE ~ NA_character_),
         race_ethn = case_when( RIDRETH3 %in% c(1,2) ~ 'Hispanic',
                                RIDRETH3 == 3 ~ 'Non-Hispanic White',
                                RIDRETH3 == 4 ~ 'Non-Hispanic Black',
                                TRUE ~ 'Other'),
         race_ethn2 = case_when( RIDRETH3 %in% c(1,2) ~ 'Hispanic',
                                RIDRETH3 == 3 ~ 'Non-Hispanic White',
                                RIDRETH3 == 4 ~ 'Non-Hispanic Black',
                                RIDRETH3 == 6 ~ 'Non-Hispanic Asian',
                                TRUE ~ NA_character_),
         marital_status = case_when(DMDMARTL %in% c(1,6) ~ 'married/live with other',
                                     DMDMARTL %in% c(2,3,4,5) ~ 'other',
                                     TRUE ~ NA_character_),
         family_income = case_when(INDFMPIR >=2 ~ 'High/Middle income',
                                    INDFMPIR < 2 ~ 'Low income',
                                    TRUE ~ NA_character_),
         health_insurance = case_when(HIQ011 == 1 ~ 1L, 
                                       HIQ011 == 2 ~ 0L,
                                       TRUE ~ NA_integer_),
         employment_status = case_when(OCD150 %in% c(1,2) ~ 'Working',
                                       (OCD150 == 3) ~'Unemployed',
                                       (OCD150==4 & OCQ380 ==5)~'Unemployed',
                                       OCD150 == 4 & OCQ380 %in% c(1,2,3,4,6) ~ 'Not in labor force',
                                        TRUE ~ NA_character_),
         htn_history = case_when(BPQ020 == 1 ~ 1L,
                              BPQ020 == 2 ~ 0L,
                              TRUE ~ NA_integer_),
         htn_treatment = case_when(BPQ050A == 1 | anti_htn_per ~ 1L,
                              TRUE ~ 0L),
         high_chol_history = case_when(BPQ080 == 1 ~ 1L,
                                    BPQ080 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         high_chol_treatment = case_when(BPQ100D == 1 | anti_hyperlipid_per ~ 1L,
                              TRUE ~ 0L),
         diab_history= case_when(DIQ010 ==1 ~1L,
                              DIQ010 %in% c(2,3) ~ 0L,
                              TRUE ~ NA_integer_),
         diab_treatment = case_when(DIQ050 == 1|DIQ070==1|anti_diabetes_per~ 1L,
                              TRUE ~ 0L),
         cancer_history = case_when(MCQ220 == 1 ~ 1L,
                                    MCQ220 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         CD_history = case_when(MCQ160B==1|MCQ160C==1|MCQ160D==1|MCQ160E==1|MCQ160F==1|cvd_main_reason==1 ~ 1L,
                              TRUE ~ 0L),
         first_cd_age = case_when(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F) ~ NA_real_,
                                   !(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F))~ pmin(MCQ180B,MCQ180C,MCQ180D,MCQ180E,MCQ180F,na.rm = T)),
         close_relatives_heartattack = case_when(MCQ300A == 1 ~ 1L,
                                    MCQ300A == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         close_relatives_diabetes = case_when(MCQ300C == 1 ~ 1L,
                                    MCQ300C == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         alcohol_intake = case_when(age <20 ~ 'Never drinker',
                                    ALQ110 == 2 ~ 'Never drinker',
                                    ALQ110 == 1 & ADD ==0 ~ 'Former drinker',
                                    ALQ110 == 1 & ALQ101 == 2 ~ 'Former drinker',
                                    ADD>0 & ADD<0.5 ~ 'Light drinker',
                                    ADD>=0.5 & ADD<2.5 & RIAGENDR == 1 ~ 'Moderate drinker',
                                    ADD>=0.5 & ADD<1.5 & RIAGENDR == 2 ~ 'Moderate drinker',
                                    ADD>=2.5 & RIAGENDR == 1 ~ 'Heavier drinker',
                                    ADD>=1.5 & RIAGENDR == 2 ~ 'Heavier drinker',
                                    TRUE ~ NA_character_),
         smoking_status = case_when(SMQ_HIST == 'Never smoker'  ~ 'Never smoker',
                                    SMQ_HIST == 'Former smoker' ~ 'Former smoker',
                                    SMQ_HIST == 'Current smoker' ~ 'Current smoker',
                                     TRUE ~ NA_character_),
         physical_activity = case_when(PAQ650 == 2 & PAQ665 == 2 ~ 'Inactive',
                                       TWMT < 10 ~ 'Inactive',
                                       TWMT >= 10 & TWMT < 150 ~ 'Insufficient active',
                                       TWMT >= 150 ~ 'Active',
                                       TRUE ~ NA_character_),
         pregnant = case_when((RHD143 == 1 )|(RIDEXPRG==1) ~ 1L,
                               TRUE ~ 0L),
         WT_DIFF_KG = WT_DIFF_PB*0.45359237,
         lwlstyr = case_when(WHQ070 == 1 ~ 1L,
                             WHQ070 == 2 ~ 0L,
                               TRUE ~ NA_integer_),
         exerc2lwlastyr = case_when(WHD080D == 13 ~ 1L,
                                    (is.na(WHD080D) & WHQ070 == 1)|(WHQ070 == 2)  ~ 0L,
                                    TRUE ~ NA_integer_),
         walk_bicycle_times_wk = case_when(PAQ635 == 2 ~ 0L,
                                           PAQ635 == 1 & PAQ640<20 ~ as.integer(PAQ640),
                                           TRUE ~ NA_integer_),
         overweight = case_when(race_ethn2 != 'Non-Hispanic Asian' & BMXBMI >=25 ~ 1L,
                                race_ethn2 != 'Non-Hispanic Asian' & BMXBMI < 25 ~ 0L,
                                race_ethn2 == 'Non-Hispanic Asian' & BMXBMI >=23 ~ 1L,
                                race_ethn2 == 'Non-Hispanic Asian' & BMXBMI < 23 ~ 0L,
                                TRUE ~ NA_integer_),
         overall_obesity = case_when(race_ethn2 != 'Non-Hispanic Asian' & BMXBMI >=30 ~ 1L,
                                     race_ethn2 != 'Non-Hispanic Asian' & BMXBMI < 30 ~ 0L,
                                     race_ethn2 == 'Non-Hispanic Asian' & BMXBMI >=27.5 ~ 1L,
                                     race_ethn2 == 'Non-Hispanic Asian' & BMXBMI < 27.5 ~ 0L,
                                     TRUE ~ NA_integer_),
         abdominal_obesity = case_when(race_ethn2 != 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST >=102 ~ 1L,
                                       race_ethn2 != 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST < 102 ~ 0L,
                                       race_ethn2 != 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST >= 88 ~ 1L,
                                       race_ethn2 != 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST <  88 ~ 0L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST >=  90 ~ 1L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST <  90 ~ 0L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST >=  80 ~ 1L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST <  80 ~ 0L,
                                       TRUE ~ NA_integer_),
         HBF1 = case_when(DXDTOPF >= 25 & RIAGENDR == 1 ~ 1L,
                         DXDTOPF < 25 & RIAGENDR == 1 ~ 0L,
                         DXDTOPF >= 35 & RIAGENDR == 2 ~ 1L,
                         DXDTOPF < 35 & RIAGENDR == 2 ~ 0L,
                         TRUE~ NA_integer_),
         HBF2 = case_when(DXDTOPF >= 28 & RIAGENDR == 1 ~ 1L,
                         DXDTOPF < 28 & RIAGENDR == 1 ~ 0L,
                         DXDTOPF >= 38 & RIAGENDR == 2 ~ 1L,
                         DXDTOPF < 38 & RIAGENDR == 2 ~ 0L,
                         TRUE~ NA_integer_),
         diab_now = case_when(diab_treatment==1L|LBXGH >=6.5|LBXGLU >=126 ~ 1L, ## oral glu tolerance was added from 2011
                              is.na(diab_treatment)&is.na(LBXGH )&is.na(LBXGLU) ~ NA_integer_,
                              TRUE ~ 0L),
         htn_now = case_when(htn_treatment==1L|SY_mean>=140|DI_mean>=90 ~ 1L,
                             is.na(htn_treatment)&is.na(SY_mean)&is.na(DI_mean) ~ NA_integer_,
                             TRUE ~0L),
         highchol_now = case_when(high_chol_treatment==1L |LBXTC>=240|LBDLDL>=160 ~ 1L,
                                  is.na(high_chol_treatment)&is.na(LBXTC)&is.na(LBDLDL) ~ NA_integer_,
                                  TRUE ~ 0L),
         short_breathe = case_when(CDQ010 ==1 ~ 1L,
                                   TRUE ~ 0L))%>%
  mutate(LDL = LBDLDL,
         HDL = LBDHDD,
         TOTAL_CHOL = LBXTC,
         FAST_GLU = LBXGLU,
         HBA1C = LBXGH,
         HSCRP = LBXHSCRP,
         FAST_INSULIN = LBXIN,
         FAST_TRI = LBXTR,
         ALT = LBXSATSI,
         AST = LBXSASSI,
         BUN = LBXSBU,
         GLU = LBXSGL,
         LDH = LBXSLDSI,
         POTAS = LBXSKSI,
         CHL = LBXSCLSI,
         SODI = LBXSNASI,
         CHOL = LBXSCH,
         TOTPRO = LBXSTP,
         CREATININE = LBXSCR,
         BILIRUBIN= LBXSTB,
         IRON = LBXSIR,
         CALCIUM = LBXSCA,
         BICARBONATE = LBXSC3SI)%>%
  select(seqn,time,year,age,gender,educ, race_ethn, marital_status,INDFMPIR, family_income, health_insurance, employment_status,
         SDMVPSU,SDMVSTRA,WTINT2YR,WTMEC2YR,WTSAF2YR,
         SY_mean, DI_mean, BMXBMI,BMXWAIST,BMXHT, bpx_metric,bpx_metric_ss,BPXCHR,BPXPLS,BMXWT,WT_DIFF_KG,BMXARMC,
         alcohol_intake,smoking_status,physical_activity,pregnant,lwlstyr, exerc2lwlastyr,walk_bicycle_times_wk,ADD, TWMT, short_breathe,
         overweight, overall_obesity, abdominal_obesity, HBF1,HBF2,
         htn_history, high_chol_history,diab_history, cancer_history, CD_history, first_cd_age,close_relatives_heartattack,close_relatives_diabetes,
         diab_now, htn_now,highchol_now,
         htn_treatment, high_chol_treatment, diab_treatment,aspirin_per, statin_per,acei_per,arb_per,betablocker_per,optimal_regimen_per, 
         LDL,HDL,TOTAL_CHOL,FAST_GLU,HBA1C,FAST_INSULIN,FAST_TRI,ALT,AST,BUN,GLU,LDH,POTAS,CHL,SODI,CHOL,TOTPRO, LBDSCRSI,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         DXDTOPF,DXXLABMD,DXDLAPF, DXXLLBMD, DXDLLPF,DXXRABMD,DXDRAPF , DXXRLBMD ,DXDRLPF , DXDTRBMD ,DXDTRPF,
         DXDLALE,DXDRALE,DXDLLLE,DXDRLLE,DXDTRLE,DXXTRFAT,DXXLAFAT,DXXRAFAT,DXXLLFAT,DXXRLFAT,DXDTOFAT,DXDTOLE,DXDTOBMD,
         IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
                CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226,
         DIQ080,MCQ160G,adoles_limit1,adoles_limit2,adult_limit1,adult_limit2,select_prob)


VO2MAX2015_BASIC <- VO2MAX2015 %>%
  select(seqn,time,year,age,gender,educ, race_ethn, marital_status,INDFMPIR, family_income, health_insurance, employment_status,
         SDMVPSU,SDMVSTRA,WTINT2YR,WTMEC2YR,WTSAF2YR,
         SY_mean, DI_mean, BMXBMI,BMXWAIST,BMXHT, bpx_metric,bpx_metric_ss,BPXCHR,BPXPLS,BMXWT,WT_DIFF_KG,BMXARMC,
         alcohol_intake,smoking_status,physical_activity,pregnant,lwlstyr, exerc2lwlastyr,walk_bicycle_times_wk,ADD, TWMT, short_breathe,
         overweight, overall_obesity, abdominal_obesity, 
         htn_history, high_chol_history,diab_history, cancer_history, CD_history, first_cd_age,close_relatives_heartattack,close_relatives_diabetes,
         diab_now, htn_now,highchol_now,
         htn_treatment, high_chol_treatment, diab_treatment,aspirin_per, statin_per,acei_per,arb_per,betablocker_per,optimal_regimen_per, 
         LDL,HDL,TOTAL_CHOL,FAST_GLU,HBA1C,FAST_INSULIN,FAST_TRI,ALT,AST,BUN,GLU,LDH,POTAS,CHL,SODI,CHOL,TOTPRO,
         LBDSCRSI,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         DIQ080,MCQ160G,adoles_limit1,adoles_limit2,adult_limit1,adult_limit2,select_prob)

## write to csv file
# VO2MAX2015%>% write.csv(paste0(wd_path,'/VO2MAX2015.csv'))
# VO2MAX2015_BASIC%>% write.csv(paste0(wd_path,'/VO2MAX2015_BASIC.csv'))
```



## 2017-2018
```{r}
## demographic infos
demo_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/DEMO_J.XPT"))%>%
  dplyr::select('SEQN','SDDSRVYR','RIDAGEYR','RIAGENDR','RIDRETH1','RIDRETH3','DMDEDUC2','DMDEDUC3','DMDMARTL','INDFMIN2','INDFMPIR','WTINT2YR','WTMEC2YR','SDMVPSU','SDMVSTRA','RIDEXPRG') 

## health insurance status
hiq_j <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/HIQ_J.XPT"))%>%
  dplyr::select('SEQN', 'HIQ011')

## occupation/employment status
ocq_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/OCQ_J.XPT"))%>% 
  dplyr::select('SEQN','OCD150','OCQ380')

## diabetes history
diq_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/DIQ_J.XPT"))%>% 
  dplyr::select('SEQN', 'DIQ010', 'DIQ050','DIQ070','DIQ080')


## hypertension and cholesterol history 
bpq_j <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/BPQ_J.XPT"))%>%
  dplyr::select('SEQN', 'BPQ020','BPQ050A','BPQ080','BPQ100D')


## bp measurement
bpx_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/BPX_J.XPT"))%>% 
  dplyr::select('SEQN','BPXSY1','BPXSY2','BPXSY3','BPXSY4','BPXDI1','BPXDI2','BPXDI3','BPXDI4','BPXCHR','BPXPLS')%>%
  mutate(SY_mean =rowMeans(subset(.,select = c('BPXSY1','BPXSY2','BPXSY3','BPXSY4')), na.rm = TRUE))%>%
  mutate(DI_mean =rowMeans(subset(.,select = c('BPXDI1','BPXDI2','BPXDI3','BPXDI4')), na.rm = TRUE))%>%
  # metric for htn 1: not control
  mutate(bpx_metric = case_when(SY_mean >= 140 | DI_mean >=90 ~ 1,
                                (SY_mean < 140 & DI_mean < 90)~0,
                                (SY_mean < 140 & is.na(DI_mean))~0,
                                (DI_mean < 90 & is.na(SY_mean))~0,
                                TRUE ~ NA_real_))%>%
  # ss stands for sensitivity
  mutate(bpx_metric_ss = case_when(SY_mean >= 130 | DI_mean >=80 ~ 1,
                                (SY_mean < 130 & DI_mean < 80)~0,
                                (SY_mean < 130 & is.na(DI_mean))~0,
                                (DI_mean < 80 & is.na(SY_mean))~0,
                                TRUE ~ NA_real_))%>%
  dplyr::select(SEQN,bpx_metric, bpx_metric_ss, SY_mean, DI_mean, BPXCHR,BPXPLS)




## comorbidities
mcq_j <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/MCQ_J.XPT"))%>% 
  dplyr::select('SEQN', 
                'MCQ160B','MCD180B',
                'MCQ160C','MCD180C', ## coronary heart disease and the age first diagnosed
                'MCQ160D','MCD180D',
                'MCQ160E','MCD180E', ## heart attack and the age first diagnosed
                'MCQ160F','MCD180F', ## stroke and the age first diagnosed
                'MCQ220',# MCQ220 cancer
                'MCQ300C','MCQ300A',
                'MCQ160G') 


## alcohol intake
alq_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/ALQ_J.XPT"))%>% 
  dplyr::select('SEQN','ALQ121','ALQ130','ALQ111')%>%
  ## ADD is the estimate of average daily drinks
  mutate(ADD = case_when(ALQ111 == 2 ~ 0,
                         ALQ121 %in% c(1,2) ~ ALQ130,
                         ALQ121 == 3 ~ ALQ130*183/365,
                         ALQ121 == 4 ~ ALQ130*2*52/365,
                         ALQ121 == 5 ~ ALQ130*52/365,
                         ALQ121 == 6 ~ ALQ130*30/365,
                         ALQ121 == 7 ~ ALQ130*12/365,
                         ALQ121 == 8 ~ ALQ130*9/365,
                         ALQ121 == 9 ~ ALQ130*5/365,
                         ALQ121 == 10 ~ ALQ130*2/365,
                         TRUE ~ NA_real_))


  
  
## smoking status
## two data file regarding smoking in 2017-2018, combine to construct required variable
smq_j1 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/SMQ_J.XPT"))%>% 
  dplyr::select('SEQN','SMQ020', 'SMQ040','SMQ621')


smq_j2 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/SMQRTU_J.XPT"))%>% 
  dplyr::select('SEQN','SMQ681')

smq_j <- smq_j1 %>% full_join(smq_j2, by= 'SEQN')


smq_j$SMQ_HIST <-apply(smq_j,1,function(x){
  if(any(x[2]==2,x[4]%in% c(1,2,3,4,5,6,7),na.rm = T)){return ('Never smoker')}
  else if (!any(x[2]==2,x[4]%in% c(1,2,3,4,5,6,7),na.rm = T) & any(x[3]%in% c(1,2),x[5]==1,na.rm = T)){return ('Current smoker')}
  else if (any(x[2] ==1,x[4]==8,na.rm = T) & (!x[3] %in% c(1,2) & x[5] %in% c(2))){return ('Former smoker')}
  else if (any(x[2] ==1,x[4]==8,na.rm = T) & (x[3] %in% c(3) & !x[5] %in% c(1))){return ('Former smoker')}
  else {return ('unknown')}
})





## physical activity 
paq_j <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/PAQ_J.XPT"))%>%
  dplyr::select('SEQN','PAQ650','PAQ665','PAQ655','PAD660','PAQ670','PAD675','PAQ635','PAQ640')%>%
  ## convert special code to NA
  mutate(PAQ670 = ifelse(PAQ670 %in% c(77,99),NA,PAQ670),
         PAD675 = ifelse(PAD675 %in% c(7777,9999),NA,PAD675),
         PAQ655 = ifelse(PAQ655 %in% c(77,99),NA,PAQ655),
         PAD660 = ifelse(PAD660 %in% c(7777,9999),NA,PAD660))%>%
  mutate(moder = PAQ670*PAD675) %>%
  # vigorous-intensity = 2 * moderate-intensity
  mutate(vigor_eq = 2*PAQ655*PAD660)%>%
  ## TWMT stands for total weekly moderate-intensity-exercise time 
  ## TWMT >150 : active, TWMT < 10 :INACTIVE, TMWT in (10,150) : Insufficient active
  mutate(TWMT =rowSums(subset(.,select = c('moder','vigor_eq')), na.rm = T))%>%
  mutate(TWMT = replace(TWMT, is.na(moder)&is.na(vigor_eq), NA))%>%
  mutate(TWMT = ifelse(PAQ650 == 2 & PAQ665 == 2,0,TWMT))


## Physical function
pfq_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/PFQ_J.XPT"))%>%
  dplyr::select('SEQN',
                'PFQ020','PFQ030',
                'PFQ061B','PFQ061C','PFQ061H','PFQ061I',
                'PFQ063A','PFQ063B','PFQ063C','PFQ063D','PFQ063E')%>%
  mutate(adoles_limit1 = ifelse(PFQ020==1,1,0),
         adoles_limit2 = ifelse(PFQ030==1,1,0),
         adult_limit1 = ifelse(PFQ061B%in% c(3,4) | PFQ061C %in% c(3,4) | PFQ061H %in% c(3,4)| PFQ061I %in% c(3,4),1,0),
         adult_limit2 = ifelse(PFQ061B%in% c(2,3,4) | PFQ061C %in% c(2,3,4)| PFQ061H %in% c(2,3,4)| PFQ061I %in% c(2,3,4),1,0))%>%
  mutate(select_prob = ifelse((PFQ063A %in% c(19,21,25))|
                                (PFQ063B %in% c(19,21,25))|
                                (PFQ063C %in% c(19,21,25))|
                                (PFQ063D %in% c(19,21,25))|
                                (PFQ063E %in% c(19,21,25)),1,0))
  
## Weight history
whq_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/WHQ_J.XPT"))%>%
  dplyr::select('SEQN','WHD050','WHD020','WHQ070','WHD080D')%>%
  ## convert special code to NA
  replace_with_na(replace = list(WHD020 = c(7777,9999),
                                 WHD050 = c(7777,9999)))%>%
  mutate(WT_DIFF_PB = WHD050 - WHD020)

## obsesity metric
bmx_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/BMX_J.XPT")) %>%
  dplyr::select('SEQN', 'BMXWAIST','BMXBMI','BMXWT','BMXHT','BMXARMC')

## cardiovascular health
cdq_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/CDQ_J.XPT"))%>%
  dplyr::select('SEQN', 'CDQ010')

## total cholesterol 
tchol_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/TCHOL_J.XPT")) %>%
  dplyr::select('SEQN', 'LBXTC')


## Glycohemoglobin
ghb_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/GHB_J.XPT")) %>%
  dplyr::select('SEQN', 'LBXGH')

## hdl
hdl_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/HDL_J.XPT")) %>%
  dplyr::select('SEQN', 'LBDHDD')

## Ldl
ldl_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/TRIGLY_J.XPT")) %>%
  dplyr::select('SEQN', 'LBXTR','LBDLDL', 'WTSAF2YR')

## Fasting glucose
glu_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/GLU_J.XPT")) %>%
  dplyr::select('SEQN', 'LBXGLU','WTSAF2YR')

## INSULIN
ins_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/INS_J.XPT")) %>%
  dplyr::select('SEQN', 'LBXIN','WTSAF2YR')

## FASTING SUBSAMPLE
fast_j <- glu_j %>% 
  full_join(ins_j, by = c('SEQN','WTSAF2YR')) %>%
  full_join(ldl_j, by = c('SEQN','WTSAF2YR'))
  

## high sensitive CRP
hscrp_j <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/HSCRP_J.XPT")) %>%
  dplyr::select('SEQN', 'LBXHSCRP')


## BIO PROFILE
biopro_j <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/BIOPRO_J.XPT")) %>%
  dplyr::select('SEQN', 'LBXSATSI', 'LBXSASSI', 'LBXSBU','LBXSGL','LBXSLDSI',
                'LBXSKSI','LBXSCLSI','LBXSNASI','LBXSCH','LBXSTP',
                'LBXSTR','LBDSCRSI','LBXSCR',
                'LBXSC3SI','LBXSCA','LBXSIR','LBXSTB' )

## prescription
rxq_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/RXQ_RX_J.XPT"))



## prescription info join with drugs
rxq_sp_j <- rxq_j %>% left_join(sp_drug, by='RXDDRGID') %>%
  dplyr::group_by(SEQN) %>%
  ## _per means per person
  summarise(acei_per = ifelse(sum(acei, na.rm=T)>0,1,0), 
            betablocker_per =ifelse( sum(betablocker, na.rm=T)>0,1,0), 
            arb_per = ifelse(sum(arb, na.rm=T)>0,1,0), 
            aspirin_per = ifelse(sum(aspirin, na.rm = T)>0,1,0),
            statin_per = ifelse(sum(statin, na.rm = T)>0,1,0),
            anti_platelet_per = ifelse(sum(anti_platelet, na.rm = T)>0,1,0),
            anti_htn_per = ifelse(sum(anti_htn, na.rm = T)>0,1,0),
            anti_hyperlipid_per = ifelse(sum(anti_hyperlipid, na.rm = T)>0,1,0),
            anti_diabetes_per = ifelse(sum(anti_diabetes, na.rm = T)>0,1,0),
            .groups = 'drop' )%>%
  mutate(optimal_regimen_per = rowSums(subset(., select=c(anti_htn_per, anti_hyperlipid_per, anti_platelet_per))))


## rxq reason

rxq_main_reason_j <-rxq_j %>% 
  mutate(main_reason1 = grepl('^I[2-][0-9]',RXDRSC1),
         main_reason2 = grepl('^I[2-][0-9]',RXDRSC2),
         main_reason3 = grepl('^I[2-][0-9]',RXDRSC3),
         main_reason = main_reason1|main_reason2|main_reason3) %>%
   dplyr::group_by(SEQN) %>%
   dplyr::summarise(cvd_main_reason = ifelse(sum(main_reason, na.rm=T)>0,1,0))
  

## pregnancy
rhq_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/RHQ_J.XPT"))%>%
  select(SEQN, RHD143)


## DXX
dxx_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/DXX_J.XPT")) %>% 
  dplyr::select('SEQN', 
                'DXDTOPF','DXDTOBMD',
                'DXXLABMD','DXDLAPF',
                'DXXLLBMD','DXDLLPF',
                'DXXRABMD','DXDRAPF',
                'DXXRLBMD','DXDRLPF',
                'DXDTRBMD','DXDTRPF',
                'DXDLALE','DXDRALE',
                'DXDLLLE','DXDRLLE',
                'DXDTRLE','DXXTRFAT',
                'DXXLAFAT','DXXRAFAT',
                'DXXLLFAT','DXXRLFAT',
                'DXDTOFAT','DXDTOLE',
                'DXDTOBMD')


diet_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/DR1TOT_J.XPT"))%>%
  select(SEQN, DR1DAY,DR1DRSTZ, DR1TKCAL,DR1TPROT,DR1TCARB,DR1TTFAT,DR1TSFAT,DR1TMFAT,DR1TPFAT,
         DR1TCHOL,DR1TFIBE,DR1TVB1,DR1TVB2,DR1TNIAC,DR1TVB6,DR1TFOLA,DR1TVB12,DR1TVC,DR1TATOC,
         DR1TCALC,DR1TPHOS,DR1TMAGN, DR1TIRON,DR1TZINC,DR1TCOPP,DR1TSODI,DR1TPOTA,DR1TSELE,DR1TCAFF,
         DR1TTHEO,DR1TALCO,DR1TMOIS,
         DR1TS040,DR1TS060,DR1TS080,DR1TS100,DR1TS120,DR1TS140,DR1TS160,DR1TS180,
         DR1TM161,DR1TM181,DR1TM201,DR1TM221,
         DR1TP182,DR1TP183,DR1TP184,DR1TP204,DR1TP205,DR1TP225,DR1TP226,
         DR1_300, DR1_320Z)%>%
  rename(DAY_DIET =  DR1DAY,
         STATUS_DIET=DR1DRSTZ,
         CALORIE_DIET =DR1TKCAL,
         PROTEIN_DIET = DR1TPROT,
         CARB_DIET= DR1TCARB,
         FAT_DIET = DR1TTFAT,
         SFAT_DIET =DR1TSFAT,
         MFAT_DIET = DR1TMFAT,
         PFAT__DIET = DR1TPFAT,
         CHOL_DIET = DR1TCHOL,
         FIBE_DIET = DR1TFIBE,
         VB1_DIET = DR1TVB1,
         VB2_DIET = DR1TVB2,
         NIAC_DIET = DR1TNIAC,
         VB6_DIET = DR1TVB6,
         FOLATE_DIET = DR1TFOLA,
         VB12_DIET = DR1TVB12,
         VC_DIET = DR1TVC,
         VE_DIET = DR1TATOC,
         CALC_DIET= DR1TCALC,
         PHOS_DIET = DR1TPHOS,
         MG_DIET = DR1TMAGN,
         IRON_DIET = DR1TIRON,
         ZINC_DIET = DR1TZINC,
         COPP_DIET = DR1TCOPP,
         SODI_DIET = DR1TSODI,
         POTA_DIET = DR1TPOTA,
         SELE_DIET = DR1TSELE,
         CAFF_DIET = DR1TCAFF,
         THEO_DIET = DR1TTHEO,
         ALCO_DIET = DR1TALCO,
         MOIS_DIET = DR1TMOIS,
         COMPARE = DR1_300, 
         TOTWATER = DR1_320Z,
         TS040 = DR1TS040,
         TS060 = DR1TS060,
         TS080 = DR1TS080,
         TS100 = DR1TS100,
         TS120 = DR1TS120,
         TS140 = DR1TS140,
         TS160 = DR1TS160,
         TS180 = DR1TS180,
         TM161 = DR1TM161,
         TM181 = DR1TM181,
         TM201 = DR1TM201,
         TM221 = DR1TM221,
         TP182 = DR1TP182,
         TP183 = DR1TP183,
         TP184 = DR1TP184,
         TP204 = DR1TP204,
         TP205 = DR1TP205,
         TP225 = DR1TP225,
         TP226 = DR1TP226)%>%
  mutate(IS_WEEKEND_DIET = ifelse(DAY_DIET %in% c(1,6,7),1,0),## friday, sunday or saturday
         COMPARE_USUAL = ifelse(COMPARE ==1,1,0),
         COMPARE_LESS = ifelse(COMPARE ==2,1,0),
         COMPARE_MORE = ifelse(COMPARE ==3,1,0))%>%
  filter(STATUS_DIET==1)%>%
  dplyr::select(SEQN, IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
                CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226)


## urine content
urine_j <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/ALB_CR_J.XPT"))%>%
  dplyr::mutate(albuminuria = (URXUMS/URXUCR)*100)



## combine
comb_j <- demo_j %>% left_join(hiq_j, by='SEQN')%>%  left_join(ocq_j, by='SEQN')%>% 
  left_join(diq_j, by='SEQN')%>%left_join(bpq_j, by='SEQN')%>%
  left_join(bpx_j, by='SEQN')%>%left_join(mcq_j, by='SEQN')%>% 
  left_join(alq_j, by='SEQN')%>% left_join(smq_j, by='SEQN')%>% left_join(paq_j, by='SEQN')%>% 
  left_join(bmx_j, by='SEQN')%>% left_join(tchol_j, by='SEQN')%>% left_join(ghb_j, by='SEQN')%>% 
  left_join(rxq_sp_j, by='SEQN')%>% left_join(rhq_j, by='SEQN')%>% left_join(hdl_j, by = 'SEQN')%>%
  left_join(fast_j, by = 'SEQN')%>% left_join(hscrp_j, by = 'SEQN') %>%
  left_join(biopro_j, by = 'SEQN') %>%
  left_join(rxq_main_reason_j, by = 'SEQN')%>%
  left_join(pfq_j, by = 'SEQN')%>%
  left_join(whq_j, by = 'SEQN')%>%
  left_join(dxx_j, by = 'SEQN')%>%
  left_join(cdq_j, by = 'SEQN')%>%
  left_join(diet_j, by = 'SEQN')%>%
  left_join(urine_j, by = 'SEQN')
  


#sp stands for secondary prevention
VO2MAX2017 <- comb_j %>% 
  mutate(seqn = SEQN,
         time = 10,  
         year = '2017',
         age = RIDAGEYR,
         gender = case_when(RIAGENDR == 1 ~ 'Male',
                            RIAGENDR == 2 ~ 'Female',
                            TRUE ~ NA_character_),
         educ = case_when((DMDEDUC3 %in% c(0,1,2,3,4,5,6,7,8,9,10,11,12,55,66))|(DMDEDUC2 %in% c(1,2)) ~ 'Less than high school',
                         (DMDEDUC3 %in% c(13,14))|(DMDEDUC2 == 3) ~ 'High school diploma or GED',
                         (DMDEDUC3 == 15)|(DMDEDUC2 %in% c(4,5)) ~'Greater than high school',
                         TRUE ~ NA_character_),
         race_ethn = case_when( RIDRETH3 %in% c(1,2) ~ 'Hispanic',
                                RIDRETH3 == 3 ~ 'Non-Hispanic White',
                                RIDRETH3 == 4 ~ 'Non-Hispanic Black',
                                TRUE ~ 'Other'),
         race_ethn2 = case_when( RIDRETH3 %in% c(1,2) ~ 'Hispanic',
                                RIDRETH3 == 3 ~ 'Non-Hispanic White',
                                RIDRETH3 == 4 ~ 'Non-Hispanic Black',
                                RIDRETH3 == 6 ~ 'Non-Hispanic Asian',
                                TRUE ~ NA_character_),
         marital_status = case_when(DMDMARTL %in% c(1,6) ~ 'married/live with other',
                                     DMDMARTL %in% c(2,3,4,5) ~ 'other',
                                     TRUE ~ NA_character_),
         family_income = case_when(INDFMPIR >=2 ~ 'High/Middle income',
                                    INDFMPIR < 2 ~ 'Low income',
                                    TRUE ~ NA_character_),
         health_insurance = case_when(HIQ011 == 1 ~ 1L, 
                                       HIQ011 == 2 ~ 0L,
                                       TRUE ~ NA_integer_),
         employment_status = case_when(OCD150 %in% c(1,2) ~ 'Working',
                                       (OCD150 == 3) ~'Unemployed',
                                       (OCD150==4 & OCQ380 ==5)~'Unemployed',
                                       OCD150 == 4 & OCQ380 %in% c(1,2,3,4,6) ~ 'Not in labor force',
                                        TRUE ~ NA_character_),
         htn_history = case_when(BPQ020 == 1 ~ 1L,
                              BPQ020 == 2 ~ 0L,
                              TRUE ~ NA_integer_),
         htn_treatment = case_when(BPQ050A == 1 | anti_htn_per ~ 1L,
                              TRUE ~ 0L),
         high_chol_history = case_when(BPQ080 == 1 ~ 1L,
                                    BPQ080 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         high_chol_treatment = case_when(BPQ100D == 1 | anti_hyperlipid_per ~ 1L,
                              TRUE ~ 0L),
         diab_history= case_when(DIQ010 ==1 ~1L,
                              DIQ010 %in% c(2,3) ~ 0L,
                              TRUE ~ NA_integer_),
         diab_treatment = case_when(DIQ050 == 1|DIQ070==1|anti_diabetes_per~ 1L,
                              TRUE ~ 0L),
         cancer_history = case_when(MCQ220 == 1 ~ 1L,
                                    MCQ220 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         CD_history = case_when(MCQ160B==1|MCQ160C==1|MCQ160D==1|MCQ160E==1|MCQ160F==1|cvd_main_reason==1 ~ 1L,
                              TRUE ~ 0L),
         first_cd_age = case_when(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F) ~ NA_real_,
                                   !(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F))~ pmin(MCD180B,MCD180C,MCD180D,MCD180E,MCD180F,na.rm = T)),
         close_relatives_heartattack = case_when(MCQ300A == 1 ~ 1L,
                                    MCQ300A == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         close_relatives_diabetes = case_when(MCQ300C == 1 ~ 1L,
                                    MCQ300C == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         alcohol_intake = case_when(age < 20 ~ 'Never drinker',
                                    ALQ111 == 2 ~ 'Never drinker',
                                    ALQ111 == 1 & ALQ121 == 0 ~ 'Former drinker',
                                    ALQ111 == 1 & ADD == 0 ~ 'Former drinker',
                                    ADD>0 & ADD<0.5 ~ 'Light drinker',
                                    ADD>=0.5 & ADD<2.5 & RIAGENDR == 1 ~ 'Moderate drinker',
                                    ADD>=0.5 & ADD<1.5 & RIAGENDR == 2 ~ 'Moderate drinker',
                                    ADD>=2.5 & RIAGENDR == 1 ~ 'Heavier drinker',
                                    ADD>=1.5 & RIAGENDR == 2 ~ 'Heavier drinker',
                                    TRUE ~ NA_character_),
         smoking_status = case_when(SMQ_HIST == 'Never smoker'  ~ 'Never smoker',
                                    SMQ_HIST == 'Former smoker' ~ 'Former smoker',
                                    SMQ_HIST == 'Current smoker' ~ 'Current smoker',
                                     TRUE ~ NA_character_),
         physical_activity = case_when(PAQ650 == 2 & PAQ665 == 2 ~ 'Inactive',
                                       TWMT < 10 ~ 'Inactive',
                                       TWMT >= 10 & TWMT < 150 ~ 'Insufficient active',
                                       TWMT >= 150 ~ 'Active',
                                       TRUE ~ NA_character_),
         pregnant = case_when((RHD143 == 1)|(RIDEXPRG==1) ~ 1L,
                               TRUE ~ 0L),
         WT_DIFF_KG = WT_DIFF_PB*0.45359237,
         lwlstyr = case_when(WHQ070 == 1 ~ 1L,
                              WHQ070 == 2 ~ 0L,
                               TRUE ~ NA_integer_),
         exerc2lwlastyr = case_when(WHD080D == 13 ~ 1L,
                                    (is.na(WHD080D) & WHQ070 == 1)|(WHQ070 == 2)  ~ 0L,
                                    TRUE ~ NA_integer_),
         walk_bicycle_times_wk = case_when(PAQ635 == 2 ~ 0L,
                                           PAQ635 == 1 & PAQ640<20 ~ as.integer(PAQ640),
                                           TRUE ~ NA_integer_),
         overweight = case_when(race_ethn2 != 'Non-Hispanic Asian' & BMXBMI >=25 ~ 1L,
                                race_ethn2 != 'Non-Hispanic Asian' & BMXBMI < 25 ~ 0L,
                                race_ethn2 == 'Non-Hispanic Asian' & BMXBMI >=23 ~ 1L,
                                race_ethn2 == 'Non-Hispanic Asian' & BMXBMI < 23 ~ 0L,
                                TRUE ~ NA_integer_),
         overall_obesity = case_when(race_ethn2 != 'Non-Hispanic Asian' & BMXBMI >=30 ~ 1L,
                                     race_ethn2 != 'Non-Hispanic Asian' & BMXBMI < 30 ~ 0L,
                                     race_ethn2 == 'Non-Hispanic Asian' & BMXBMI >=27.5 ~ 1L,
                                     race_ethn2 == 'Non-Hispanic Asian' & BMXBMI < 27.5 ~ 0L,
                                     TRUE ~ NA_integer_),
         abdominal_obesity = case_when(race_ethn2 != 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST >=102 ~ 1L,
                                       race_ethn2 != 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST < 102 ~ 0L,
                                       race_ethn2 != 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST >= 88 ~ 1L,
                                       race_ethn2 != 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST <  88 ~ 0L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST >=  90 ~ 1L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST <  90 ~ 0L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST >=  80 ~ 1L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST <  80 ~ 0L,
                                       TRUE ~ NA_integer_),
         HBF1 = case_when(DXDTOPF >= 25 & RIAGENDR == 1 ~ 1L,
                         DXDTOPF < 25 & RIAGENDR == 1 ~ 0L,
                         DXDTOPF >= 35 & RIAGENDR == 2 ~ 1L,
                         DXDTOPF < 35 & RIAGENDR == 2 ~ 0L,
                         TRUE~ NA_integer_),
         HBF2 = case_when(DXDTOPF >= 28 & RIAGENDR == 1 ~ 1L,
                         DXDTOPF < 28 & RIAGENDR == 1 ~ 0L,
                         DXDTOPF >= 38 & RIAGENDR == 2 ~ 1L,
                         DXDTOPF < 38 & RIAGENDR == 2 ~ 0L,
                         TRUE~ NA_integer_),
         diab_now = case_when(diab_treatment==1L|LBXGH >=6.5|LBXGLU >=126 ~ 1L, ## oral glu tolerance was added from 2011
                              is.na(diab_treatment)&is.na(LBXGH )&is.na(LBXGLU) ~ NA_integer_,
                              TRUE ~ 0L),
         htn_now = case_when(htn_treatment==1L|SY_mean>=140|DI_mean>=90 ~ 1L,
                             is.na(htn_treatment)&is.na(SY_mean)&is.na(DI_mean) ~ NA_integer_,
                             TRUE ~0L),
         highchol_now = case_when(high_chol_treatment==1L |LBXTC>=240|LBDLDL>=160 ~ 1L,
                                  is.na(high_chol_treatment)&is.na(LBXTC)&is.na(LBDLDL) ~ NA_integer_,
                                  TRUE ~ 0L),
         short_breathe = case_when(CDQ010 ==1 ~ 1L,
                                   TRUE ~ 0L))%>%
  mutate(LDL = LBDLDL,
         HDL = LBDHDD,
         TOTAL_CHOL = LBXTC,
         FAST_GLU = LBXGLU,
         HBA1C = LBXGH,
         HSCRP = LBXHSCRP,
         FAST_INSULIN = LBXIN,
         FAST_TRI = LBXTR,
         ALT = LBXSATSI,
         AST = LBXSASSI,
         BUN = LBXSBU,
         GLU = LBXSGL,
         LDH = LBXSLDSI,
         POTAS = LBXSKSI,
         CHL = LBXSCLSI,
         SODI = LBXSNASI,
         CHOL = LBXSCH,
         TOTPRO = LBXSTP,
         CREATININE = LBXSCR,
         BILIRUBIN= LBXSTB,
         IRON = LBXSIR,
         CALCIUM = LBXSCA,
         BICARBONATE = LBXSC3SI)%>%
  select(seqn,time,year,age,gender,educ, race_ethn, marital_status,INDFMPIR, family_income, health_insurance, employment_status,
         SDMVPSU,SDMVSTRA,WTINT2YR,WTMEC2YR,WTSAF2YR,
         SY_mean, DI_mean, BMXBMI,BMXWAIST,BMXHT, bpx_metric,bpx_metric_ss,BPXCHR,BPXPLS,BMXWT,WT_DIFF_KG,BMXARMC,
         alcohol_intake,smoking_status,physical_activity,pregnant,lwlstyr, exerc2lwlastyr,walk_bicycle_times_wk,ADD, TWMT, short_breathe,
         overweight, overall_obesity, abdominal_obesity, HBF1,HBF2,
         htn_history, high_chol_history,diab_history, cancer_history, CD_history, first_cd_age,close_relatives_heartattack,close_relatives_diabetes,
         diab_now, htn_now,highchol_now,
         htn_treatment, high_chol_treatment, diab_treatment,aspirin_per, statin_per,acei_per,arb_per,betablocker_per,optimal_regimen_per, 
         LDL,HDL,TOTAL_CHOL,FAST_GLU,HBA1C,FAST_INSULIN,FAST_TRI,ALT,AST,BUN,GLU,LDH,POTAS,CHL,SODI,CHOL,TOTPRO, LBDSCRSI,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         DXDTOPF,DXXLABMD,DXDLAPF, DXXLLBMD, DXDLLPF,DXXRABMD,DXDRAPF , DXXRLBMD ,DXDRLPF , DXDTRBMD ,DXDTRPF,
         DXDLALE,DXDRALE,DXDLLLE,DXDRLLE,DXDTRLE,DXXTRFAT,DXXLAFAT,DXXRAFAT,DXXLLFAT,DXXRLFAT,DXDTOFAT,DXDTOLE,DXDTOBMD,
         IS_WEEKEND_DIET, COMPARE_USUAL, COMPARE_LESS, COMPARE_MORE,
                CALORIE_DIET,PROTEIN_DIET, CARB_DIET,FAT_DIET,SFAT_DIET,MFAT_DIET,PFAT__DIET,CHOL_DIET,
         FIBE_DIET,VB1_DIET,VB2_DIET,NIAC_DIET,VB6_DIET,FOLATE_DIET,VB12_DIET,VC_DIET,VE_DIET,CALC_DIET,PHOS_DIET,MG_DIET,
         IRON_DIET, ZINC_DIET,COPP_DIET,SODI_DIET,POTA_DIET, SELE_DIET,CAFF_DIET,THEO_DIET,ALCO_DIET, MOIS_DIET,TOTWATER,
         TS040,TS060,TS080,TS100,TS120,TS140,TS160,TS180,
         TM161,TM181,TM201,TM221,
         TP182,TP183,TP184,TP204,TP205,TP225,TP226,
         DIQ080,MCQ160G,adoles_limit1,adoles_limit2,adult_limit1,adult_limit2,select_prob)




VO2MAX2017_BASIC <- VO2MAX2017 %>%
  select(seqn,time,year,age,gender,educ, race_ethn, marital_status,INDFMPIR, family_income, health_insurance, employment_status,
         SDMVPSU,SDMVSTRA,WTINT2YR,WTMEC2YR,WTSAF2YR,
         SY_mean, DI_mean, BMXBMI,BMXWAIST,BMXHT, bpx_metric,bpx_metric_ss,BPXCHR,BPXPLS,BMXWT,WT_DIFF_KG,BMXARMC,
         alcohol_intake,smoking_status,physical_activity,pregnant,lwlstyr, exerc2lwlastyr,walk_bicycle_times_wk,ADD, TWMT, short_breathe,
         overweight, overall_obesity, abdominal_obesity, 
         htn_history, high_chol_history,diab_history, cancer_history, CD_history, first_cd_age,close_relatives_heartattack,close_relatives_diabetes,
         diab_now, htn_now,highchol_now,
         htn_treatment, high_chol_treatment, diab_treatment,aspirin_per, statin_per,acei_per,arb_per,betablocker_per,optimal_regimen_per, 
         LDL,HDL,TOTAL_CHOL,FAST_GLU,HBA1C,FAST_INSULIN,FAST_TRI,ALT,AST,BUN,GLU,LDH,POTAS,CHL,SODI,CHOL,TOTPRO,
         LBDSCRSI,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         DIQ080,MCQ160G,adoles_limit1,adoles_limit2,adult_limit1,adult_limit2,select_prob)

## write to csv file
# VO2MAX2017%>% write.csv(paste0(wd_path,'/VO2MAX2017.csv'))
# VO2MAX2017_BASIC%>% write.csv(paste0(wd_path,'/VO2MAX2017_BASIC.csv'))

```


## 2017-2020 (BASIC)
```{r}
## demographic infos
demo_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_DEMO.XPT"))%>%
  dplyr::select('SEQN','SDDSRVYR','RIDAGEYR','RIAGENDR','RIDRETH1','RIDRETH3','DMDEDUC2','DMDEDUC2','DMDMARTZ','INDFMPIR','WTINTPRP','WTMECPRP','SDMVPSU','SDMVSTRA','RIDEXPRG') 

## health insurance status
hiq_p <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_HIQ.XPT"))%>%
  dplyr::select('SEQN', 'HIQ011')

## occupation/employment status
ocq_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_OCQ.XPT"))%>% 
  dplyr::select('SEQN','OCD150','OCD383')

## diabetes history
diq_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_DIQ.XPT"))%>% 
  dplyr::select('SEQN', 'DIQ010', 'DIQ050','DIQ070','DIQ080')


## hypertension and cholesterol history 
bpq_p <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_BPQ.XPT"))%>%
  dplyr::select('SEQN', 'BPQ020','BPQ050A','BPQ080','BPQ100D')


## bp measurement
bpx_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_BPXO.XPT"))%>% 
  dplyr::select('SEQN','BPXOSY1','BPXOSY2','BPXOSY3','BPXODI1','BPXODI2','BPXODI3','BPXOPLS1','BPXOPLS2','BPXOPLS3')%>%
  mutate(SY_mean =rowMeans(subset(.,select = c('BPXOSY1','BPXOSY2','BPXOSY3')), na.rm = TRUE),
         DI_mean =rowMeans(subset(.,select = c('BPXODI1','BPXODI2','BPXODI3')), na.rm = TRUE),
         BPXPLS = rowMeans(subset(.,select = c('BPXOPLS1','BPXOPLS2','BPXOPLS3')), na.rm = TRUE))%>%
  # metric for htn 1: not control
  mutate(bpx_metric = case_when(SY_mean >= 140 | DI_mean >=90 ~ 1,
                                (SY_mean < 140 & DI_mean < 90)~0,
                                (SY_mean < 140 & is.na(DI_mean))~0,
                                (DI_mean < 90 & is.na(SY_mean))~0,
                                TRUE ~ NA_real_))%>%
  # ss stands for sensitivity
  mutate(bpx_metric_ss = case_when(SY_mean >= 130 | DI_mean >=80 ~ 1,
                                (SY_mean < 130 & DI_mean < 80)~0,
                                (SY_mean < 130 & is.na(DI_mean))~0,
                                (DI_mean < 80 & is.na(SY_mean))~0,
                                TRUE ~ NA_real_))%>%
  dplyr::select(SEQN,bpx_metric, bpx_metric_ss, SY_mean, DI_mean,BPXPLS)




## comorbidities
mcq_p <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_MCQ.XPT"))%>% 
  dplyr::select('SEQN', 
                'MCQ160B','MCD180B',
                'MCQ160C','MCD180C', ## coronary heart disease and the age first diagnosed
                'MCQ160D','MCD180D',
                'MCQ160E','MCD180E', ## heart attack and the age first diagnosed
                'MCQ160F','MCD180F', ## stroke and the age first diagnosed
                'MCQ220',# MCQ220 cancer
                'MCQ300C','MCQ300A') 


## alcohol intake
alq_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_ALQ.XPT"))%>% 
  dplyr::select('SEQN','ALQ121','ALQ130','ALQ111')%>%
  ## ADD is the estimate of average daily drinks
  mutate(ADD = case_when(ALQ111 == 2 ~ 0,
                         ALQ121 %in% c(1,2) ~ ALQ130,
                         ALQ121 == 3 ~ ALQ130*183/365,
                         ALQ121 == 4 ~ ALQ130*2*52/365,
                         ALQ121 == 5 ~ ALQ130*52/365,
                         ALQ121 == 6 ~ ALQ130*30/365,
                         ALQ121 == 7 ~ ALQ130*12/365,
                         ALQ121 == 8 ~ ALQ130*9/365,
                         ALQ121 == 9 ~ ALQ130*5/365,
                         ALQ121 == 10 ~ ALQ130*2/365,
                         TRUE ~ NA_real_))


  
  
## smoking status
## two data file regarding smoking in 2017-2018, combine to construct required variable
smq_p1 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_SMQ.XPT"))%>% 
  dplyr::select('SEQN','SMQ020', 'SMQ040','SMQ621')


smq_p2 <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_SMQRTU.XPT"))%>% 
  dplyr::select('SEQN','SMQ681')

smq_p <- smq_p1 %>% full_join(smq_p2, by= 'SEQN')


smq_p$SMQ_HIST <-apply(smq_p,1,function(x){
  if(any(x[2]==2,x[4]%in% c(1,2,3,4,5,6,7),na.rm = T)){return ('Never smoker')}
  else if (!any(x[2]==2,x[4]%in% c(1,2,3,4,5,6,7),na.rm = T) & any(x[3]%in% c(1,2),x[5]==1,na.rm = T)){return ('Current smoker')}
  else if (any(x[2] ==1,x[4]==8,na.rm = T) & (!x[3] %in% c(1,2) & x[5] %in% c(2))){return ('Former smoker')}
  else if (any(x[2] ==1,x[4]==8,na.rm = T) & (x[3] %in% c(3) & !x[5] %in% c(1))){return ('Former smoker')}
  else {return ('unknown')}
})





## physical activity 
paq_p <-read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_PAQ.XPT"))%>%
  dplyr::select('SEQN','PAQ650','PAQ665','PAQ655','PAD660','PAQ670','PAD675','PAQ635','PAQ640')%>%
  ## convert special code to NA
  mutate(PAQ670 = ifelse(PAQ670 %in% c(77,99),NA,PAQ670),
         PAD675 = ifelse(PAD675 %in% c(7777,9999),NA,PAD675),
         PAQ655 = ifelse(PAQ655 %in% c(77,99),NA,PAQ655),
         PAD660 = ifelse(PAD660 %in% c(7777,9999),NA,PAD660))%>%
  mutate(moder = PAQ670*PAD675) %>%
  # vigorous-intensity = 2 * moderate-intensity
  mutate(vigor_eq = 2*PAQ655*PAD660)%>%
  ## TWMT stands for total weekly moderate-intensity-exercise time 
  ## TWMT >150 : active, TWMT < 10 :INACTIVE, TMWT in (10,150) : Insufficient active
  mutate(TWMT =rowSums(subset(.,select = c('moder','vigor_eq')), na.rm = T))%>%
  mutate(TWMT = replace(TWMT, is.na(moder)&is.na(vigor_eq), NA))%>%
  mutate(TWMT = ifelse(PAQ650 == 2 & PAQ665 == 2,0,TWMT))


## Physical function
# pfq_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_PFQ.XPT"))%>%
#   dplyr::select('SEQN',
#                 'PFQ020','PFQ030',
#                 'PFQ061B','PFQ061C','PFQ061H','PFQ061I',
#                 'PFQ063A','PFQ063B','PFQ063C','PFQ063D','PFQ063E')%>%
#   mutate(adoles_limit1 = ifelse(PFQ020==1,1,0),
#          adoles_limit2 = ifelse(PFQ030==1,1,0),
#          adult_limit1 = ifelse(PFQ061B%in% c(3,4) | PFQ061C %in% c(3,4) | PFQ061H %in% c(3,4)| PFQ061I %in% c(3,4),1,0),
#          adult_limit2 = ifelse(PFQ061B%in% c(2,3,4) | PFQ061C %in% c(2,3,4)| PFQ061H %in% c(2,3,4)| PFQ061I %in% c(2,3,4),1,0))%>%
#   mutate(select_prob = ifelse((PFQ063A %in% c(19,21,25))|
#                                 (PFQ063B %in% c(19,21,25))|
#                                 (PFQ063C %in% c(19,21,25))|
#                                 (PFQ063D %in% c(19,21,25))|
#                                 (PFQ063E %in% c(19,21,25)),1,0))
#   


## Weight history
whq_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_WHQ.XPT"))%>%
  dplyr::select('SEQN','WHD050','WHD020','WHQ070','WHD080D')%>%
  ## convert special code to NA
  replace_with_na(replace = list(WHD020 = c(7777,9999),
                                 WHD050 = c(7777,9999)))%>%
  mutate(WT_DIFF_PB = WHD050 - WHD020)

## obsesity metric
bmx_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_BMX.XPT")) %>%
  dplyr::select('SEQN', 'BMXWAIST','BMXBMI','BMXWT','BMXHT','BMXARMC')

## cardiovascular health
cdq_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_CDQ.XPT"))%>%
  dplyr::select('SEQN', 'CDQ010')

## total cholesterol 
tchol_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_TCHOL.XPT")) %>%
  dplyr::select('SEQN', 'LBXTC')


## Glycohemoglobin
ghb_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_GHB.XPT")) %>%
  dplyr::select('SEQN', 'LBXGH')

## hdl
hdl_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_HDL.XPT")) %>%
  dplyr::select('SEQN', 'LBDHDD')

## Ldl
ldl_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_TRIGLY.XPT")) %>%
  dplyr::select('SEQN', 'LBXTR','LBDLDL', 'WTSAFPRP')

## Fasting glucose
glu_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_GLU.XPT")) %>%
  dplyr::select('SEQN', 'LBXGLU','WTSAFPRP')

## INSULIN
ins_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_INS.XPT")) %>%
  dplyr::select('SEQN', 'LBXIN','WTSAFPRP')

## FASTING SUBSAMPLE
fast_p <- glu_p %>% 
  full_join(ins_p, by = c('SEQN','WTSAFPRP')) %>%
  full_join(ldl_p, by = c('SEQN','WTSAFPRP'))
  

## high sensitive CRP
hscrp_p <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_HSCRP.XPT")) %>%
  dplyr::select('SEQN', 'LBXHSCRP')


## BIO PROFILE
biopro_p <-  read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_BIOPRO.XPT")) %>%
  dplyr::select('SEQN', 'LBXSATSI', 'LBXSASSI', 'LBXSBU','LBXSGL','LBXSLDSI',
                'LBXSKSI','LBXSCLSI','LBXSNASI','LBXSCH','LBXSTP',
                'LBXSTR','LBDSCRSI','LBXSCR',
                'LBXSC3SI','LBXSCA','LBXSIR','LBXSTB' )

## prescription
rxq_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_RXQ_RX.XPT"))



## prescription info join with drugs
rxq_sp_p <- rxq_p %>% left_join(sp_drug, by='RXDDRGID') %>%
  dplyr::group_by(SEQN) %>%
  ## _per means per person
  summarise(acei_per = ifelse(sum(acei, na.rm=T)>0,1,0), 
            betablocker_per =ifelse( sum(betablocker, na.rm=T)>0,1,0), 
            arb_per = ifelse(sum(arb, na.rm=T)>0,1,0), 
            aspirin_per = ifelse(sum(aspirin, na.rm = T)>0,1,0),
            statin_per = ifelse(sum(statin, na.rm = T)>0,1,0),
            anti_platelet_per = ifelse(sum(anti_platelet, na.rm = T)>0,1,0),
            anti_htn_per = ifelse(sum(anti_htn, na.rm = T)>0,1,0),
            anti_hyperlipid_per = ifelse(sum(anti_hyperlipid, na.rm = T)>0,1,0),
            anti_diabetes_per = ifelse(sum(anti_diabetes, na.rm = T)>0,1,0),
            .groups = 'drop' )%>%
  mutate(optimal_regimen_per = rowSums(subset(., select=c(anti_htn_per, anti_hyperlipid_per, anti_platelet_per))))


## rxq reason
rxq_main_reason_p <-rxq_p %>% 
  mutate(main_reason1 = grepl('^I[2-][0-9]',RXDRSC1),
         main_reason2 = grepl('^I[2-][0-9]',RXDRSC2),
         main_reason3 = grepl('^I[2-][0-9]',RXDRSC3),
         main_reason = main_reason1|main_reason2|main_reason3) %>%
   dplyr::group_by(SEQN) %>%
   dplyr::summarise(cvd_main_reason = ifelse(sum(main_reason, na.rm=T)>0,1,0))
  

## pregnancy
rhq_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_RHQ.XPT"))%>%
  select(SEQN, RHD143)



## urine content
urine_p <- read_xpt(url("https://wwwn.cdc.gov/Nchs/Nhanes/2017-2018/P_ALB_CR.XPT"))%>%
  dplyr::mutate(albuminuria = (URXUMS/URXUCR)*100)


## combine
comb_p <- demo_p %>% left_join(hiq_p, by='SEQN')%>%  left_join(ocq_p, by='SEQN')%>% 
  left_join(diq_p, by='SEQN')%>%left_join(bpq_p, by='SEQN')%>%
  left_join(bpx_p, by='SEQN')%>%left_join(mcq_p, by='SEQN')%>% 
  left_join(alq_p, by='SEQN')%>% left_join(smq_p, by='SEQN')%>% left_join(paq_p, by='SEQN')%>% 
  left_join(bmx_p, by='SEQN')%>% left_join(tchol_p, by='SEQN')%>% left_join(ghb_p, by='SEQN')%>% 
  left_join(rxq_sp_p, by='SEQN')%>% left_join(rhq_p, by='SEQN')%>% left_join(hdl_p, by = 'SEQN')%>%
  left_join(fast_p, by = 'SEQN')%>% left_join(hscrp_p, by = 'SEQN') %>%
  left_join(biopro_p, by = 'SEQN') %>%
  left_join(rxq_main_reason_p, by = 'SEQN')%>%
  left_join(whq_p, by = 'SEQN')%>%
  left_join(cdq_p, by = 'SEQN')%>%
  left_join(urine_p, by = 'SEQN')
  


#sp stands for secondary prevention
VO2MAXPRP_BASIC <- comb_p %>% 
  mutate(seqn = SEQN,
         time = 11,  
         year = 'PRP',
         age = RIDAGEYR,
         gender = case_when(RIAGENDR == 1 ~ 'Male',
                            RIAGENDR == 2 ~ 'Female',
                            TRUE ~ NA_character_),
         educ = case_when(age < 18 ~ 'Less than high school',
                          DMDEDUC2 %in% c(1,2) ~ 'Less than high school',
                          DMDEDUC2 == 3 ~ 'High school diploma or GED',
                          DMDEDUC2 %in% c(4,5) ~'Greater than high school',
                         TRUE ~ NA_character_),
         race_ethn = case_when( RIDRETH3 %in% c(1,2) ~ 'Hispanic',
                                RIDRETH3 == 3 ~ 'Non-Hispanic White',
                                RIDRETH3 == 4 ~ 'Non-Hispanic Black',
                                TRUE ~ 'Other'),
         race_ethn2 = case_when( RIDRETH3 %in% c(1,2) ~ 'Hispanic',
                                RIDRETH3 == 3 ~ 'Non-Hispanic White',
                                RIDRETH3 == 4 ~ 'Non-Hispanic Black',
                                RIDRETH3 == 6 ~ 'Non-Hispanic Asian',
                                TRUE ~ NA_character_),
         marital_status = case_when(DMDMARTZ %in% c(1,6) ~ 'married/live with other',
                                     DMDMARTZ %in% c(2,3,4,5) ~ 'other',
                                     TRUE ~ NA_character_),
         family_income = case_when(INDFMPIR >=2 ~ 'High/Middle income',
                                    INDFMPIR < 2 ~ 'Low income',
                                    TRUE ~ NA_character_),
         health_insurance = case_when(HIQ011 == 1 ~ 1L, 
                                       HIQ011 == 2 ~ 0L,
                                       TRUE ~ NA_integer_),
         employment_status = case_when(OCD150 %in% c(1,2) ~ 'Working',
                                       (OCD150 == 3) ~'Unemployed',
                                       (OCD150==4 & OCD383 ==7)~'Unemployed',
                                       OCD150 == 4 & OCD383 %in% c(1,2,3,4) ~ 'Not in labor force',
                                        TRUE ~ NA_character_),
         htn_history = case_when(BPQ020 == 1 ~ 1L,
                              BPQ020 == 2 ~ 0L,
                              TRUE ~ NA_integer_),
         htn_treatment = case_when(BPQ050A == 1 | anti_htn_per ~ 1L,
                              TRUE ~ 0L),
         high_chol_history = case_when(BPQ080 == 1 ~ 1L,
                                    BPQ080 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         high_chol_treatment = case_when(BPQ100D == 1 | anti_hyperlipid_per ~ 1L,
                              TRUE ~ 0L),
         diab_history= case_when(DIQ010 ==1 ~1L,
                              DIQ010 %in% c(2,3) ~ 0L,
                              TRUE ~ NA_integer_),
         diab_treatment = case_when(DIQ050 == 1|DIQ070==1|anti_diabetes_per~ 1L,
                              TRUE ~ 0L),
         cancer_history = case_when(MCQ220 == 1 ~ 1L,
                                    MCQ220 == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         CD_history = case_when(MCQ160B==1|MCQ160C==1|MCQ160D==1|MCQ160E==1|MCQ160F==1|cvd_main_reason==1 ~ 1L,
                              TRUE ~ 0L),
         first_cd_age = case_when(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F) ~ NA_real_,
                                   !(is.na(MCQ160B)&is.na(MCQ160C)&is.na(MCQ160D)&is.na(MCQ160E)&is.na(MCQ160F))~ pmin(MCD180B,MCD180C,MCD180D,MCD180E,MCD180F,na.rm = T)),
         close_relatives_heartattack = case_when(MCQ300A == 1 ~ 1L,
                                    MCQ300A == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         close_relatives_diabetes = case_when(MCQ300C == 1 ~ 1L,
                                    MCQ300C == 2 ~ 0L,
                                    TRUE ~ NA_integer_),
         alcohol_intake = case_when(age < 20 ~ 'Never drinker',
                                    ALQ111 == 2 ~ 'Never drinker',
                                    ALQ111 == 1 & ALQ121 == 0 ~ 'Former drinker',
                                    ALQ111 == 1 & ADD == 0 ~ 'Former drinker',
                                    ADD>0 & ADD<0.5 ~ 'Light drinker',
                                    ADD>=0.5 & ADD<2.5 & RIAGENDR == 1 ~ 'Moderate drinker',
                                    ADD>=0.5 & ADD<1.5 & RIAGENDR == 2 ~ 'Moderate drinker',
                                    ADD>=2.5 & RIAGENDR == 1 ~ 'Heavier drinker',
                                    ADD>=1.5 & RIAGENDR == 2 ~ 'Heavier drinker',
                                    TRUE ~ NA_character_),
         smoking_status = case_when(SMQ_HIST == 'Never smoker'  ~ 'Never smoker',
                                    SMQ_HIST == 'Former smoker' ~ 'Former smoker',
                                    SMQ_HIST == 'Current smoker' ~ 'Current smoker',
                                     TRUE ~ NA_character_),
         physical_activity = case_when(PAQ650 == 2 & PAQ665 == 2 ~ 'Inactive',
                                       TWMT < 10 ~ 'Inactive',
                                       TWMT >= 10 & TWMT < 150 ~ 'Insufficient active',
                                       TWMT >= 150 ~ 'Active',
                                       TRUE ~ NA_character_),
         pregnant = case_when((RHD143 == 1 )|(RIDEXPRG==1) ~ 1L,
                               TRUE ~ 0L),
         WT_DIFF_KG = WT_DIFF_PB*0.45359237,
         lwlstyr = case_when(WHQ070 == 1 ~ 1L,
                              WHQ070 == 2 ~ 0L,
                               TRUE ~ NA_integer_),
         exerc2lwlastyr = case_when(WHD080D == 13 ~ 1L,
                                    (is.na(WHD080D) & WHQ070 == 1)|(WHQ070 == 2)  ~ 0L,
                                    TRUE ~ NA_integer_),
         walk_bicycle_times_wk = case_when(PAQ635 == 2 ~ 0L,
                                           PAQ635 == 1 & PAQ640<20 ~ as.integer(PAQ640),
                                           TRUE ~ NA_integer_),
         overweight = case_when(race_ethn2 != 'Non-Hispanic Asian' & BMXBMI >=25 ~ 1L,
                                race_ethn2 != 'Non-Hispanic Asian' & BMXBMI < 25 ~ 0L,
                                race_ethn2 == 'Non-Hispanic Asian' & BMXBMI >=23 ~ 1L,
                                race_ethn2 == 'Non-Hispanic Asian' & BMXBMI < 23 ~ 0L,
                                TRUE ~ NA_integer_),
         overall_obesity = case_when(race_ethn2 != 'Non-Hispanic Asian' & BMXBMI >=30 ~ 1L,
                                     race_ethn2 != 'Non-Hispanic Asian' & BMXBMI < 30 ~ 0L,
                                     race_ethn2 == 'Non-Hispanic Asian' & BMXBMI >=27.5 ~ 1L,
                                     race_ethn2 == 'Non-Hispanic Asian' & BMXBMI < 27.5 ~ 0L,
                                     TRUE ~ NA_integer_),
         abdominal_obesity = case_when(race_ethn2 != 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST >=102 ~ 1L,
                                       race_ethn2 != 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST < 102 ~ 0L,
                                       race_ethn2 != 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST >= 88 ~ 1L,
                                       race_ethn2 != 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST <  88 ~ 0L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST >=  90 ~ 1L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Male' & BMXWAIST <  90 ~ 0L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST >=  80 ~ 1L,
                                       race_ethn2 == 'Non-Hispanic Asian' & gender == 'Female' & BMXWAIST <  80 ~ 0L,
                                       TRUE ~ NA_integer_),
         diab_now = case_when(diab_treatment==1L|LBXGH >=6.5|LBXGLU >=126 ~ 1L, ## oral glu tolerance was added from 2011
                              is.na(diab_treatment)&is.na(LBXGH )&is.na(LBXGLU) ~ NA_integer_,
                              TRUE ~ 0L),
         htn_now = case_when(htn_treatment==1L|SY_mean>=140|DI_mean>=90 ~ 1L,
                             is.na(htn_treatment)&is.na(SY_mean)&is.na(DI_mean) ~ NA_integer_,
                             TRUE ~0L),
         highchol_now = case_when(high_chol_treatment==1L |LBXTC>=240|LBDLDL>=160 ~ 1L,
                                  is.na(high_chol_treatment)&is.na(LBXTC)&is.na(LBDLDL) ~ NA_integer_,
                                  TRUE ~ 0L),
         short_breathe = case_when(CDQ010 ==1 ~ 1L,
                                   TRUE ~ 0L))%>%
  mutate(LDL = LBDLDL,
         HDL = LBDHDD,
         TOTAL_CHOL = LBXTC,
         FAST_GLU = LBXGLU,
         HBA1C = LBXGH,
         HSCRP = LBXHSCRP,
         FAST_INSULIN = LBXIN,
         FAST_TRI = LBXTR,
         ALT = LBXSATSI,
         AST = LBXSASSI,
         BUN = LBXSBU,
         GLU = LBXSGL,
         LDH = LBXSLDSI,
         POTAS = LBXSKSI,
         CHL = LBXSCLSI,
         SODI = LBXSNASI,
         CHOL = LBXSCH,
         TOTPRO = LBXSTP,
         CREATININE = LBXSCR,
         BILIRUBIN= LBXSTB,
         IRON = LBXSIR,
         CALCIUM = LBXSCA,
         BICARBONATE = LBXSC3SI,
         WTINT2YR = WTINTPRP/1.6,
         WTMEC2YR = WTMECPRP/1.6,
         WTSAF2YR = WTSAFPRP/1.6,
         BPXCHR = BPXPLS)%>%
  select(seqn,time,year,age,gender,educ, race_ethn, marital_status,INDFMPIR, family_income, health_insurance, employment_status,
         SDMVPSU,SDMVSTRA,WTINT2YR,WTMEC2YR,WTSAF2YR,
         SY_mean, DI_mean, BMXBMI,BMXWAIST,BMXHT, bpx_metric,bpx_metric_ss,BPXCHR,BPXPLS,BMXWT,WT_DIFF_KG,BMXARMC,
         alcohol_intake,smoking_status,physical_activity,pregnant,lwlstyr, exerc2lwlastyr,walk_bicycle_times_wk,ADD, TWMT, short_breathe,
         overweight, overall_obesity, abdominal_obesity, 
         htn_history, high_chol_history,diab_history, cancer_history, CD_history, first_cd_age,close_relatives_heartattack,close_relatives_diabetes,
         diab_now, htn_now,highchol_now,
         htn_treatment, high_chol_treatment, diab_treatment,aspirin_per, statin_per,acei_per,arb_per,betablocker_per,optimal_regimen_per, 
         LDL,HDL,TOTAL_CHOL,FAST_GLU,HBA1C,FAST_INSULIN,FAST_TRI,ALT,AST,BUN,GLU,LDH,POTAS,CHL,SODI,CHOL,TOTPRO,
         LBDSCRSI,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria)




## write to csv file
## only basic version
# VO2MAXPRP_BASIC %>% write.csv(paste0(wd_path,'/VO2MAXPRP_BASIC.csv'))

```



```{r}

## FOR FULL/EXTENDED MODEL
VO2MAX_10yrs <- rbind(VO2MAX2005, VO2MAX2011,VO2MAX2013,VO2MAX2015,VO2MAX2017)
VO2MAX_10yrs %>% write.csv(paste0(wd_path,'VO2MAX_10yrs.csv'), row.names = F)


## FOR PARSIMONIOUS MODEL
## 14 YEARS
VO2MAX_BASIC_14yrs <- rbind(VO2MAX2005_BASIC, VO2MAX2007_BASIC, VO2MAX2009_BASIC,
                            VO2MAX2011_BASIC, VO2MAX2013_BASIC, VO2MAX2015_BASIC, VO2MAX2017_BASIC)
VO2MAX_BASIC_14yrs %>% write.csv(paste0(wd_path,'VO2MAX_BASIC_14yrs.csv'), row.names = F)
table(VO2MAX_BASIC_14yrs$year)
# 16 YEARS
VO2MAX_BASIC_16yrs <- rbind(rbind(VO2MAX2005_BASIC, VO2MAX2007_BASIC, VO2MAX2009_BASIC,
                            VO2MAX2011_BASIC,VO2MAX2013_BASIC, VO2MAX2015_BASIC) %>%
                              select(-c('DIQ080','MCQ160G','adoles_limit1','adoles_limit2','adult_limit1','adult_limit2','select_prob')),
                            VO2MAXPRP_BASIC)
VO2MAX_BASIC_16yrs %>% write.csv(paste0(wd_path,'VO2MAX_BASIC_16yrs.csv'), row.names = F)
table(VO2MAX_BASIC_16yrs$year)

```


## 2005-2018
```{r}

data14 <- read.csv(paste0(wd_path, 'VO2MAX_BASIC_14yrs.csv')) 


data14_eligible <- data14 %>% 
  mutate(race_ethn = ifelse(is.na(race_ethn),'Other',race_ethn),
         PAI_binary = ifelse(physical_activity == 'Active',1,0),
         curr_smoker = ifelse(smoking_status == 'Current smoker',1,0),
         agec_l20 = ifelse(age<20,1,0),
         agec_20_29 = ifelse(age<30&age>=20,1,0),
         agec_30_39 = ifelse(age<40&age>=30,1,0),
         agec_40_49 = ifelse(age<50&age>=40,1,0),
         limit1 = case_when((adult_limit1 == 1 | adoles_limit1 ==1) ~ 1L, 
                            TRUE ~ 0L),
         limit2 = case_when((adult_limit2 == 1 | adoles_limit2 ==1) ~ 1L,
                            TRUE ~ 0L),
         select_reason = case_when(select_prob==1  ~ 1L,
                            TRUE ~ 0L))%>%
  filter(age >= 16 & age< 50 ) %>%
  filter(pregnant==0 | is.na(pregnant))%>%
  filter(CD_history==0 | is.na(CD_history))%>%
  filter(MCQ160G %in% c(2,7,9)| is.na(MCQ160G))%>%
  filter(DIQ080 %in% c(2,7,9)| is.na(DIQ080))%>%
  filter(!(limit1&select_reason ==1 ))  ## limit 1/2 : number represent severity of limitation, 1 more severe than 2




## with missingenss
data14_vo2max_all <- data14_eligible  %>% 
  mutate_if(., is.character, factor)%>%
  ## exclude some extreme outliers
  select(seqn,age, gender,race_ethn, educ, marital_status,INDFMPIR, family_income, health_insurance, employment_status, smoking_status,marital_status,
         agec_l20,agec_20_29,agec_30_39,agec_40_49,
         htn_history, diab_history,high_chol_history, highchol_now, htn_now, diab_now, WTMEC2YR,WTINT2YR,SDMVPSU,SDMVSTRA,year,
         ALT,AST,BUN,GLU,LDH,CHOL, TOTPRO, POTAS, SODI, CHL, HBA1C,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         SY_mean,DI_mean, BMXBMI,BMXWAIST,BPXPLS,BMXWT,BMXHT,alcohol_intake,
         TWMT,physical_activity,WT_DIFF_KG ,lwlstyr,exerc2lwlastyr,walk_bicycle_times_wk)



write.csv(data14_vo2max_all,paste0(wd_path,'data14_vo2max_all.csv'), row.names = F)


```


## 2005-2020
```{r}

data16 <- read.csv(paste0(wd_path, 'VO2MAX_BASIC_16yrs.csv')) 


data16_eligible <- data16 %>% 
  mutate(race_ethn = ifelse(is.na(race_ethn),'Other',race_ethn),
         PAI_binary = ifelse(physical_activity == 'Active',1,0),
         curr_smoker = ifelse(smoking_status == 'Current smoker',1,0),
         agec_l20 = ifelse(age<20,1,0),
         agec_20_29 = ifelse(age<30&age>=20,1,0),
         agec_30_39 = ifelse(age<40&age>=30,1,0),
         agec_40_49 = ifelse(age<50&age>=40,1,0))%>%
  filter(age >= 16 & age< 50 ) %>%
  filter(pregnant==0 | is.na(pregnant))
  #filter(CD_history==0 | is.na(CD_history))
  # filter(MCQ160G %in% c(2,7,9)| is.na(MCQ160G))%>%
  #filter(DIQ080 %in% c(2,7,9)| is.na(DIQ080))%>%
  #filter(!(limit1&select_reason ==1 ))  ## limit 1/2 : number represent severity of limitation, 1 more severe than 2




## with missingenss
data16_vo2max_all <- data16_eligible  %>% 
  mutate_if(., is.character, factor)%>%
  ## exclude some extreme outliers
  select(seqn,age, gender,race_ethn, educ, marital_status,INDFMPIR, family_income, health_insurance, employment_status, smoking_status,marital_status,
         agec_l20,agec_20_29,agec_30_39,agec_40_49,
         htn_history, diab_history,high_chol_history, highchol_now, htn_now, diab_now, WTMEC2YR,WTINT2YR,SDMVPSU,SDMVSTRA,year,
         ALT,AST,BUN,GLU,LDH,CHOL, TOTPRO, POTAS, SODI, CHL, HBA1C,CREATININE,BILIRUBIN,IRON,CALCIUM,BICARBONATE,albuminuria,
         SY_mean,DI_mean, BMXBMI,BMXWAIST,BPXPLS,BMXWT,BMXHT,alcohol_intake,
         TWMT,physical_activity,WT_DIFF_KG ,lwlstyr,exerc2lwlastyr,walk_bicycle_times_wk)



write.csv(data16_vo2max_all,paste0(wd_path,'data16_vo2max_all.csv'), row.names = F)


```
